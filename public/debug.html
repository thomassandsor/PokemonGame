<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Game - Emergency Mobile Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 10px;
            background: #000;
            color: #00ff00;
            font-size: 14px;
            line-height: 1.4;
        }
        .section {
            border: 2px solid #00ff00;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .error { color: #ff0000; }
        .success { color: #00ff00; }
        .warning { color: #ffff00; }
        .info { color: #00ffff; }
        button {
            background: #333;
            color: #00ff00;
            border: 2px solid #00ff00;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            font-size: 14px;
        }
        .log {
            background: #111;
            border: 1px solid #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="section">
        <h1>üö® EMERGENCY MOBILE DEBUG</h1>
        <p class="warning">This page will capture EVERYTHING happening on mobile</p>
        <p class="info">Version: 2025-07-10 20:28 - Bypasses React authentication</p>
    </div>

    <div class="section">
        <h3>üì± Device Info</h3>
        <div id="deviceInfo">Loading...</div>
    </div>

    <div class="section">
        <h3>üîç URL Analysis</h3>
        <div id="urlInfo">Loading...</div>
    </div>

    <div class="section">
        <h3>üç™ Storage Check</h3>
        <div id="storageInfo">Loading...</div>
    </div>

    <div class="section">
        <h3>‚ö° Actions</h3>
        <button onclick="clearEverything()">üßπ CLEAR ALL DATA</button>
        <button onclick="testAppInsights()">üìä TEST TELEMETRY</button>
        <button onclick="goToApp()">üéÆ GO TO APP</button>
        <button onclick="showMSALInfo()">üîê MSAL INFO</button>
    </div>

    <div class="section">
        <h3>üìù Live Log</h3>
        <div id="log" class="log">Starting diagnostic...</div>
    </div>

    <!-- Application Insights - Force load -->
    <script type="text/javascript">
        !function(T,l,y){var S=T.location,k="script",D="instrumentationKey",C="ingestionendpoint",I="disableExceptionTracking",E="ai.device.",b="toLowerCase",w="crossOrigin",N="POST",e="appInsightsSDK",t=y.name||"appInsights";(y.name||T[e])&&(T[e]=t);var n=T[t]||function(d){var g=!1,f=!1,m={initialize:!0,queue:[],sv:"5",version:2,config:d};function v(e,t){var n={},a="Browser";return n[E+"id"]=a[b](),n[E+"type"]=a,n["ai.operation.name"]=S&&S.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(m.sv||m.version),{time:function(){var e=new Date;function t(e){var t=""+e;return 1===t.length&&(t="0"+t),t}return e.getUTCFullYear()+"-"+t(1+e.getUTCMonth())+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+(e.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}(),iKey:e,name:"Microsoft.ApplicationInsights."+t.replace(/-/g,"")+"."+n["ai.operation.name"].replace(/\s/g,""),sampleRate:100,tags:n,data:{baseData:{ver:2}}}}var h=d.url||y.src;if(h){function a(e){var t,n,a,i,r,o,s,c,u,p,l;g=!0,m.queue=[],f||(f=!0,t=h,s=function(){var e={},t=d.connectionString;if(t)for(var n=t.split(";"),a=0;a<n.length;a++){var i=n[a].split("=");2===i.length&&(e[i[0][b]()]=i[1])}if(!e[C]){var r=e.endpointsuffix,o=r?e.location:null;e[C]="https://"+(o?o+".":"")+"dc."+(r||"services.visualstudio.com")}return e}(),c=s[D]||d[D]||"",u=s[C],p=u?u+"/v2/track":d.endpointUrl,(l=[]).push((n="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",a=t,i=p,(o=(r=v(c,"Exception")).data).baseType="ExceptionData",o.baseData.exceptions=[{typeName:"SDKLoadFailed",message:n.replace(/\./g,"-"),hasFullStack:!1,stack:n+"\nSnippet failed to load ["+a+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(S&&S.pathname||"_unknown_")+"\nEndpoint: "+i,parsedStack:[]}],r)),l.push(function(e,t,n,a){var i=v(c,"Message"),r=i.data;r.baseType="MessageData";var o=r.baseData;return o.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+t+")").replace(/\"/g,"")+'"',o.properties={endpoint:a},i}(0,t,0,p)),function(e,t){if(JSON){var n=T.fetch;if(n&&!y.useXhr)n(t,{method:N,body:JSON.stringify(e),mode:"cors"});else if(XMLHttpRequest){var a=new XMLHttpRequest;a.open(N,t),a.setRequestHeader("Content-type","application/json"),a.send(JSON.stringify(e))}}}(l,p))}function i(e,t){f||setTimeout(function(){!t&&m.core||a()},500)}var e=function(){var n=l.createElement(k);n.src=h;var e=y[w];return!e&&""!==e||"undefined"==n[w]||(n[w]=e),n.onload=i,n.onerror=a,n.onreadystatechange=function(e,t){"loaded"!==n.readyState&&"complete"!==n.readyState||i(0,t)},n}();y.ld<0?l.getElementsByTagName("head")[0].appendChild(e):setTimeout(function(){l.getElementsByTagName(k)[0].parentNode.insertBefore(e,l.getElementsByTagName(k)[0])},y.ld||0)}try{m.cookie=l.cookie}catch(p){}function t(e){for(;e.length;)!function(t){m[t]=function(){var e=arguments;g||m.queue.push(function(){m[t].apply(m,e)})}}(e.pop())}var n="track",r="TrackPage",o="TrackEvent";t([n+"Event",n+"PageView",n+"Exception",n+"Trace",n+"DependencyData",n+"Metric",n+"PageViewPerformance","start"+r,"stop"+r,"start"+o,"stop"+o,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),m.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4};var s=(d.extensionConfig||{}).ApplicationInsightsAnalytics||{};if(!0!==d[I]&&!0!==s[I]){var c="onerror";t(["_"+c]);var u=T[c];T[c]=function(e,t,n,a,i){var r=u&&u(e,t,n,a,i);return!0!==r&&m["_"+c]({message:e,url:t,lineNumber:n,columnNumber:a,error:i}),r},d.autoExceptionInstrumented=!0}return m}(y.cfg);function a(){y.onInit&&y.onInit(n)}(T[t]=n).queue&&0===n.queue.length?(n.queue.push(a),n.trackPageView({})):a()}(window,document,{
            src: "https://js.monitor.azure.com/scripts/b/ai.2.min.js",
            cfg: {
                connectionString: "InstrumentationKey=a5e49ae4-0936-46c2-a6b6-b237830466dd;IngestionEndpoint=https://westeurope-5.in.applicationinsights.azure.com/;LiveEndpoint=https://westeurope.livediagnostics.monitor.azure.com/;ApplicationId=29d06d0b-7c8b-4cae-9e84-dc9cc00bec96",
                enableAutoRouteTracking: true,
                enableDebug: true,
                samplingPercentage: 100,
                disableCookiesUsage: false,
                enableSessionStorageBuffer: true
            }
        });

        // Override console to capture everything
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function(...args) {
            originalLog.apply(console, args);
            log('LOG: ' + args.join(' '), 'info');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            log('ERROR: ' + args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            log('WARN: ' + args.join(' '), 'warning');
        };

        // Capture unhandled errors
        window.addEventListener('error', function(e) {
            log(`UNHANDLED ERROR: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
            sendTelemetry('Mobile_Unhandled_Error', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                stack: e.error ? e.error.stack : 'No stack trace'
            });
        });

        // Capture unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
            log(`UNHANDLED PROMISE REJECTION: ${e.reason}`, 'error');
            sendTelemetry('Mobile_Unhandled_Promise_Rejection', {
                reason: e.reason ? e.reason.toString() : 'Unknown reason'
            });
        });
    </script>

    <script>
        const logDiv = document.getElementById('log');
        const deviceInfoDiv = document.getElementById('deviceInfo');
        const urlInfoDiv = document.getElementById('urlInfo');
        const storageInfoDiv = document.getElementById('storageInfo');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            
            // Also send to Application Insights
            sendTelemetry('Mobile_Debug_Log', {
                message: message,
                type: type,
                timestamp: new Date().toISOString()
            });
        }

        function sendTelemetry(eventName, properties) {
            try {
                if (window.appInsights) {
                    appInsights.trackEvent({
                        name: eventName,
                        properties: {
                            ...properties,
                            source: 'Emergency Mobile Debug Page',
                            userAgent: navigator.userAgent,
                            url: window.location.href,
                            timestamp: new Date().toISOString()
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to send telemetry:', error);
            }
        }

        function analyzeDevice() {
            const ua = navigator.userAgent;
            const info = {
                userAgent: ua,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                screen: `${screen.width}x${screen.height}`,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                isMobile: /iPhone|iPad|iPod|Android/i.test(ua),
                isIOS: /iPhone|iPad|iPod/i.test(ua),
                isAndroid: /Android/i.test(ua),
                isSafari: /Safari/i.test(ua) && !/Chrome/i.test(ua),
                isChrome: /Chrome/i.test(ua),
                isPrivateMode: 'unknown'
            };

            // Detect private mode (basic test)
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                info.isPrivateMode = false;
            } catch (e) {
                info.isPrivateMode = true;
            }

            return info;
        }

        function analyzeURL() {
            const url = new URL(window.location.href);
            const params = {};
            url.searchParams.forEach((value, key) => {
                params[key] = value;
            });

            return {
                href: window.location.href,
                origin: window.location.origin,
                pathname: window.location.pathname,
                search: window.location.search,
                hash: window.location.hash,
                parameters: params,
                hasAuthParams: url.searchParams.has('code') || url.searchParams.has('state') || url.searchParams.has('session_state'),
                referrer: document.referrer
            };
        }

        function analyzeStorage() {
            const info = {
                localStorage: {},
                sessionStorage: {},
                cookies: document.cookie
            };

            // Check localStorage
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    info.localStorage[key] = value ? value.substring(0, 100) + (value.length > 100 ? '...' : '') : value;
                }
            } catch (e) {
                info.localStorage.error = e.message;
            }

            // Check sessionStorage
            try {
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    const value = sessionStorage.getItem(key);
                    info.sessionStorage[key] = value ? value.substring(0, 100) + (value.length > 100 ? '...' : '') : value;
                }
            } catch (e) {
                info.sessionStorage.error = e.message;
            }

            return info;
        }

        function clearEverything() {
            try {
                localStorage.clear();
                sessionStorage.clear();
                
                // Clear cookies (best effort)
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });

                log('‚úÖ Cleared all localStorage, sessionStorage, and cookies', 'success');
                sendTelemetry('Mobile_Clear_All_Data', { action: 'success' });
            } catch (error) {
                log('‚ùå Failed to clear data: ' + error.message, 'error');
                sendTelemetry('Mobile_Clear_All_Data', { action: 'failed', error: error.message });
            }
        }

        function testAppInsights() {
            log('üìä Testing Application Insights...', 'info');
            
            const device = analyzeDevice();
            sendTelemetry('Mobile_Emergency_Debug_Test', {
                ...device,
                testType: 'Emergency Debug Page Test'
            });
            
            log('‚úÖ Application Insights test sent', 'success');
        }

        function goToApp() {
            log('üéÆ Redirecting to Pokemon Game...', 'info');
            sendTelemetry('Mobile_Redirect_To_App', { 
                fromPage: 'Emergency Debug',
                targetUrl: 'https://red-forest-0b2b6ae03.1.azurestaticapps.net'
            });
            
            setTimeout(() => {
                window.location.href = 'https://red-forest-0b2b6ae03.1.azurestaticapps.net?from-debug=true';
            }, 1000);
        }

        function showMSALInfo() {
            const msalKeys = [];
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.includes('msal') || key.includes('MSAL')) {
                        msalKeys.push(key);
                    }
                }
                
                if (msalKeys.length === 0) {
                    log('üîê No MSAL data found in localStorage', 'warning');
                } else {
                    log(`üîê Found ${msalKeys.length} MSAL keys: ${msalKeys.join(', ')}`, 'info');
                }
            } catch (error) {
                log('‚ùå Failed to check MSAL data: ' + error.message, 'error');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const device = analyzeDevice();
            const url = analyzeURL();
            const storage = analyzeStorage();

            // Display device info
            deviceInfoDiv.innerHTML = `
                <div class="${device.isMobile ? 'success' : 'warning'}">Mobile: ${device.isMobile ? 'YES' : 'NO'}</div>
                <div class="${device.isIOS ? 'info' : ''}">iOS: ${device.isIOS ? 'YES' : 'NO'}</div>
                <div class="${device.isSafari ? 'info' : ''}">Safari: ${device.isSafari ? 'YES' : 'NO'}</div>
                <div class="${device.isPrivateMode ? 'warning' : 'success'}">Private Mode: ${device.isPrivateMode}</div>
                <div class="info">Screen: ${device.screen}</div>
                <div class="info">Viewport: ${device.viewport}</div>
            `;

            // Display URL info
            urlInfoDiv.innerHTML = `
                <div class="info">URL: ${url.href}</div>
                <div class="${url.hasAuthParams ? 'warning' : 'info'}">Has Auth Params: ${url.hasAuthParams ? 'YES' : 'NO'}</div>
                <div class="info">Referrer: ${url.referrer || 'None'}</div>
                <div class="info">Parameters: ${Object.keys(url.parameters).length}</div>
            `;

            // Display storage info
            storageInfoDiv.innerHTML = `
                <div class="info">localStorage keys: ${Object.keys(storage.localStorage).length}</div>
                <div class="info">sessionStorage keys: ${Object.keys(storage.sessionStorage).length}</div>
                <div class="info">Cookies: ${storage.cookies ? 'Present' : 'None'}</div>
            `;

            log('üö® Emergency Mobile Debug Page loaded', 'success');
            log(`Device: ${device.isMobile ? 'Mobile' : 'Desktop'} | ${device.isIOS ? 'iOS' : device.isAndroid ? 'Android' : 'Other'}`, 'info');
            
            if (url.hasAuthParams) {
                log('‚ö†Ô∏è WARNING: Auth parameters detected in URL!', 'warning');
            }

            // Send comprehensive telemetry
            sendTelemetry('Mobile_Emergency_Debug_Page_Load', {
                device,
                url,
                storageKeyCount: {
                    localStorage: Object.keys(storage.localStorage).length,
                    sessionStorage: Object.keys(storage.sessionStorage).length
                }
            });
        });
    </script>
</body>
</html>
