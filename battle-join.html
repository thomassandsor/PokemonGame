<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Battle - Pokemon Game</title>
    <link rel="stylesheet" href="styles/pokemon-design-system.css">
    <style>
        /* Battle Join Specific Styles - Clean Design */
        
        /* Clean background */
        .battle-join-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 0;
        }

        /* Battle info card */
        .battle-info-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 16px;
            padding: 16px;
        }

        .battle-info-card h3 {
            margin: 0 0 16px 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }

        .battle-overview {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 24px;
            align-items: center;
        }

        .challenger-info h4 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
            font-weight: 600;
        }

        .challenger-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .opponent-pokemon-showcase-centered {
            display: flex;
            justify-content: center;
            padding: 12px 0;
        }

        .opponent-pokemon-card-large {
            background: white;
            border: 3px solid #e74c3c;
            border-radius: 16px;
            padding: 18px;
            text-align: center;
            min-width: 180px;
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.3);
            position: relative;
            transform: scale(1.1);
        }

        .opponent-pokemon-card-large::before {
            content: "OPPONENT";
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
        }

        .opponent-pokemon-card-large img {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }

        .opponent-pokemon-card-large .pokemon-placeholder {
            width: 80px;
            height: 80px;
            background: #f0f0f0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 30px;
            font-weight: bold;
            margin: 0 auto;
        }

        .opponent-pokemon-card-large h4 {
            margin: 10px 0 4px 0;
            font-size: 16px;
            color: #333;
            font-weight: 600;
        }

        .opponent-pokemon-card-large p {
            margin: 4px 0;
            font-size: 14px;
            color: #666;
        }

        .opponent-pokemon-showcase {
            display: flex;
            justify-content: center;
        }

        .battle-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-label {
            font-weight: 600;
            color: #666;
        }

        .detail-value {
            color: #333;
        }

        /* Pokemon selection area */
        .pokemon-selection-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 18px;
        }

        .pokemon-selection-card h3 {
            margin: 0 0 16px 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }

        /* Pokemon grid - use design system styles for cards */
        .pokemon-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin: 12px 0;
        }

        /* Standardized Pokemon card styles (matching battle-arena) */
        .pokemon-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-width: 110px;
        }

        .pokemon-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .pokemon-card.selected {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .pokemon-card.unavailable {
            border-color: #e0e0e0;
            background: #f8f9fa;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .pokemon-card.unavailable:hover {
            border-color: #e0e0e0;
            transform: none;
            box-shadow: none;
            background: #f8f9fa;
        }

        .pokemon-card img {
            width: 56px;
            height: 56px;
            object-fit: contain;
        }

        .pokemon-card h4 {
            margin: 6px 0 3px 0;
            font-size: 13px;
            color: #333;
            font-weight: 600;
        }

        .pokemon-card p {
            margin: 0;
            font-size: 11px;
            color: #666;
        }

        /* Standardized header styles (matching battle-arena) */
        .home-nav-btn {
            background: #ffffff;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 0;
        }

        .home-nav-btn:hover {
            background: #f8f9fa;
            border-color: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .home-nav-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .pokeball-icon {
            width: 28px;
            height: 28px;
            transition: transform 0.2s;
        }

        .home-nav-btn:hover .pokeball-icon {
            transform: rotate(10deg);
        }

        .pokemon-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-spacer {
            width: 48px;
        }

        .pokemon-title {
            margin: 0;
            flex: 1;
            text-align: center;
        }

        /* Standardized Pokemon button styles */
        .pokemon-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .pokemon-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .pokemon-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* HP Bar for battle cards */
        .pokemon-hp-bar {
            background: #e9ecef;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0 4px 0;
        }

        .pokemon-hp-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .hp-high { background: #28a745; }
        .hp-medium { background: #ffc107; }
        .hp-low { background: #dc3545; }

        .pokemon-hp-text {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin: 4px 0;
        }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 16px;
        }

        .back-btn {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: #e9ecef;
            border-color: #d0d0d0;
        }

        /* Loading and error states */
        .loading-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .battle-joining-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
        }

        .battle-joining-spinner {
            width: 64px;
            height: 64px;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .battle-joining-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .battle-joining-status {
            font-size: 14px;
            color: #ccc;
        }

        .error-state {
            background: #ffebee;
            color: #c62828;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .battle-overview {
                grid-template-columns: 1fr;
                gap: 16px;
                text-align: center;
            }
            
            .opponent-pokemon-card-large {
                transform: scale(1.0);
                min-width: 150px;
                padding: 14px;
            }
            
            .opponent-pokemon-card-large img,
            .opponent-pokemon-card-large .pokemon-placeholder {
                width: 70px;
                height: 70px;
            }
            
            .pokemon-grid {
                gap: 8px;
            }
            
            .pokemon-card {
                min-width: 95px;
                padding: 10px;
            }
            
            .pokemon-card img {
                width: 50px;
                height: 50px;
            }
        }
    </style>
</head>
<body class="pokemon-game-body">
    <div class="battle-join-container">
        <!-- Clean Header -->
        <header class="pokemon-header">
            <div class="pokemon-header-content">
                <button class="home-nav-btn" onclick="window.location.href='index.html'" title="Go Home">
                    <img src="assets/pokeball.svg" alt="Home" class="pokeball-icon">
                </button>
                <h1 class="pokemon-title">⚔️ Join Battle</h1>
                <div class="header-spacer"></div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="pokemon-main">
            <!-- Loading State -->
            <div id="loadingState" class="loading-state">
                <img src="assets/pokeball.svg" alt="Loading..." class="pokemon-spinner" style="width: 48px; height: 48px;">
            </div>

            <!-- Error State -->
            <div id="errorState" class="error-state" style="display: none;">
                <h3>Error Loading Battle</h3>
                <p id="errorMessage">Something went wrong. Please try again.</p>
                <div class="action-buttons">
                    <a href="battle-arena.html" class="back-btn">← Back to Arena</a>
                </div>
            </div>

            <!-- Main Content -->
            <div id="mainContent" style="display: none;">
                <div class="pokemon-container">
                    <!-- Battle Information Card -->
                    <div class="battle-info-card">
                        <div class="opponent-pokemon-showcase-centered">
                            <div class="opponent-pokemon-card-large">
                                <img id="opponentPokemonImage" src="" alt="Opponent Pokemon" style="display: none;">
                                <div class="pokemon-placeholder" id="opponentPokemonPlaceholder">?</div>
                                <h4 id="opponentPokemonName">Loading...</h4>
                                <p>HP: <span id="opponentPokemonHP">Loading...</span></p>
                                <p>Level: <span id="opponentPokemonLevel">Loading...</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Pokemon Selection Card -->
                    <div class="pokemon-selection-card">
                        <h3>⚡ Select Your Pokemon</h3>
                        <div id="pokemonGrid" class="pokemon-grid">
                            <!-- Pokemon cards will be populated here -->
                        </div>

                        <div class="action-buttons">
                            <a href="battle-arena.html" class="back-btn">← Go Back</a>
                            <button class="pokemon-btn" 
                                    id="joinButton" 
                                    onclick="joinBattle()" 
                                    disabled>
                                Join Battle
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Battle Joining Overlay -->
            <div id="battleJoiningOverlay" class="battle-joining-overlay" style="display: none;">
                <img src="assets/pokeball.svg" alt="Loading..." class="battle-joining-spinner">
                <div class="battle-joining-text">Joining Battle...</div>
                <div class="battle-joining-status" id="battleJoiningStatus">Connecting to battle...</div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="auth.js"></script>
    <script src="pokemon-service.js"></script>
    <script src="portal-settings-service.js"></script>
    <script src="battle-challenge-service.js"></script>
    <script src="battle-simulation-service.js"></script>
    <script>
        class BattleJoin {
            constructor() {
                this.battleId = this.getBattleIdFromUrl();
                this.currentUser = null;
                this.battleData = null;
                this.userPokemon = [];
                this.selectedPokemon = null;
                this.pokemonData = null; // Cache for Pokemon.json data
                
                this.init();
            }
            
            // Load Pokemon data from JSON file
            async loadPokemonData() {
                if (this.pokemonData) {
                    return this.pokemonData; // Return cached data
                }
                
                try {
                    console.log('📦 Loading Pokemon.json data...');
                    const response = await fetch('src/data/pokemon.json');
                    if (!response.ok) {
                        throw new Error(`Failed to load Pokemon data: ${response.statusText}`);
                    }
                    this.pokemonData = await response.json();
                    console.log('✅ Loaded Pokemon.json data:', this.pokemonData.length, 'Pokemon');
                    return this.pokemonData;
                } catch (error) {
                    console.error('❌ Error loading Pokemon.json:', error);
                    return [];
                }
            }
            
            // Get Pokemon details by name from JSON data
            getPokemonByName(pokemonName) {
                if (!this.pokemonData) {
                    console.warn('Pokemon data not loaded yet');
                    return null;
                }
                
                return this.pokemonData.find(p => 
                    p.name.toLowerCase() === pokemonName.toLowerCase()
                );
            }
            
            // Get Pokemon that are currently in active battles
            async getActiveBattlePokemon() {
                if (!this.currentUser?.id) return [];
                
                try {
                    console.log('BATTLE-JOIN: Checking for Pokemon in active battles...');
                    
                    const authUser = await AuthService.checkAuth();
                    if (!authUser || !authUser.token) {
                        return [];
                    }

                    // Get active battles where user is player 1 or player 2
                    // statuscode 1 = Open, 895550002 = In Progress (active battles)
                    const url = `https://org2d10b8dd.api.crm3.dynamics.com/api/data/v9.2/pokemon_battles?$filter=(_pokemon_player1_value eq '${this.currentUser.id}' or _pokemon_player2_value eq '${this.currentUser.id}') and (statuscode eq 1 or statuscode eq 895550002) and statecode eq 0&$select=_pokemon_player1pokemon_value,_pokemon_player2pokemon_value`;
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        mode: 'cors',
                        credentials: 'omit',
                        headers: {
                            'Authorization': `Bearer ${authUser.token}`,
                            'Content-Type': 'application/json',
                            'X-User-Email': authUser.email
                        }
                    });

                    if (!response.ok) {
                        console.error('BATTLE-JOIN: Failed to get active battles:', response.status);
                        return [];
                    }

                    const data = await response.json();
                    const activeBattles = data.value || [];
                    
                    // Extract Pokemon IDs that are in active battles
                    const activePokemonIds = new Set();
                    activeBattles.forEach(battle => {
                        if (battle._pokemon_player1pokemon_value) {
                            activePokemonIds.add(battle._pokemon_player1pokemon_value);
                        }
                        if (battle._pokemon_player2pokemon_value) {
                            activePokemonIds.add(battle._pokemon_player2pokemon_value);
                        }
                    });
                    
                    console.log('BATTLE-JOIN: Found', activePokemonIds.size, 'Pokemon in active battles:', Array.from(activePokemonIds));
                    return Array.from(activePokemonIds);
                    
                } catch (error) {
                    console.error('BATTLE-JOIN: Error checking active battles:', error);
                    return [];
                }
            }
            
            getBattleIdFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id');
            }
            
            async init() {
                console.log('🎮 Initializing Battle Join...', this.battleId);
                
                if (!this.battleId) {
                    this.showError('No battle ID provided');
                    return;
                }
                
                // Load Pokemon data first
                await this.loadPokemonData();
                
                // Get current user
                this.currentUser = await this.getCurrentUser();
                if (!this.currentUser) {
                    this.showError('Please login to join battles');
                    return;
                }
                
                console.log('✅ User authenticated:', this.currentUser);
                
                // Load battle and Pokemon data
                await this.loadBattleData();
            }
            
            async getCurrentUser() {
                try {
                    // Check if user is authenticated using existing AuthService
                    const user = await AuthService.checkAuth();
                    if (!user) {
                        console.log('User not authenticated');
                        return null;
                    }
                    
                    if (!user.email) {
                        console.log('No user email available');
                        return null;
                    }
                    
                    // Get contact ID using the battle challenge service
                    const contactId = await BattleChallengeService.getUserContactId(user.email);
                    if (!contactId) {
                        console.error('No contact found for email:', user.email);
                        return null;
                    }
                    
                    return {
                        id: contactId,
                        name: user.name || 'Unknown Trainer',
                        email: user.email
                    };
                } catch (error) {
                    console.error('❌ Error getting current user:', error);
                    return null;
                }
            }
            
            async loadBattleData() {
                try {
                    console.log('🔄 Loading battle data...', this.battleId);
                    
                    // Use the new battle challenge service
                    const battleData = await BattleChallengeService.getBattleDetails(this.battleId);
                    console.log('✅ Battle data loaded:', battleData);
                    
                    // Check if battle is still open
                    if (battleData.statuscode !== 1) { // 1 = Open
                        throw new Error('This battle is no longer available to join');
                    }
                    
                    // Check if user is trying to join their own battle
                    if (battleData._pokemon_player1_value === this.currentUser.id) {
                        throw new Error('You cannot join your own battle');
                    }
                    
                    this.battleData = battleData;
                    
                    // Load user's Pokemon
                    await this.loadUserPokemon();
                    
                    // Render the UI
                    console.log('🎨 Rendering battle info...');
                    this.renderBattleInfo();
                    console.log('🎨 Rendering user Pokemon...');
                    this.renderUserPokemon();
                    
                    console.log('🎨 Hiding loading, showing content...');
                    // Hide loading state, show main content
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    
                    console.log('✅ UI update completed');
                    
                } catch (error) {
                    console.error('❌ Error loading battle data:', error);
                    this.showError(error.message);
                }
            }
            
            async loadUserPokemon() {
                try {
                    console.log('🔄 Loading user Pokemon...');
                    
                    // Use the battle challenge service to get caught Pokemon
                    const pokemon = await BattleChallengeService.getCaughtPokemon(this.currentUser.id);
                    
                    console.log('🔍 DEBUG: Raw Pokemon data from Dataverse:', pokemon);
                    console.log('🔍 DEBUG: Sample Pokemon structure:', pokemon[0]);
                    
                    // Keep ALL Pokemon for display, but we'll mark unavailable ones in the UI
                    this.userPokemon = pokemon;
                    
                    console.log('✅ Loaded all user Pokemon:', this.userPokemon.length);
                    console.log('🔍 DEBUG: All Pokemon data:', this.userPokemon);
                    
                } catch (error) {
                    console.error('❌ Error loading user Pokemon:', error);
                    throw error;
                }
            }
            
            renderBattleInfo() {
                try {
                    console.log('🎨 renderBattleInfo: Starting with data:', this.battleData);
                    const player1Name = this.battleData.pokemon_Player1?.firstname || 'Unknown Trainer';
                    const pokemonName = this.battleData.pokemon_Player1Pokemon?.pokemon_name || 'Unknown Pokemon';
                    const pokemonLevel = this.battleData.pokemon_Player1Pokemon?.pokemon_level || 5;
                    const pokemonHP = this.battleData.pokemon_Player1Pokemon?.pokemon_hp || '?';
                    const pokemonMaxHP = this.battleData.pokemon_Player1Pokemon?.pokemon_hpmax || '?';
                    
                    console.log('🎨 renderBattleInfo: Player 1 Pokemon data:', this.battleData.pokemon_Player1Pokemon);
                    console.log('🎨 renderBattleInfo: Opponent Pokemon:', pokemonName);
                    
                    // Update opponent Pokemon card
                    document.getElementById('opponentPokemonName').textContent = pokemonName;
                    document.getElementById('opponentPokemonHP').textContent = `${pokemonHP}/${pokemonMaxHP}`;
                    document.getElementById('opponentPokemonLevel').textContent = `Lv. ${pokemonLevel}`;
                    
                    // Pokemon name to ID mapping for sprites (comprehensive list for Gen 1)
                    const pokemonNameToId = {
                        'bulbasaur': 1, 'ivysaur': 2, 'venusaur': 3,
                        'charmander': 4, 'charmeleon': 5, 'charizard': 6,
                        'squirtle': 7, 'wartortle': 8, 'blastoise': 9,
                        'caterpie': 10, 'metapod': 11, 'butterfree': 12,
                        'weedle': 13, 'kakuna': 14, 'beedrill': 15,
                        'pidgey': 16, 'pidgeotto': 17, 'pidgeot': 18,
                        'rattata': 19, 'raticate': 20, 'spearow': 21, 'fearow': 22,
                        'ekans': 23, 'arbok': 24, 'pikachu': 25, 'raichu': 26,
                        'sandshrew': 27, 'sandslash': 28, 'nidoran♀': 29, 'nidorina': 30,
                        'nidoqueen': 31, 'nidoran♂': 32, 'nidorino': 33, 'nidoking': 34,
                        'clefairy': 35, 'clefable': 36, 'vulpix': 37, 'ninetales': 38,
                        'jigglypuff': 39, 'wigglytuff': 40, 'zubat': 41, 'golbat': 42,
                        'oddish': 43, 'gloom': 44, 'vileplume': 45, 'paras': 46,
                        'parasect': 47, 'venonat': 48, 'venomoth': 49, 'diglett': 50,
                        'dugtrio': 51, 'meowth': 52, 'persian': 53, 'psyduck': 54,
                        'golduck': 55, 'mankey': 56, 'primeape': 57, 'growlithe': 58,
                        'arcanine': 59, 'poliwag': 60, 'poliwhirl': 61, 'poliwrath': 62,
                        'abra': 63, 'kadabra': 64, 'alakazam': 65, 'machop': 66,
                        'machoke': 67, 'machamp': 68, 'bellsprout': 69, 'weepinbell': 70,
                        'victreebel': 71, 'tentacool': 72, 'tentacruel': 73, 'geodude': 74,
                        'graveler': 75, 'golem': 76, 'ponyta': 77, 'rapidash': 78,
                        'slowpoke': 79, 'slowbro': 80, 'magnemite': 81, 'magneton': 82,
                        'farfetchd': 83, 'doduo': 84, 'dodrio': 85, 'seel': 86,
                        'dewgong': 87, 'grimer': 88, 'muk': 89, 'shellder': 90,
                        'cloyster': 91, 'gastly': 92, 'haunter': 93, 'gengar': 94,
                        'onix': 95, 'drowzee': 96, 'hypno': 97, 'krabby': 98,
                        'kingler': 99, 'voltorb': 100, 'electrode': 101, 'exeggcute': 102,
                        'exeggutor': 103, 'cubone': 104, 'marowak': 105, 'hitmonlee': 106,
                        'hitmonchan': 107, 'lickitung': 108, 'koffing': 109, 'weezing': 110,
                        'rhyhorn': 111, 'rhydon': 112, 'chansey': 113, 'tangela': 114,
                        'kangaskhan': 115, 'horsea': 116, 'seadra': 117, 'goldeen': 118,
                        'seaking': 119, 'staryu': 120, 'starmie': 121, 'mr. mime': 122,
                        'scyther': 123, 'jynx': 124, 'electabuzz': 125, 'magmar': 126,
                        'pinsir': 127, 'tauros': 128, 'magikarp': 129, 'gyarados': 130,
                        'lapras': 131, 'ditto': 132, 'eevee': 133, 'vaporeon': 134,
                        'jolteon': 135, 'flareon': 136, 'porygon': 137, 'omanyte': 138,
                        'omastar': 139, 'kabuto': 140, 'kabutops': 141, 'aerodactyl': 142,
                        'snorlax': 143, 'articuno': 144, 'zapdos': 145, 'moltres': 146,
                        'dratini': 147, 'dragonair': 148, 'dragonite': 149, 'mewtwo': 150,
                        'mew': 151
                    };
                    
                    // Get Pokemon sprite ID
                    let pokemonSpriteId = pokemonNameToId[pokemonName.toLowerCase()] || 1;
                    
                    // Generate image URL from Pokemon ID
                    const imageUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemonSpriteId}.png`;
                    
                    // Update Pokemon image
                    const pokemonImage = document.getElementById('opponentPokemonImage');
                    const pokemonPlaceholder = document.getElementById('opponentPokemonPlaceholder');
                    
                    pokemonImage.src = imageUrl;
                    pokemonImage.style.display = 'block';
                    pokemonPlaceholder.style.display = 'none';
                    
                    // Handle image load error
                    pokemonImage.onerror = function() {
                        console.error('Failed to load opponent Pokemon image:', imageUrl);
                        pokemonImage.style.display = 'none';
                        pokemonPlaceholder.style.display = 'flex';
                    };
                    
                    console.log('✅ renderBattleInfo: Completed successfully');
                } catch (error) {
                    console.error('❌ renderBattleInfo: Error:', error);
                }
            }
            
            renderUserPokemon() {
                try {
                    console.log('🎨 renderUserPokemon: Starting with', this.userPokemon.length, 'Pokemon');
                    const container = document.getElementById('pokemonGrid');
                    
                    if (!container) {
                        console.error('❌ renderUserPokemon: pokemonGrid container not found');
                        return;
                    }
                    
                    if (this.userPokemon.length === 0) {
                        container.innerHTML = '<p class="empty-state">No Pokemon found. Catch some Pokemon first!</p>';
                        console.log('✅ renderUserPokemon: Showed no Pokemon message');
                        return;
                    }
                    
                    // Get Pokemon in active battles first
                    this.getActiveBattlePokemon().then(activePokemonIds => {
                        console.log('🎨 renderUserPokemon: Generating HTML for Pokemon with active battle check...');
                        
                        // Add status summary
                        const availableCount = this.userPokemon.filter(p => {
                            const pokemonId = p.pokemon_pokedexid || p.id;
                            const isInBattle = activePokemonIds.includes(pokemonId);
                            const hp = p.pokemon_hp !== undefined ? p.pokemon_hp : 0;
                            const isFainted = hp <= 0;
                            return !isInBattle && !isFainted;
                        }).length;
                        
                        const inBattleCount = this.userPokemon.filter(p => {
                            const pokemonId = p.pokemon_pokedexid || p.id;
                            return activePokemonIds.includes(pokemonId);
                        }).length;
                        
                        const faintedCount = this.userPokemon.filter(p => {
                            const hp = p.pokemon_hp !== undefined ? p.pokemon_hp : 0;
                            return hp <= 0;
                        }).length;
                        
                        // Pokemon name to ID mapping for sprites (comprehensive list for Gen 1)
                        const pokemonNameToId = {
                            'bulbasaur': 1, 'ivysaur': 2, 'venusaur': 3,
                            'charmander': 4, 'charmeleon': 5, 'charizard': 6,
                            'squirtle': 7, 'wartortle': 8, 'blastoise': 9,
                            'caterpie': 10, 'metapod': 11, 'butterfree': 12,
                            'weedle': 13, 'kakuna': 14, 'beedrill': 15,
                            'pidgey': 16, 'pidgeotto': 17, 'pidgeot': 18,
                            'rattata': 19, 'raticate': 20, 'spearow': 21, 'fearow': 22,
                            'ekans': 23, 'arbok': 24, 'pikachu': 25, 'raichu': 26,
                            'sandshrew': 27, 'sandslash': 28, 'nidoran♀': 29, 'nidorina': 30,
                            'nidoqueen': 31, 'nidoran♂': 32, 'nidorino': 33, 'nidoking': 34,
                            'clefairy': 35, 'clefable': 36, 'vulpix': 37, 'ninetales': 38,
                            'jigglypuff': 39, 'wigglytuff': 40, 'zubat': 41, 'golbat': 42,
                            'oddish': 43, 'gloom': 44, 'vileplume': 45, 'paras': 46,
                            'parasect': 47, 'venonat': 48, 'venomoth': 49, 'diglett': 50,
                            'dugtrio': 51, 'meowth': 52, 'persian': 53, 'psyduck': 54,
                            'golduck': 55, 'mankey': 56, 'primeape': 57, 'growlithe': 58,
                            'arcanine': 59, 'poliwag': 60, 'poliwhirl': 61, 'poliwrath': 62,
                            'abra': 63, 'kadabra': 64, 'alakazam': 65, 'machop': 66,
                            'machoke': 67, 'machamp': 68, 'bellsprout': 69, 'weepinbell': 70,
                            'victreebel': 71, 'tentacool': 72, 'tentacruel': 73, 'geodude': 74,
                            'graveler': 75, 'golem': 76, 'ponyta': 77, 'rapidash': 78,
                            'slowpoke': 79, 'slowbro': 80, 'magnemite': 81, 'magneton': 82,
                            'farfetchd': 83, 'doduo': 84, 'dodrio': 85, 'seel': 86,
                            'dewgong': 87, 'grimer': 88, 'muk': 89, 'shellder': 90,
                            'cloyster': 91, 'gastly': 92, 'haunter': 93, 'gengar': 94,
                            'onix': 95, 'drowzee': 96, 'hypno': 97, 'krabby': 98,
                            'kingler': 99, 'voltorb': 100, 'electrode': 101, 'exeggcute': 102,
                            'exeggutor': 103, 'cubone': 104, 'marowak': 105, 'hitmonlee': 106,
                            'hitmonchan': 107, 'lickitung': 108, 'koffing': 109, 'weezing': 110,
                            'rhyhorn': 111, 'rhydon': 112, 'chansey': 113, 'tangela': 114,
                            'kangaskhan': 115, 'horsea': 116, 'seadra': 117, 'goldeen': 118,
                            'seaking': 119, 'staryu': 120, 'starmie': 121, 'mr. mime': 122,
                            'scyther': 123, 'jynx': 124, 'electabuzz': 125, 'magmar': 126,
                            'pinsir': 127, 'tauros': 128, 'magikarp': 129, 'gyarados': 130,
                            'lapras': 131, 'ditto': 132, 'eevee': 133, 'vaporeon': 134,
                            'jolteon': 135, 'flareon': 136, 'porygon': 137, 'omanyte': 138,
                            'omastar': 139, 'kabuto': 140, 'kabutops': 141, 'aerodactyl': 142,
                            'snorlax': 143, 'articuno': 144, 'zapdos': 145, 'moltres': 146,
                            'dratini': 147, 'dragonair': 148, 'dragonite': 149, 'mewtwo': 150,
                            'mew': 151
                        };
                        
                        // Create status summary and Pokemon cards
                        const statusSummary = `
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 16px; text-align: center; font-size: 14px; color: #666; grid-column: 1 / -1;">
                                <strong>Your Pokemon:</strong> 
                                <span style="color: #28a745;">✅ ${availableCount} Available</span> • 
                                <span style="color: #e74c3c;">⚔️ ${inBattleCount} In Battle</span> • 
                                <span style="color: #6c757d;">💀 ${faintedCount} Fainted</span>
                            </div>
                        `;
                        
                        const pokemonCards = this.userPokemon.map(pokemon => {
                            console.log('🔍 DEBUG: Rendering Pokemon:', pokemon);
                            
                            // Handle both new and legacy data formats
                            const pokemonName = pokemon.name || pokemon.pokemon_name || pokemon.pokemon_pokemon?.pokemon_name || 'Unknown';
                            
                            // Check Pokemon status
                            const pokemonId = pokemon.pokemon_pokedexid || pokemon.id;
                            const isInActiveBattle = activePokemonIds.includes(pokemonId);
                            const pokemonHP = pokemon.pokemon_hp !== undefined ? pokemon.pokemon_hp : 0;
                            const isFainted = pokemonHP <= 0;
                            const isUnavailable = isInActiveBattle || isFainted;
                            
                            // Get the actual Pokemon sprite ID - try multiple sources
                            let pokemonSpriteId = pokemon.pokemonSpriteId || pokemon.pokemon_pokemon?.pokemon_id;
                            
                            // If expand didn't work, try name-based lookup
                            if (!pokemonSpriteId && pokemonName) {
                                pokemonSpriteId = pokemonNameToId[pokemonName.toLowerCase()];
                            }
                            
                            // Only proceed if we have a valid Pokemon ID
                            if (!pokemonSpriteId) {
                                console.error(`POKEMON-JOIN: No Pokemon ID found for ${pokemonName}`, pokemon);
                                pokemonSpriteId = 1; // Fallback to Bulbasaur
                            }
                            
                            const pokemonLevel = pokemon.level || pokemon.pokemon_level || '1';
                            
                            // Generate image URL from Pokemon ID
                            const imageUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemonSpriteId}.png`;
                            
                            // Determine status text and color
                            let statusText = '';
                            let statusColor = '';
                            
                            if (isInActiveBattle) {
                                statusText = '⚔️ In Battle';
                                statusColor = '#e74c3c';
                            } else if (isFainted) {
                                statusText = '💀 Fainted';
                                statusColor = '#6c757d';
                            }
                            
                            return `
                                <div class="pokemon-card ${isUnavailable ? 'unavailable' : ''}" 
                                     data-pokemon-id="${pokemon.pokemon_pokedexid || pokemon.id}"
                                     onclick="${isUnavailable ? 'battleJoin.showUnavailableMessage(\'' + (isFainted ? 'fainted' : 'battle') + '\')' : 'battleJoin.selectPokemon(\'' + (pokemon.pokemon_pokedexid || pokemon.id) + '\')'}"
                                     style="${isUnavailable ? 'opacity: 0.5; filter: grayscale(50%);' : ''}">
                                    <img src="${imageUrl}" alt="${pokemonName}" 
                                         onerror="console.error('Failed to load Pokemon image:', '${imageUrl}'); this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1.png';">
                                    <h4 style="${isUnavailable ? 'color: #999;' : ''}">${pokemonName}</h4>
                                    <p style="${isUnavailable ? 'color: #999;' : ''}">HP: ${pokemonHP}</p>
                                    <p style="${isUnavailable ? 'color: #999;' : ''}">Level: ${pokemonLevel}</p>
                                    ${statusText ? `<p style="color: ${statusColor}; font-weight: bold; font-size: 12px; margin: 4px 0 0 0;">${statusText}</p>` : ''}
                                </div>
                            `;
                        }).join('');
                        
                        container.innerHTML = statusSummary + pokemonCards;
                        
                        // Check if any Pokemon are available for battle
                        if (availableCount === 0) {
                            const joinButton = document.getElementById('joinButton');
                            if (joinButton) {
                                joinButton.style.display = 'none';
                            }
                            
                            // Show message about no available Pokemon
                            const messageDiv = document.createElement('div');
                            messageDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 16px; margin-top: 16px; text-align: center; color: #856404;';
                            messageDiv.innerHTML = '<strong>⚠️ No Pokemon Available</strong><br>All your Pokemon are either fainted or in active battles. Heal your Pokemon or wait for battles to complete.';
                            container.appendChild(messageDiv);
                        }
                        
                        console.log('✅ renderUserPokemon: Completed successfully with status indicators');
                    });
                    
                } catch (error) {
                    console.error('❌ renderUserPokemon: Error:', error);
                }
            }
            
            selectPokemon(pokemonId) {
                // Find the Pokemon and check if it's available
                const pokemon = this.userPokemon.find(p => p.pokemon_pokedexid === pokemonId);
                if (!pokemon) {
                    console.error('Pokemon not found:', pokemonId);
                    return;
                }
                
                // Check if Pokemon is fainted or in battle (should not happen with proper UI, but safety check)
                const pokemonHP = pokemon.pokemon_hp !== undefined ? pokemon.pokemon_hp : 0;
                if (pokemonHP <= 0) {
                    this.showUnavailableMessage('fainted');
                    return;
                }
                
                this.selectedPokemon = pokemon;
                
                // Update UI - remove selected from all cards
                document.querySelectorAll('.pokemon-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Add selected to clicked card (only if it's not unavailable)
                const selectedCard = document.querySelector(`[data-pokemon-id="${pokemonId}"]`);
                if (selectedCard && !selectedCard.classList.contains('unavailable')) {
                    selectedCard.classList.add('selected');
                }
                
                // Enable join button
                const joinButton = document.getElementById('joinButton');
                if (joinButton) {
                    joinButton.disabled = false;
                }
                
                console.log('✅ Selected Pokemon:', pokemonId);
            }
            
            showUnavailableMessage(reason) {
                if (reason === 'fainted') {
                    alert('This Pokemon has fainted and cannot battle. Visit a Pokemon Center to heal your Pokemon!');
                } else if (reason === 'battle') {
                    alert('This Pokemon is currently in an active battle and cannot be selected.');
                }
            }
            
            async joinBattle() {
                if (!this.selectedPokemon) {
                    alert('Please select a Pokemon first!');
                    return;
                }
                
                // Show battle joining overlay
                this.showBattleJoiningOverlay('Connecting to battle...');
                
                try {
                    console.log('🔄 Joining battle...', {
                        battleId: this.battleId,
                        pokemonId: this.selectedPokemon.pokemon_pokedexid
                    });
                    
                    // Use the battle challenge service to join
                    this.updateBattleJoiningStatus('Joining battle challenge...');
                    const result = await BattleChallengeService.joinChallenge(
                        this.battleId,
                        this.currentUser.id,
                        this.selectedPokemon.pokemon_pokedexid
                    );
                    
                    if (!result.success) {
                        throw new Error(result.error);
                    }
                    
                    console.log('✅ Successfully joined battle');
                    
                    // Start battle simulation
                    this.updateBattleJoiningStatus('Simulating battle...');
                    await this.simulateBattle();
                    
                    this.updateBattleJoiningStatus('Battle complete! Redirecting...');
                    
                    // Small delay before redirect to show completion message
                    setTimeout(() => {
                        window.location.href = `battle-result.html?battleId=${this.battleId}`;
                    }, 1000);
                    
                } catch (error) {
                    console.error('❌ Error joining battle:', error);
                    
                    // Hide overlay and show error
                    this.hideBattleJoiningOverlay();
                    
                    // Show detailed error in alert
                    alert(`❌ Battle Error: ${error.message}\n\nCheck console for full details.`);
                }
            }
            
            async simulateBattle() {
                try {
                    console.log('🎲 Simulating complex PvP battle...');
                    
                    // Get battle details with Pokemon information
                    const battleData = await BattleChallengeService.getBattleById(this.battleId);
                    console.log('📊 Battle data for simulation:', battleData);
                    console.log('🔍 Battle data keys:', Object.keys(battleData));
                    console.log('🔍 Player1Pokemon structure:', battleData.pokemon_Player1Pokemon);
                    console.log('🔍 Player2Pokemon structure:', battleData.pokemon_Player2Pokemon);
                    
                    // Extract player and Pokemon data
                    const player1 = {
                        id: battleData._pokemon_player1_value || 'player1',
                        name: battleData.pokemon_Player1?.firstname || 'Player 1'
                    };
                    
                    const player2 = {
                        id: battleData._pokemon_player2_value || 'player2',
                        name: battleData.pokemon_Player2?.firstname || 'Player 2'
                    };
                    
                    const pokemon1 = {
                        pokemon_id: battleData.pokemon_Player1Pokemon?.pokemon_pokedexid || '25',
                        pokemon_name: battleData.pokemon_Player1Pokemon?.pokemon_name || 'Pikachu',
                        pokemon_level: battleData.pokemon_Player1Pokemon?.pokemon_level || 5,
                        pokemon_hp: battleData.pokemon_Player1Pokemon?.pokemon_hp || 100,
                        pokemon_hpmax: battleData.pokemon_Player1Pokemon?.pokemon_hpmax || 100
                    };
                    
                    const pokemon2 = {
                        pokemon_id: battleData.pokemon_Player2Pokemon?.pokemon_pokedexid || '4',
                        pokemon_name: battleData.pokemon_Player2Pokemon?.pokemon_name || 'Charmander',
                        pokemon_level: battleData.pokemon_Player2Pokemon?.pokemon_level || 5,
                        pokemon_hp: battleData.pokemon_Player2Pokemon?.pokemon_hp || 100,
                        pokemon_hpmax: battleData.pokemon_Player2Pokemon?.pokemon_hpmax || 100
                    };
                    
                    // Add pokemon_pokedexid from the pokedex entries
                    pokemon1.pokemon_pokedexid = battleData.pokemon_Player1Pokemon?.pokemon_pokedexid || battleData._pokemon_player1pokemon_value;
                    pokemon2.pokemon_pokedexid = battleData.pokemon_Player2Pokemon?.pokemon_pokedexid || battleData._pokemon_player2pokemon_value;
                    
                    console.log('🔍 Player data:', { player1, player2 });
                    console.log('🔍 Pokemon data (with pokedex IDs):', { pokemon1, pokemon2 });
                    console.log(`⚔️ Battle: ${player1.name}'s ${pokemon1.pokemon_name} vs ${player2.name}'s ${pokemon2.pokemon_name}`);
                    
                    // Check if we have valid data
                    if (!player1.id || !player2.id) {
                        throw new Error('Missing player data - only one player found in battle');
                    }
                    
                    // Get max turns configuration
                    const maxTurns = await BattleSimulationService.getMaxTurns();
                    
                    // Run the complex battle simulation
                    const completeBattleData = await BattleSimulationService.simulateComplexBattle(
                        player1,
                        player2,
                        pokemon1,
                        pokemon2,
                        maxTurns
                    );
                    
                    console.log('🏆 Complex battle simulation complete:', completeBattleData);
                    
                    // Complete the battle with the full turn-by-turn data
                    console.log('🔄 Calling completeBattle with battleId:', this.battleId);
                    try {
                        const completionResult = await BattleChallengeService.completeBattle(this.battleId, completeBattleData);
                        console.log('✅ Battle completion result:', completionResult);
                    } catch (completionError) {
                        console.warn('⚠️ Battle completion failed, but continuing:', completionError.message);
                    }
                    
                    // Update Pokemon HP after battle (non-blocking)
                    console.log('🏥 Updating Pokemon HP after battle...');
                    try {
                        const hpUpdateResult = await BattleChallengeService.updateBattlePokemonHP(completeBattleData.final_result);
                        
                        if (hpUpdateResult.success) {
                            console.log(`✅ Updated HP for ${hpUpdateResult.updated_count} Pokemon`);
                        } else {
                            console.warn('⚠️ Some Pokemon HP updates failed:', hpUpdateResult.error);
                        }
                    } catch (hpError) {
                        console.warn('⚠️ HP update failed, but continuing:', hpError.message);
                    }
                    
                } catch (error) {
                    console.error('❌ Error simulating complex battle:', error);
                    console.error('❌ Error stack:', error.stack);
                    
                    // Show detailed error in alert for debugging
                    alert(`❌ Battle Simulation Error: ${error.message}\n\nFull error logged to console. Using fallback battle result.`);
                    
                    // Fallback to simple battle result
                    const simpleBattleResult = {
                        battleId: this.battleId,
                        winner: Math.random() > 0.5 ? 'player1' : 'player2',
                        battleLog: [
                            'Battle simulation encountered an error.',
                            'Fallback result generated.',
                            `Error: ${error.message}`
                        ],
                        metadata: {
                            battleType: 'pvp',
                            completedAt: new Date().toISOString(),
                            error: error.message
                        }
                    };
                    
                    console.log('🔄 Using fallback battle result:', simpleBattleResult);
                    await BattleChallengeService.completeBattle(this.battleId, simpleBattleResult);
                }
            }
            
            showError(message) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('errorState').style.display = 'block';
            }
            
            showBattleJoiningOverlay(status) {
                const overlay = document.getElementById('battleJoiningOverlay');
                const statusElement = document.getElementById('battleJoiningStatus');
                
                if (overlay && statusElement) {
                    statusElement.textContent = status;
                    overlay.style.display = 'flex';
                }
            }
            
            updateBattleJoiningStatus(status) {
                const statusElement = document.getElementById('battleJoiningStatus');
                if (statusElement) {
                    statusElement.textContent = status;
                }
            }
            
            hideBattleJoiningOverlay() {
                const overlay = document.getElementById('battleJoiningOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }
        }
        
        // Global functions
        function joinBattle() {
            if (window.battleJoin) {
                window.battleJoin.joinBattle();
            }
        }
        
        // Initialize when page loads
        let battleJoin;
        document.addEventListener('DOMContentLoaded', function() {
            battleJoin = new BattleJoin();
            window.battleJoin = battleJoin;
        });
    </script>
</body>
</html>
