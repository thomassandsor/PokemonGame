<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Battle - Pokemon Game</title>
    <link rel="stylesheet" href="styles/pokemon-design-system.css">
    <style>
        /* Battle Join Specific Styles - Clean Design */
        
        /* Clean background */
        .battle-join-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 0;
        }

        /* Battle info card */
        .battle-info-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
            padding: 24px;
            border-left: 4px solid #3b82f6;
        }

        .battle-info-card h3 {
            margin: 0 0 16px 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }

        .battle-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-label {
            font-weight: 600;
            color: #666;
        }

        .detail-value {
            color: #333;
        }

        /* Pokemon selection area */
        .pokemon-selection-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 24px;
        }

        .pokemon-selection-card h3 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 18px;
            font-weight: 600;
        }

        /* Pokemon grid */
        .pokemon-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .pokemon-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-width: 120px;
        }

        .pokemon-card:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .pokemon-card.selected {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .pokemon-card img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .pokemon-placeholder {
            width: 60px;
            height: 60px;
            background: #f0f0f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 24px;
            font-weight: bold;
            margin: 0 auto;
        }

        .pokemon-card h4 {
            margin: 8px 0 4px 0;
            font-size: 14px;
            color: #333;
            font-weight: 600;
        }

        .pokemon-card h5 {
            margin: 8px 0 4px 0;
            font-size: 16px;
            color: #333;
            font-weight: 600;
        }

        .pokemon-card p {
            margin: 0;
            font-size: 12px;
            color: #666;
        }

        .pokemon-card .level {
            margin: 4px 0;
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .pokemon-card small {
            font-size: 11px;
            color: #666;
        }

        /* HP Bar */
        .hp-bar {
            background: #e9ecef;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin: 5px 0;
        }

        .hp-fill {
            height: 100%;
            transition: width 0.5s ease;
            border-radius: 3px;
        }

        .hp-high { background: #28a745; }
        .hp-medium { background: #ffc107; }
        .hp-low { background: #dc3545; }

        /* Action buttons */
        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
        }

        .back-btn {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: #e9ecef;
            border-color: #d0d0d0;
        }

        /* Loading and error states */
        .loading-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error-state {
            background: #ffebee;
            color: #c62828;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .battle-details {
                grid-template-columns: 1fr;
            }
            
            .pokemon-grid {
                gap: 8px;
            }
            
            .pokemon-card {
                min-width: 100px;
            }
        }
    </style>
</head>
<body class="pokemon-game-body">
    <div class="battle-join-container">
        <!-- Clean Header -->
        <header class="pokemon-header">
            <div class="pokemon-header-content">
                <div class="arena-logo">‚öîÔ∏è</div>
                <h1 class="pokemon-title">Join Battle</h1>
                <div class="trainer-info">
                    <div class="trainer-name" id="trainerName">Ready to Battle!</div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="pokemon-main">
            <!-- Loading State -->
            <div id="loadingState" class="loading-state">
                <div class="pokemon-spinner"></div>
                <h3>Loading Battle...</h3>
                <p>Please wait while we load the battle information.</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="error-state" style="display: none;">
                <h3>Error Loading Battle</h3>
                <p id="errorMessage">Something went wrong. Please try again.</p>
                <div class="action-buttons">
                    <a href="battle-arena.html" class="back-btn">‚Üê Back to Arena</a>
                </div>
            </div>

            <!-- Main Content -->
            <div id="mainContent" style="display: none;">
                <div class="pokemon-container">
                    <!-- Battle Information Card -->
                    <div class="battle-info-card">
                        <h3>‚öîÔ∏è Battle Information</h3>
                        <div class="battle-details">
                            <div class="detail-item">
                                <span class="detail-label">Challenger:</span>
                                <span class="detail-value" id="challengerName">Loading...</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Pokemon:</span>
                                <span class="detail-value" id="challengerPokemon">Loading...</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Level:</span>
                                <span class="detail-value" id="pokemonLevel">Loading...</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Created:</span>
                                <span class="detail-value" id="battleCreated">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pokemon Selection Card -->
                    <div class="pokemon-selection-card">
                        <h3>‚ö° Select Your Pokemon</h3>
                        <div id="pokemonGrid" class="pokemon-grid">
                            <!-- Pokemon cards will be populated here -->
                        </div>

                        <div class="action-buttons">
                            <a href="battle-arena.html" class="back-btn">‚Üê Go Back</a>
                            <button class="pokemon-button pokemon-button-primary" 
                                    id="joinButton" 
                                    onclick="joinBattle()" 
                                    disabled>
                                Join Battle
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="auth.js"></script>
    <script src="pokemon-service.js"></script>
    <script src="battle-challenge-service.js"></script>
    <script>
        class BattleJoin {
            constructor() {
                this.battleId = this.getBattleIdFromUrl();
                this.currentUser = null;
                this.battleData = null;
                this.userPokemon = [];
                this.selectedPokemon = null;
                
                this.init();
            }
            
            getBattleIdFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id');
            }
            
            async init() {
                console.log('üéÆ Initializing Battle Join...', this.battleId);
                
                if (!this.battleId) {
                    this.showError('No battle ID provided');
                    return;
                }
                
                // Get current user
                this.currentUser = await this.getCurrentUser();
                if (!this.currentUser) {
                    this.showError('Please login to join battles');
                    return;
                }
                
                console.log('‚úÖ User authenticated:', this.currentUser);
                
                // Load battle and Pokemon data
                await this.loadBattleData();
            }
            
            async getCurrentUser() {
                try {
                    // Check if user is authenticated using existing AuthService
                    const user = await AuthService.checkAuth();
                    if (!user) {
                        console.log('User not authenticated');
                        return null;
                    }
                    
                    if (!user.email) {
                        console.log('No user email available');
                        return null;
                    }
                    
                    // Get contact ID using the battle challenge service
                    const contactId = await BattleChallengeService.getUserContactId(user.email);
                    if (!contactId) {
                        console.error('No contact found for email:', user.email);
                        return null;
                    }
                    
                    return {
                        id: contactId,
                        name: user.name || 'Unknown Trainer',
                        email: user.email
                    };
                } catch (error) {
                    console.error('‚ùå Error getting current user:', error);
                    return null;
                }
            }
            
            async loadBattleData() {
                try {
                    console.log('üîÑ Loading battle data...', this.battleId);
                    
                    // Use the new battle challenge service
                    const battleData = await BattleChallengeService.getBattleDetails(this.battleId);
                    console.log('‚úÖ Battle data loaded:', battleData);
                    
                    // Check if battle is still open
                    if (battleData.statuscode !== 1) { // 1 = Open
                        throw new Error('This battle is no longer available to join');
                    }
                    
                    // Check if user is trying to join their own battle
                    if (battleData._pokemon_player1_value === this.currentUser.id) {
                        throw new Error('You cannot join your own battle');
                    }
                    
                    this.battleData = battleData;
                    
                    // Load user's Pokemon
                    await this.loadUserPokemon();
                    
                    // Render the UI
                    console.log('üé® Rendering battle info...');
                    this.renderBattleInfo();
                    console.log('üé® Rendering user Pokemon...');
                    this.renderUserPokemon();
                    
                    console.log('üé® Hiding loading, showing content...');
                    // Hide loading state, show main content
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    
                    console.log('‚úÖ UI update completed');
                    
                } catch (error) {
                    console.error('‚ùå Error loading battle data:', error);
                    this.showError(error.message);
                }
            }
            
            async loadUserPokemon() {
                try {
                    console.log('üîÑ Loading user Pokemon...');
                    
                    // Use the battle challenge service to get caught Pokemon
                    const pokemon = await BattleChallengeService.getCaughtPokemon(this.currentUser.id);
                    
                    // Filter out fainted Pokemon (HP <= 0)
                    this.userPokemon = pokemon.filter(p => {
                        const hp = p.pokemon_current_hp || p.pokemon_max_hp || 100;
                        return hp > 0;
                    });
                    
                    console.log('‚úÖ Loaded user Pokemon:', this.userPokemon.length);
                    
                    if (this.userPokemon.length === 0) {
                        throw new Error('You have no Pokemon available for battle. Catch some Pokemon first or heal your current team!');
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error loading user Pokemon:', error);
                    throw error;
                }
            }
            
            renderBattleInfo() {
                try {
                    console.log('üé® renderBattleInfo: Starting with data:', this.battleData);
                    const player1Name = this.battleData.pokemon_Player1?.firstname || 'Unknown Trainer';
                    const pokemonData = this.battleData.pokemon_Player1Pokemon?.pokemon_Pokemon;
                    const pokemonName = pokemonData?.pokemon_name || 'Unknown Pokemon';
                    const pokemonLevel = this.battleData.pokemon_Player1Pokemon?.pokemon_level || 5;
                    const createdDate = this.battleData.createdon ? 
                        new Date(this.battleData.createdon).toLocaleDateString() : 'Unknown';
                    
                    console.log('üé® renderBattleInfo: Setting challenger name to:', player1Name);
                    document.getElementById('challengerName').textContent = player1Name;
                    console.log('üé® renderBattleInfo: Setting challenger Pokemon to:', pokemonName);
                    document.getElementById('challengerPokemon').textContent = pokemonName;
                    document.getElementById('pokemonLevel').textContent = `Lv. ${pokemonLevel}`;
                    document.getElementById('battleCreated').textContent = createdDate;
                    
                    console.log('‚úÖ renderBattleInfo: Completed successfully');
                } catch (error) {
                    console.error('‚ùå renderBattleInfo: Error:', error);
                }
            }
            
            renderUserPokemon() {
                try {
                    console.log('üé® renderUserPokemon: Starting with', this.userPokemon.length, 'Pokemon');
                    const container = document.getElementById('pokemonGrid');
                    
                    if (!container) {
                        console.error('‚ùå renderUserPokemon: pokemonGrid container not found');
                        return;
                    }
                    
                    if (this.userPokemon.length === 0) {
                        container.innerHTML = '<p class="empty-state">No Pokemon available for battle. All your Pokemon may be fainted or you need to catch some first!</p>';
                        console.log('‚úÖ renderUserPokemon: Showed no Pokemon message');
                        return;
                    }
                    
                    console.log('üé® renderUserPokemon: Generating HTML for Pokemon...');
                    container.innerHTML = this.userPokemon.map(pokemon => {
                        const pokemonData = pokemon.pokemon_Pokemon;
                        const hp = pokemon.pokemon_current_hp || pokemon.pokemon_max_hp || 100;
                        const maxHp = pokemon.pokemon_max_hp || 100;
                        const hpPercentage = (hp / maxHp) * 100;
                        const hpClass = hpPercentage > 60 ? 'hp-high' : hpPercentage > 30 ? 'hp-medium' : 'hp-low';
                        
                        return `
                            <div class="pokemon-card" 
                                 data-pokemon-id="${pokemon.pokemon_pokedexid}"
                                 onclick="battleJoin.selectPokemon('${pokemon.pokemon_pokedexid}')">
                                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemonData?.pokemon_id || 1}.png" 
                                     alt="${pokemonData?.pokemon_name || 'Unknown'}">
                                <h5>${pokemon.pokemon_nickname || pokemonData?.pokemon_name || 'Unknown Pokemon'}</h5>
                                <p class="level">Level ${pokemon.pokemon_level || 5}</p>
                                <div class="hp-bar">
                                    <div class="hp-fill ${hpClass}" style="width: ${hpPercentage}%"></div>
                                </div>
                                <small>HP: ${hp}/${maxHp}</small>
                            </div>
                        `;
                    }).join('');
                    console.log('‚úÖ renderUserPokemon: Completed successfully');
                } catch (error) {
                    console.error('‚ùå renderUserPokemon: Error:', error);
                }
            }
            
            selectPokemon(pokemonId) {
                this.selectedPokemon = this.userPokemon.find(p => p.pokemon_pokedexid === pokemonId);
                
                // Update UI
                document.querySelectorAll('.pokemon-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelector(`[data-pokemon-id="${pokemonId}"]`).classList.add('selected');
                
                // Enable join button
                document.getElementById('joinButton').disabled = false;
                
                console.log('‚úÖ Selected Pokemon:', pokemonId);
            }
            
            async joinBattle() {
                if (!this.selectedPokemon) {
                    alert('Please select a Pokemon first!');
                    return;
                }
                
                // Show loading on button
                const joinBtn = document.getElementById('joinButton');
                const originalText = joinBtn.textContent;
                joinBtn.textContent = 'Joining...';
                joinBtn.disabled = true;
                
                try {
                    console.log('üîÑ Joining battle...', {
                        battleId: this.battleId,
                        pokemonId: this.selectedPokemon.pokemon_pokedexid
                    });
                    
                    // Use the battle challenge service to join
                    const result = await BattleChallengeService.joinChallenge(
                        this.battleId,
                        this.currentUser.id,
                        this.selectedPokemon.pokemon_pokedexid
                    );
                    
                    if (!result.success) {
                        throw new Error(result.error);
                    }
                    
                    console.log('‚úÖ Successfully joined battle');
                    
                    // Start battle simulation
                    await this.simulateBattle();
                    
                    // Redirect to battle result
                    window.location.href = `battle-result.html?battleId=${this.battleId}`;
                    
                } catch (error) {
                    console.error('‚ùå Error joining battle:', error);
                    
                    // Restore button
                    joinBtn.textContent = originalText;
                    joinBtn.disabled = false;
                    
                    alert(`Failed to join battle: ${error.message}`);
                }
            }
            
            async simulateBattle() {
                try {
                    console.log('üé≤ Simulating PvP battle...');
                    
                    // For now, just log that simulation would happen
                    // In a full implementation, this would simulate the battle between the two players' Pokemon
                    console.log('‚ö†Ô∏è PvP battle simulation not yet implemented - battle will be marked as completed');
                    
                    // Create a simple battle result for now
                    const battleResult = {
                        battleId: this.battleId,
                        winner: Math.random() > 0.5 ? 'player1' : 'player2',
                        battleLog: [
                            'Battle simulation is not yet fully implemented.',
                            'This is a placeholder result.',
                            'In the future, this will be a full turn-by-turn battle.'
                        ],
                        metadata: {
                            battleType: 'pvp',
                            completedAt: new Date().toISOString()
                        }
                    };
                    
                    // Complete the battle
                    await BattleChallengeService.completeBattle(this.battleId, battleResult);
                    
                } catch (error) {
                    console.error('‚ùå Error simulating battle:', error);
                    // Don't throw - battle can still be resolved manually
                }
            }
            
            showError(message) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('errorState').style.display = 'block';
            }
        }
        
        // Global functions
        function joinBattle() {
            if (window.battleJoin) {
                window.battleJoin.joinBattle();
            }
        }
        
        // Initialize when page loads
        let battleJoin;
        document.addEventListener('DOMContentLoaded', function() {
            battleJoin = new BattleJoin();
            window.battleJoin = battleJoin;
        });
    </script>
</body>
</html>
