<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catch Pokemon - QR Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
    <style>
        .scanner-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 20px 0;
        }
        
        .scanner-card {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .scanner-header {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .scanner-content {
            padding: 30px;
        }
        
        #video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border: 3px solid #007bff;
            border-radius: 10px;
            background: #000;
        }
        
        .scan-result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .scan-result.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .pokemon-preview {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            text-align: center;
        }
        
        .pokemon-image-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .pokemon-image {
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
        }
        
        .pokemon-name-display {
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .pokemon-number {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .encounter-actions {
            margin-top: 20px;
        }
        
        .camera-select {
            margin-top: 15px;
        }
        
        .catch-result {
            margin-top: 20px;
            text-align: center;
        }
        
        .pokemon-preview .btn {
            margin: 5px;
        }
        
        #catchPokemonBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="scanner-container">
        <div class="scanner-card">
            <div class="scanner-header">
                <h1><i class="fas fa-qrcode"></i> Catch Pokemon</h1>
                <p class="mb-0">Scan Pokemon QR codes to add them to your collection!</p>
            </div>
            
            <div class="scanner-content">
                <!-- Camera Selection -->
                <div class="camera-select">
                    <label for="cameraSelect" class="form-label">Select Camera:</label>
                    <select id="cameraSelect" class="form-select">
                        <option value="">Loading cameras...</option>
                    </select>
                </div>
                
                <!-- Video Element for Camera -->
                <div class="text-center">
                    <video id="video" autoplay muted playsinline></video>
                </div>
                
                <!-- Scan Results -->
                <div id="scanResult" class="scan-result" style="display: none;">
                    <h5><i class="fas fa-check-circle"></i> QR Code Detected!</h5>
                    <p><strong>Pokemon Number:</strong> <span id="pokemonNumber"></span></p>
                    <p><strong>Raw Data:</strong> <span id="rawData"></span></p>
                </div>
                
                <!-- Error Display -->
                <div id="errorResult" class="scan-result error" style="display: none;">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error</h5>
                    <p id="errorMessage"></p>
                </div>
                
                <!-- Pokemon Preview -->
                <div id="pokemonPreview" class="pokemon-preview" style="display: none;">
                    <div class="pokemon-encounter">
                        <h4>🎉 Wild Pokemon Appeared!</h4>
                        <div class="pokemon-image-container text-center mb-3">
                            <img id="pokemonImage" src="" alt="Pokemon" class="pokemon-image" style="max-width: 200px; height: auto;">
                        </div>
                        <div class="pokemon-details text-center mb-3">
                            <h5 id="pokemonName" class="pokemon-name-display">Loading...</h5>
                            <p class="pokemon-number">Pokemon #<span id="previewNumber"></span></p>
                        </div>
                        <div class="encounter-actions">
                            <div id="pokeballThrowContainer" style="display:none;">
                                <div class="throw-instructions">Swipe up to throw the Pokeball!</div>
                                <div class="catch-zone" id="catchZone" style="margin:0 auto;">
                                    <img id="throwPokemonSprite" class="pokemon-sprite" src="" alt="Pokemon">
                                </div>
                                <img id="pokeball" class="pokeball" src="assets/pokeball.svg" alt="Pokeball">
                            </div>
                            <button id="catchPokemonBtn" class="btn btn-success btn-lg me-2" onclick="startPokeballThrow()">
                                <i class="fas fa-hand-paper"></i> Catch
                            </button>
                            <button id="runAwayBtn" class="btn btn-warning btn-lg" onclick="handleRunAway()">
                                <i class="fas fa-running"></i> Run
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Catch Result -->
                <div id="catchResult" class="catch-result" style="display: none;">
                    <div id="catchSuccess" class="alert alert-success" style="display: none;">
                        <h5><i class="fas fa-trophy"></i> Pokemon Caught!</h5>
                        <p id="catchSuccessMessage"></p>
                    </div>
                    <div id="catchError" class="alert alert-danger" style="display: none;">
                        <h5><i class="fas fa-exclamation-triangle"></i> Catch Failed</h5>
                        <p id="catchErrorMessage"></p>
                    </div>
                    <button class="btn btn-primary" onclick="startNewScan()">
                        <i class="fas fa-qrcode"></i> Scan Another Pokemon
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Include jsQR library for QR code scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <!-- Include Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Include Auth Service -->
    <script src="auth.js"></script>
    
    <!-- Include Catch Pokemon Service -->
    <!-- Include Pokeball Throw Logic -->
    <script src="throw-pokeball.js"></script>
    <script src="catch-pokemon-service.js"></script>
    
    <script>
        // Start Pokeball throw sequence
        function startPokeballThrow() {
            // Hide catch button, show throw UI
            document.getElementById('catchPokemonBtn').style.display = 'none';
            document.getElementById('pokeballThrowContainer').style.display = 'block';
            // Set sprite
            const spriteUrl = window.currentPokemonData?.sprites?.official_artwork || window.currentPokemonData?.sprites?.front_default || '';
            document.getElementById('throwPokemonSprite').src = spriteUrl;
            // Init throw logic
            const pokeballElem = document.getElementById('pokeball');
            const targetElem = document.getElementById('catchZone');
            new PokeballThrow({
                pokeballElem,
                targetElem,
                onThrow: async function() {
                    // After throw, proceed to catch logic
                    document.getElementById('pokeballThrowContainer').style.display = 'none';
                    await handleCatchPokemon();
                }
            });
        }
        class QRScanner {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.scanning = false;
                this.stream = null;
                this.cameras = [];
                this.currentCamera = null;
                
                this.initializeScanner();
            }
            
            async initializeScanner() {
                console.log('🎮 Initializing QR Scanner...');
                
                // Wait a moment for AuthService to restore session
                console.log('AUTH: Waiting for session restoration...');
                await AuthService.restoreAuthFromSession();
                
                // Check authentication
                console.log('AUTH: Checking authentication status...');
                console.log('AUTH: isAuthenticated():', AuthService.isAuthenticated());
                console.log('AUTH: getCurrentUser():', AuthService.getCurrentUser());
                
                if (!AuthService.isAuthenticated()) {
                    console.log('User not authenticated, redirecting to login');
                    window.location.href = '/index.html';
                    return;
                }
                
                console.log('✅ User authenticated, proceeding with scanner setup...');
                
                // Set up camera selection event listener
                document.getElementById('cameraSelect').addEventListener('change', (e) => this.switchCamera(e.target.value));
                
                // Get available cameras and start scanning
                await this.loadCameras();
                
                // Auto-start scanning after cameras are loaded
                if (this.cameras.length > 0) {
                    await this.startScanning();
                }
            }
            
            async loadCameras() {
                try {
                    console.log('📷 Loading available cameras...');
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    this.cameras = devices.filter(device => device.kind === 'videoinput');
                    
                    const cameraSelect = document.getElementById('cameraSelect');
                    cameraSelect.innerHTML = '';
                    
                    if (this.cameras.length === 0) {
                        cameraSelect.innerHTML = '<option value="">No cameras found</option>';
                        this.showError('No cameras found on this device');
                        return;
                    }
                    
                    this.cameras.forEach((camera, index) => {
                        const option = document.createElement('option');
                        option.value = camera.deviceId;
                        option.textContent = camera.label || `Camera ${index + 1}`;
                        cameraSelect.appendChild(option);
                    });
                    
                    // Select the back camera if available (usually better for QR scanning)
                    const backCamera = this.cameras.find(camera => 
                        camera.label.toLowerCase().includes('back') || 
                        camera.label.toLowerCase().includes('rear')
                    );
                    
                    if (backCamera) {
                        cameraSelect.value = backCamera.deviceId;
                        this.currentCamera = backCamera.deviceId;
                    } else {
                        this.currentCamera = this.cameras[0].deviceId;
                    }
                    
                    console.log(`📷 Found ${this.cameras.length} cameras`);
                } catch (error) {
                    console.error('Error loading cameras:', error);
                    this.showError('Failed to access cameras. Please allow camera permissions.');
                }
            }
            
            async startScanning() {
                try {
                    console.log('📱 Starting QR scanner...');
                    
                    const constraints = {
                        video: {
                            deviceId: this.currentCamera ? { exact: this.currentCamera } : undefined,
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: this.currentCamera ? undefined : { ideal: 'environment' }
                        }
                    };
                    
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;
                    
                    this.scanning = true;
                    
                    // Start the scanning loop
                    this.video.addEventListener('loadedmetadata', () => {
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                        this.scanLoop();
                    });
                    
                    this.hideError();
                    this.hideResult();
                    
                } catch (error) {
                    console.error('Error starting scanner:', error);
                    this.showError('Failed to start camera. Please check permissions and try again.');
                }
            }
            
            stopScanning() {
                console.log('⏹️ Stopping QR scanner...');
                
                this.scanning = false;
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                this.video.srcObject = null;
            }
            
            switchCamera(deviceId) {
                console.log('🔄 Switching camera:', deviceId);
                this.currentCamera = deviceId;
                
                if (this.scanning) {
                    this.stopScanning();
                    setTimeout(() => this.startScanning(), 500);
                }
            }
            
            scanLoop() {
                if (!this.scanning) return;
                
                if (this.video.readyState === this.video.HAVE_ENOUGH_DATA) {
                    this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                    const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                    
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        console.log('📱 QR Code detected:', code.data);
                        this.handleQRCode(code.data);
                    }
                }
                
                if (this.scanning) {
                    requestAnimationFrame(() => this.scanLoop());
                }
            }
            
            handleQRCode(data) {
                console.log('🎯 Processing QR code:', data);
                
                // Extract pokemon number from QR data
                const pokemonNumber = this.extractPokemonNumber(data);
                
                if (pokemonNumber) {
                    this.showResult(pokemonNumber, data);
                    // Stop scanning after successful scan
                    this.stopScanning();
                } else {
                    this.showError('Invalid Pokemon QR code format');
                }
            }
            
            extractPokemonNumber(data) {
                // Try to extract number from QR data
                // Assume QR contains just a number, or in format like "pokemon:123"
                
                // If it's just a number
                if (/^\d+$/.test(data)) {
                    return parseInt(data);
                }
                
                // If it's in format "pokemon:123" or "123" or similar
                const match = data.match(/(\d+)/);
                if (match) {
                    return parseInt(match[1]);
                }
                
                return null;
            }
            
            async showResult(pokemonNumber, rawData) {
                // Store globally for catch function
                currentPokemonNumber = pokemonNumber;
                
                document.getElementById('pokemonNumber').textContent = pokemonNumber;
                document.getElementById('rawData').textContent = rawData;
                document.getElementById('scanResult').style.display = 'block';
                document.getElementById('errorResult').style.display = 'none';
                
                // Show pokemon preview
                document.getElementById('previewNumber').textContent = pokemonNumber;
                document.getElementById('pokemonPreview').style.display = 'block';
                
                // Load Pokemon data
                await this.loadPokemonData(pokemonNumber);
                
                console.log(`✅ Pokemon #${pokemonNumber} detected!`);
            }
            
            async loadPokemonData(pokemonNumber) {
                try {
                    document.getElementById('pokemonName').textContent = 'Loading...';
                    document.getElementById('pokemonImage').style.display = 'none';
                    
                    // Fetch Pokemon data from local JSON file
                    const response = await fetch('/legacy-react/src/data/pokemon.json');
                    
                    if (!response.ok) {
                        throw new Error(`Failed to load Pokemon data: ${response.status}`);
                    }
                    
                    const pokemonData = await response.json();
                    
                    // Find Pokemon by ID
                    const pokemon = pokemonData.find(p => p.id === pokemonNumber);
                    
                    if (pokemon) {
                        // Update Pokemon name (capitalize first letter)
                        const pokemonName = pokemon.name.charAt(0).toUpperCase() + pokemon.name.slice(1);
                        document.getElementById('pokemonName').textContent = pokemonName;
                        
                        // Set Pokemon image - prefer official artwork, fallback to front_default
                        const imageUrl = pokemon.sprites.official_artwork || pokemon.sprites.front_default;
                        const pokemonImage = document.getElementById('pokemonImage');
                        pokemonImage.src = imageUrl;
                        pokemonImage.alt = pokemonName;
                        pokemonImage.style.display = 'block';
                        
                        // Store Pokemon data globally for catch function
                        window.currentPokemonData = {
                            id: pokemon.id,
                            number: pokemonNumber,
                            name: pokemonName,
                            types: pokemon.types,
                            sprites: pokemon.sprites,
                            stats: pokemon.stats
                        };
                        
                        console.log(`📊 Loaded Pokemon data:`, window.currentPokemonData);
                        
                    } else {
                        throw new Error(`Pokemon #${pokemonNumber} not found in local data`);
                    }
                    
                } catch (error) {
                    console.error('Error loading Pokemon data:', error);
                    
                    // Fallback to basic display
                    const pokemonName = `Pokemon #${pokemonNumber}`;
                    document.getElementById('pokemonName').textContent = pokemonName;
                    
                    // Set fallback image from PokeAPI
                    const pokemonImage = document.getElementById('pokemonImage');
                    pokemonImage.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemonNumber}.png`;
                    pokemonImage.alt = pokemonName;
                    pokemonImage.style.display = 'block';
                    
                    // Store minimal data
                    window.currentPokemonData = {
                        id: pokemonNumber,
                        number: pokemonNumber,
                        name: pokemonName
                    };
                }
            }
            
            showError(message) {
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('errorResult').style.display = 'block';
                document.getElementById('scanResult').style.display = 'none';
            }
            
            hideError() {
                document.getElementById('errorResult').style.display = 'none';
            }
            
            hideResult() {
                document.getElementById('scanResult').style.display = 'none';
                document.getElementById('pokemonPreview').style.display = 'none';
                document.getElementById('catchResult').style.display = 'none';
            }
        }
        
        // Global variables to store current scan data
        let currentPokemonNumber = null;
        
        // Handle catching the Pokemon
        async function handleCatchPokemon() {
            if (!currentPokemonNumber) {
                alert('No Pokemon selected to catch!');
                return;
            }
            
            const catchBtn = document.getElementById('catchPokemonBtn');
            const originalText = catchBtn.innerHTML;
            
            try {
                // Disable button and show loading
                catchBtn.disabled = true;
                catchBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Catching...';
                
                // Call catch service with no options (simplified)
                const result = await CatchPokemonService.catchPokemon(currentPokemonNumber);
                
                // Hide preview and show result
                document.getElementById('pokemonPreview').style.display = 'none';
                document.getElementById('catchResult').style.display = 'block';
                
                if (result.success) {
                    // Show success
                    document.getElementById('catchSuccess').style.display = 'block';
                    document.getElementById('catchError').style.display = 'none';
                    
                    const pokemon = result.pokemon;
                    let message = `🎉 ${pokemon.name} has been added to your Pokedex!`;
                    
                    document.getElementById('catchSuccessMessage').textContent = message;
                    
                } else {
                    // Show detailed error information
                    document.getElementById('catchSuccess').style.display = 'none';
                    document.getElementById('catchError').style.display = 'block';
                    
                    // Create detailed error message
                    let errorDetails = `❌ Error: ${result.error}\n\n`;
                    errorDetails += `📋 Debug Info:\n`;
                    errorDetails += `• Pokemon Number: ${currentPokemonNumber}\n`;
                    errorDetails += `• Timestamp: ${new Date().toISOString()}\n`;
                    errorDetails += `• User Agent: ${navigator.userAgent.substring(0, 50)}...\n`;
                    
                    // Check console logs for additional context
                    errorDetails += `\n🔍 Check browser console (F12) for detailed logs`;
                    
                    document.getElementById('catchErrorMessage').innerHTML = errorDetails.replace(/\n/g, '<br>');
                }
                
            } catch (error) {
                console.error('🚨 CATCH ERROR:', error);
                console.error('🚨 Error Stack:', error.stack);
                console.error('🚨 Error Details:', {
                    message: error.message,
                    name: error.name,
                    pokemonNumber: currentPokemonNumber,
                    timestamp: new Date().toISOString()
                });
                
                // Show detailed error
                document.getElementById('pokemonPreview').style.display = 'none';
                document.getElementById('catchResult').style.display = 'block';
                document.getElementById('catchSuccess').style.display = 'none';
                document.getElementById('catchError').style.display = 'block';
                
                // Create comprehensive error message
                let errorDetails = `❌ Unexpected Error: ${error.message}\n\n`;
                errorDetails += `📋 Technical Details:\n`;
                errorDetails += `• Error Type: ${error.name}\n`;
                errorDetails += `• Pokemon Number: ${currentPokemonNumber}\n`;
                errorDetails += `• Timestamp: ${new Date().toISOString()}\n`;
                errorDetails += `• Browser: ${navigator.userAgent.split(' ')[0]}\n`;
                
                if (error.stack) {
                    const stackLines = error.stack.split('\n').slice(0, 3);
                    errorDetails += `• Stack: ${stackLines.join(' → ')}\n`;
                }
                
                errorDetails += `\n🔍 Check browser console (F12) for complete error details`;
                
                document.getElementById('catchErrorMessage').innerHTML = errorDetails.replace(/\n/g, '<br>');
                
            } finally {
                // Reset button
                catchBtn.disabled = false;
                catchBtn.innerHTML = originalText;
            }
        }
        
        // Handle running away from the Pokemon
        function handleRunAway() {
            console.log('🏃 Player chose to run away');
            
            // Clear current Pokemon data
            currentPokemonNumber = null;
            window.currentPokemonData = null;
            
            // Hide all result sections
            document.getElementById('scanResult').style.display = 'none';
            document.getElementById('pokemonPreview').style.display = 'none';
            document.getElementById('catchResult').style.display = 'none';
            document.getElementById('errorResult').style.display = 'none';
            
            // Restart scanner for new Pokemon
            const scanner = window.qrScanner;
            if (scanner && !scanner.scanning) {
                scanner.startScanning();
            }
        }
        
        // Start a new scan
        function startNewScan() {
            currentPokemonNumber = null;
            
            // Hide all result sections
            document.getElementById('scanResult').style.display = 'none';
            document.getElementById('pokemonPreview').style.display = 'none';
            document.getElementById('catchResult').style.display = 'none';
            document.getElementById('errorResult').style.display = 'none';
            
            // Restart scanner if not already running
            const scanner = window.qrScanner;
            if (scanner && !scanner.scanning) {
                scanner.startScanning();
            }
        }
        
        // Initialize the scanner when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.qrScanner = new QRScanner();
        });
    </script>
</body>
</html>
