<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catch Pokemon - QR Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
    html, body {
        height: 100vh;
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 50%, #45b7d1 100%);
        font-family: 'Arial', sans-serif;
    }

    /* Pokemon-themed Scanner Frame */
    .pokemon-scanner-frame {
        position: relative;
        width: 90vw;
        max-width: 400px;
        margin: 20px auto;
        background: linear-gradient(145deg, #ffcc02, #3d7dca);
        padding: 8px;
        border-radius: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        border: 4px solid #fff;
    }

    .pokemon-scanner-inner {
        background: #000;
        border-radius: 20px;
        padding: 15px;
        position: relative;
        overflow: hidden;
    }

    #qrVideo {
        width: 100%;
        height: 60vh;
        max-height: 400px;
        object-fit: cover;
        border-radius: 15px;
        display: block;
    }

    .pokemon-scanner-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 200px;
        height: 200px;
        border: 3px solid #ffcc02;
        border-radius: 15px;
        box-shadow: 0 0 0 4px rgba(255, 204, 2, 0.3);
        pointer-events: none;
        z-index: 10;
    }

    .pokemon-scanner-corners {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 200px;
        height: 200px;
        pointer-events: none;
        z-index: 11;
    }

    .corner {
        position: absolute;
        width: 20px;
        height: 20px;
        border: 4px solid #ffcc02;
    }

    .corner.top-left {
        top: -2px;
        left: -2px;
        border-right: none;
        border-bottom: none;
        border-top-left-radius: 10px;
    }

    .corner.top-right {
        top: -2px;
        right: -2px;
        border-left: none;
        border-bottom: none;
        border-top-right-radius: 10px;
    }

    .corner.bottom-left {
        bottom: -2px;
        left: -2px;
        border-right: none;
        border-top: none;
        border-bottom-left-radius: 10px;
    }

    .corner.bottom-right {
        bottom: -2px;
        right: -2px;
        border-left: none;
        border-top: none;
        border-bottom-right-radius: 10px;
    }

    .pokemon-title {
        text-align: center;
        color: #fff;
        font-size: 1.8rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        margin-bottom: 20px;
    }

    .scan-instruction {
        text-align: center;
        color: #fff;
        font-size: 1.2rem;
        margin-top: 15px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.6);
        border-radius: 10px;
    }

    /* Fullscreen Modal Overlay */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.9);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        touch-action: none;
        overscroll-behavior: contain;
    }

    .modal-content {
        width: 90vw;
        max-width: 500px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .pokemon-encounter {
        background: linear-gradient(145deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        border: 3px solid #fff;
    }

    .pokemon-sprite-large {
        width: 60vw;
        max-width: 250px;
        height: auto;
        margin-bottom: 20px;
        filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
    }

    .pokemon-name {
        color: #fff;
        font-size: 2rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        margin-bottom: 20px;
    }

    .modal-actions {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-top: 20px;
    }

    .btn-pokemon {
        font-size: 1.3rem;
        padding: 12px 30px;
        border-radius: 25px;
        border: none;
        font-weight: bold;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .btn-pokemon.catch {
        background: linear-gradient(145deg, #ff6b6b, #ee5a52);
        color: white;
    }

    .btn-pokemon.catch:hover {
        transform: translateY(-2px);
        box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
    }

    .btn-pokemon.run {
        background: linear-gradient(145deg, #feca57, #ff9ff3);
        color: #333;
    }

    .btn-pokemon.run:hover {
        transform: translateY(-2px);
        box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
    }

    /* Throw Animation Container */
    .throw-container {
        text-align: center;
        color: #fff;
    }

    .throw-instructions {
        font-size: 1.4rem;
        font-weight: bold;
        margin-bottom: 30px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
    }

    .catch-zone {
        margin: 30px 0;
        position: relative;
    }

    .pokeball {
        width: 80px;
        height: 80px;
        margin: 20px auto;
        display: block;
        cursor: pointer;
        transition: transform 0.3s ease;
    }

    .pokeball:hover {
        transform: scale(1.1);
    }

    /* Animation for scanning pulse effect */
    @keyframes scanPulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 204, 2, 0.7); }
        70% { box-shadow: 0 0 0 20px rgba(255, 204, 2, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 204, 2, 0); }
    }

    .pokemon-scanner-overlay.scanning {
        animation: scanPulse 2s infinite;
    }

    /* Hidden by default */
    .hidden {
        display: none !important;
    }

    /* Pokeball count display */
    .pokeball-count {
        background: rgba(255, 255, 255, 0.2);
        color: #fff;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 1rem;
        font-weight: bold;
        margin-bottom: 15px;
        text-align: center;
    }

    .pokeball-count.empty {
        background: rgba(255, 107, 107, 0.3);
        color: #ff6b6b;
    }

    /* No pokeballs message */
    .no-pokeballs-message {
        background: rgba(255, 107, 107, 0.2);
        border: 2px solid #ff6b6b;
        color: #fff;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
    }

    /* Minigame styles */
    .minigame-container {
        background: linear-gradient(145deg, #4ecdc4, #44a08d);
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
        text-align: center;
    }

    .minigame-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #fff;
        margin-bottom: 15px;
    }

    .minigame-button {
        background: linear-gradient(145deg, #feca57, #ff9ff3);
        color: #333;
        font-size: 1.2rem;
        font-weight: bold;
        padding: 15px 30px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        margin: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .minigame-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 7px 20px rgba(0, 0, 0, 0.3);
    }

    .minigame-result {
        margin-top: 15px;
        padding: 10px;
        border-radius: 10px;
        font-weight: bold;
    }

    .minigame-result.success {
        background: rgba(76, 175, 80, 0.3);
        color: #4CAF50;
    }

    .minigame-result.failure {
        background: rgba(244, 67, 54, 0.3);
        color: #f44336;
    }
    </style>
</head>
<body>
    <!-- Pokemon QR Scanner -->
    <div id="scannerContainer" class="container">
        <div class="pokemon-title">üîç Pok√©mon Scanner</div>
        
        <div class="pokemon-scanner-frame">
            <div class="pokemon-scanner-inner">
                <video id="qrVideo" playsinline autoplay></video>
                <div class="pokemon-scanner-overlay scanning"></div>
                <div class="pokemon-scanner-corners">
                    <div class="corner top-left"></div>
                    <div class="corner top-right"></div>
                    <div class="corner bottom-left"></div>
                    <div class="corner bottom-right"></div>
                </div>
            </div>
        </div>
        
        <div class="scan-instruction">
            Point your camera at a Pok√©mon QR code
        </div>
        
        <div id="videoDebugInfo" style="color:#fff; text-align:center; margin-top:15px; font-size:0.9rem;"></div>
    </div>

    <!-- Pokemon Encounter Modal -->
    <div id="encounterModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="pokemon-encounter">
                <img id="encounterPokemonImage" class="pokemon-sprite-large" src="" alt="Pokemon">
                <div id="encounterPokemonName" class="pokemon-name">Loading...</div>
                
                <!-- Pokeball Count Display -->
                <div id="pokeballCountDisplay" class="pokeball-count">
                    ‚öæ Pok√©balls: <span id="pokeballCount">0</span>
                </div>
                
                <!-- Default Actions (when pokeballs available) -->
                <div id="defaultActions" class="modal-actions">
                    <button class="btn-pokemon catch" onclick="startThrowAnimation()">
                        ‚öæ Catch!
                    </button>
                    <button class="btn-pokemon run" onclick="runAway()">
                        üèÉ Run Away
                    </button>
                </div>

                <!-- No Pokeballs Message -->
                <div id="noPokeballs" class="no-pokeballs-message hidden">
                    ‚ùå No more Pok√©balls!<br>
                    <small>Play a minigame to earn them</small>
                </div>

                <!-- No Pokeballs Actions -->
                <div id="noPokeballActions" class="modal-actions hidden">
                    <button class="btn-pokemon catch" onclick="MinigameLibrary.showMinigameSelection()">
                        üéÆ Choose Minigame
                    </button>
                    <button class="btn-pokemon run" onclick="runAway()">
                        üèÉ Run Away
                    </button>
                </div>

                <!-- Minigame Container -->
                <div id="minigameContainer" class="minigame-container hidden">
                    <div class="minigame-title">üéØ Catch the Moving Target!</div>
                    <div id="minigameInstructions">
                        Click the button when the target is in the green zone!
                    </div>
                    <div style="position: relative; width: 200px; height: 20px; background: #ccc; margin: 20px auto; border-radius: 10px;">
                        <div style="position: absolute; width: 60px; height: 20px; background: #4CAF50; left: 70px; border-radius: 10px;"></div>
                        <div id="minigameTarget" style="position: absolute; width: 20px; height: 20px; background: #ff6b6b; border-radius: 50%; top: 0; transition: left 0.1s;"></div>
                    </div>
                    <button id="minigameClickButton" class="minigame-button" onclick="minigameClick()">
                        üéØ CATCH!
                    </button>
                    <div id="minigameResult" class="minigame-result hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pokeball Throw Animation -->
    <div id="throwModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="throw-container">
                <div class="throw-instructions">Swipe up to throw the Pok√©ball!</div>
                <div class="catch-zone">
                    <img id="throwPokemonSprite" class="pokemon-sprite-large" src="" alt="Target Pokemon">
                </div>
                <img id="pokeball" class="pokeball" src="assets/pokeball.svg" alt="Pokeball">
            </div>
        </div>
    </div>

    <!-- Include Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Include jsQR library for QR code scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <!-- Include Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Include Auth Service -->
    <script src="auth.js"></script>
    
    <!-- Include Catch Pokemon Service -->
    <script src="catch-pokemon-service.js"></script>
    
    <!-- Include Minigame Library -->
    <script src="minigame-library.js"></script>
    
    <!-- Include Pokeball Throw Logic -->
    <script src="throw-pokeball.js"></script>
    
    <script>
        // Global variables
        let currentPokemonData = null;
        let qrScanner = null;

        // UI State Management
        const UI_STATES = {
            SCANNER: 'scanner',
            ENCOUNTER: 'encounter', 
            THROW: 'throw'
        };

        let currentState = UI_STATES.SCANNER;

        // Show only the specified UI state
        function showUIState(state) {
            currentState = state;
            
            // Hide all containers
            document.getElementById('scannerContainer').classList.add('hidden');
            document.getElementById('encounterModal').classList.add('hidden');
            document.getElementById('throwModal').classList.add('hidden');
            
            // Show the requested state
            switch(state) {
                case UI_STATES.SCANNER:
                    document.getElementById('scannerContainer').classList.remove('hidden');
                    // Restart scanner if it exists
                    if (qrScanner && !qrScanner.scanning) {
                        qrScanner.startScanning();
                    }
                    break;
                    
                case UI_STATES.ENCOUNTER:
                    document.getElementById('encounterModal').classList.remove('hidden');
                    break;
                    
                case UI_STATES.THROW:
                    document.getElementById('throwModal').classList.remove('hidden');
                    break;
            }
        }

        // Show loading spinner with rotating pokeball
        function showLoadingSpinner(message = 'Loading...') {
            // Remove any existing spinner first
            hideLoadingSpinner();
            
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'globalLoadingOverlay';
            loadingOverlay.className = 'modal-overlay';
            loadingOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            `;
            loadingOverlay.innerHTML = `
                <style>
                    @keyframes rotatePokeball {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                    .rotating-pokeball-svg {
                        width: 80px;
                        height: 80px;
                        animation: rotatePokeball 1.5s linear infinite;
                        margin-bottom: 20px;
                        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
                    }
                </style>
                <div style="text-align: center; color: white; padding: 40px;">
                    <svg class="rotating-pokeball-svg" width="80" height="80" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="60" cy="60" r="55" stroke="#222" stroke-width="5" fill="#fff"/>
                        <path d="M5 60a55 55 0 0 1 110 0" fill="#e53935" stroke="#222" stroke-width="5"/>
                        <circle cx="60" cy="60" r="20" stroke="#222" stroke-width="5" fill="#fff"/>
                        <circle cx="60" cy="60" r="10" fill="#eee" stroke="#222" stroke-width="3"/>
                    </svg>
                    <h2 style="color: #4CAF50; font-size: 1.5rem; margin: 0;">
                        ${message}
                    </h2>
                </div>
            `;
            document.body.appendChild(loadingOverlay);
        }

        // Hide loading spinner
        function hideLoadingSpinner() {
            const existingOverlay = document.getElementById('globalLoadingOverlay');
            if (existingOverlay) {
                existingOverlay.remove();
            }
        }

        // Handle QR scan result
        function onQRCodeDetected(pokemonNumber, rawData) {
            console.log(`üéØ Pokemon #${pokemonNumber} detected!`);
            
            // Store Pokemon number globally for use after minigame
            window.currentPokemonNumber = pokemonNumber;
            
            // Stop scanning
            if (qrScanner) {
                qrScanner.stopScanning();
            }
            
            // Show loading spinner while checking user data and Pokemon availability
            showLoadingSpinner('Checking Pokemon availability...');
            
            // Check user data and Pokemon availability upfront
            checkPokemonAvailability(pokemonNumber).then(result => {
                hideLoadingSpinner();
                
                if (!result.canCatch) {
                    // Show appropriate error message and return to scanner
                    if (result.reason === 'duplicate') {
                        showDuplicatePokemonModal(pokemonNumber, result.message);
                    } else if (result.reason === 'user_not_found') {
                        alert(`‚ùå ${result.message}\n\nPlease make sure you're logged in properly.`);
                        showUIState(UI_STATES.SCANNER);
                    } else {
                        alert(`‚ùå ${result.message}`);
                        showUIState(UI_STATES.SCANNER);
                    }
                    return;
                }
                
                // Store user data for later use
                window.currentUserData = result.userData;
                
                // Pokemon can be caught - load Pokemon data and show encounter
                loadPokemonData(pokemonNumber).then(pokemonData => {
                    if (pokemonData) {
                        currentPokemonData = pokemonData;
                        showPokemonEncounter(pokemonData, result.userData);
                    } else {
                        alert('Failed to load Pokemon data. Please try again.');
                        showUIState(UI_STATES.SCANNER);
                    }
                }).catch(error => {
                    console.error('Error loading Pokemon data:', error);
                    alert('Failed to load Pokemon data. Please try again.');
                    showUIState(UI_STATES.SCANNER);
                });
                
            }).catch(error => {
                console.error('Error checking Pokemon availability:', error);
                hideLoadingSpinner();
                alert(`Failed to check Pokemon availability: ${error.message}`);
                showUIState(UI_STATES.SCANNER);
            });
        }

        // Check if Pokemon can be caught by user
        async function checkPokemonAvailability(pokemonNumber) {
            try {
                // Get current user
                const currentUser = AuthService.getCurrentUser();
                if (!currentUser || !currentUser.email) {
                    return {
                        canCatch: false,
                        reason: 'user_not_found',
                        message: 'User not authenticated. Please log in again.'
                    };
                }
                
                // Get comprehensive user data
                const userData = await CatchPokemonService.getUserData(currentUser.email);
                
                // Check if Pokemon can be caught
                const catchCheck = CatchPokemonService.canCatchPokemon(pokemonNumber, userData);
                
                return {
                    ...catchCheck,
                    userData
                };
                
            } catch (error) {
                console.error('Error checking Pokemon availability:', error);
                throw error;
            }
        }

        // Show Pokemon encounter screen
        async function showPokemonEncounter(pokemonData, userData = null) {
            document.getElementById('encounterPokemonImage').src = 
                pokemonData.sprites?.official_artwork || pokemonData.sprites?.front_default || '';
            document.getElementById('encounterPokemonName').textContent = pokemonData.name;
            
            // Use pre-fetched user data if available, otherwise fetch it
            let userInfo = userData;
            if (!userInfo) {
                try {
                    const currentUser = AuthService.getCurrentUser();
                    if (currentUser && currentUser.email) {
                        userInfo = await CatchPokemonService.getUserData(currentUser.email);
                        window.currentUserData = userInfo;
                    }
                } catch (error) {
                    console.error('Error getting user data in encounter:', error);
                }
            }
            
            // Display pokeball count and update UI
            if (userInfo) {
                document.getElementById('pokeballCount').textContent = userInfo.pokeballCount;
                
                // Check if user can catch with pokeball
                const catchCheck = CatchPokemonService.canCatchWithPokeball(window.currentPokemonNumber, userInfo);
                
                if (catchCheck.canCatch) {
                    // User has pokeballs - show normal catch option
                    document.getElementById('pokeballCountDisplay').classList.remove('empty');
                    document.getElementById('defaultActions').classList.remove('hidden');
                    document.getElementById('noPokeballs').classList.add('hidden');
                    document.getElementById('noPokeballActions').classList.add('hidden');
                    document.getElementById('minigameContainer').classList.add('hidden');
                } else {
                    showNoPokeballs();
                }
            } else {
                // Fallback - show no pokeballs state
                showNoPokeballs();
            }
            
            showUIState(UI_STATES.ENCOUNTER);
        }

        // Check pokeball count and display appropriate UI
        async function checkAndDisplayPokeballCount() {
            try {
                // Check if CatchPokemonService is available
                if (typeof CatchPokemonService === 'undefined') {
                    console.warn('CatchPokemonService not available, defaulting to no pokeballs');
                    showNoPokeballs();
                    return;
                }

                // Get current user
                const currentUser = AuthService.getCurrentUser();
                if (!currentUser || !currentUser.email) {
                    throw new Error('User not authenticated');
                }

                // Get pokeball count
                const pokeballCount = await CatchPokemonService.getUserPokeballCount(currentUser.email);
                document.getElementById('pokeballCount').textContent = pokeballCount;

                // Update UI based on pokeball count
                if (pokeballCount > 0) {
                    // User has pokeballs - show normal catch option
                    document.getElementById('pokeballCountDisplay').classList.remove('empty');
                    document.getElementById('defaultActions').classList.remove('hidden');
                    document.getElementById('noPokeballs').classList.add('hidden');
                    document.getElementById('noPokeballActions').classList.add('hidden');
                    document.getElementById('minigameContainer').classList.add('hidden');
                } else {
                    showNoPokeballs();
                }

            } catch (error) {
                console.error('Error checking pokeball count:', error);
                showNoPokeballs();
            }
        }

        // Show no pokeballs UI
        function showNoPokeballs() {
            document.getElementById('pokeballCount').textContent = '0';
            document.getElementById('pokeballCountDisplay').classList.add('empty');
            document.getElementById('defaultActions').classList.add('hidden');
            document.getElementById('noPokeballs').classList.remove('hidden');
            document.getElementById('noPokeballActions').classList.remove('hidden');
            document.getElementById('minigameContainer').classList.add('hidden');
        }

        // Start throw animation
        function startThrowAnimation() {
            if (!currentPokemonData) {
                alert('No Pokemon data available!');
                return;
            }
            
            // Set up throw screen
            document.getElementById('throwPokemonSprite').src = 
                currentPokemonData.sprites?.official_artwork || currentPokemonData.sprites?.front_default || '';
            
            showUIState(UI_STATES.THROW);
            
            // Initialize pokeball throw logic
            const pokeballElem = document.getElementById('pokeball');
            const targetElem = document.getElementById('throwPokemonSprite');
            
            // Use existing PokeballThrow class if available
            if (typeof PokeballThrow !== 'undefined') {
                new PokeballThrow({
                    pokeballElem,
                    targetElem,
                    onThrow: async function() {
                        await handleCatchPokemon();
                    }
                });
            } else {
                // Simple fallback - just catch on click
                pokeballElem.onclick = async function() {
                    await handleCatchPokemon();
                };
            }
        }

        // Handle running away
        function runAway() {
            console.log('üèÉ Player chose to run away');
            currentPokemonData = null;
            showUIState(UI_STATES.SCANNER);
        }

        // Handle catching Pokemon - Always succeeds when pokeball is thrown
        async function handleCatchPokemon() {
            if (!currentPokemonData) {
                alert('No Pokemon to catch!');
                return;
            }
            
            try {
                console.log(`üéØ Attempting to catch ${currentPokemonData.name}...`);
                
                // Show loading spinner while catching Pokemon
                showLoadingSpinner('Catching Pokemon...');
                
                // Use existing catch service if available
                if (typeof CatchPokemonService !== 'undefined' && window.currentUserData) {
                    const result = await CatchPokemonService.catchPokemonOptimized(
                        currentPokemonData.id, 
                        window.currentUserData
                    );
                    
                    hideLoadingSpinner();
                    
                    if (result.success) {
                        // Always successful - pokeball was consumed and Pokemon caught
                        showCatchSuccessMessage(currentPokemonData.name);
                    } else {
                        // This could happen if no pokeballs (shouldn't reach here with our UI logic)
                        if (result.error.includes('No pokeballs available')) {
                            alert(`‚ùå No Pok√©balls available! Play the minigame to earn more.`);
                            showUIState(UI_STATES.ENCOUNTER); // Go back to encounter to show minigame
                        } else {
                            alert(`‚ùå Failed to catch ${currentPokemonData.name}: ${result.error}`);
                            returnToScanner();
                        }
                    }
                } else if (typeof CatchPokemonService !== 'undefined') {
                    // Fallback to non-optimized version if no user data cached
                    const result = await CatchPokemonService.catchPokemon(currentPokemonData.id);
                    
                    hideLoadingSpinner();
                    
                    if (result.success) {
                        showCatchSuccessMessage(currentPokemonData.name);
                    } else {
                        if (result.error.includes('No pokeballs available')) {
                            alert(`‚ùå No Pok√©balls available! Play the minigame to earn more.`);
                            showUIState(UI_STATES.ENCOUNTER);
                        } else {
                            alert(`‚ùå Failed to catch ${currentPokemonData.name}: ${result.error}`);
                            returnToScanner();
                        }
                    }
                } else {
                    // Fallback for when service isn't available
                    hideLoadingSpinner();
                    showCatchSuccessMessage(currentPokemonData.name, true);
                }
                
            } catch (error) {
                hideLoadingSpinner();
                console.error('Catch error:', error);
                alert(`‚ùå Error catching Pokemon: ${error.message}`);
                returnToScanner();
            }
        }

        // Show catch success message and return to scanner
        async function showCatchSuccessMessage(pokemonName, isDemo = false) {
            const demoText = isDemo ? ' (Demo mode)' : '';
            
            // Get updated pokeball count to show in success message
            let pokeballInfo = '';
            if (!isDemo && typeof CatchPokemonService !== 'undefined') {
                try {
                    const currentUser = AuthService.getCurrentUser();
                    if (currentUser && currentUser.email) {
                        const remainingPokeballs = await CatchPokemonService.getUserPokeballCount(currentUser.email);
                        pokeballInfo = `<div style="margin-top: 15px; color: #ffcc02; font-size: 1rem;">
                            ‚öæ Pok√©balls remaining: ${remainingPokeballs}
                        </div>`;
                    }
                } catch (error) {
                    console.error('Error getting updated pokeball count:', error);
                }
            }
            
            // Create a nice success overlay
            const successOverlay = document.createElement('div');
            successOverlay.className = 'modal-overlay';
            successOverlay.style.background = 'rgba(0,0,0,0.8)';
            successOverlay.innerHTML = `
                <div style="text-align: center; color: white; padding: 40px;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üéâ</div>
                    <h2 style="color: #4CAF50; font-size: 2rem; margin-bottom: 15px;">
                        ${pokemonName} Caught!
                    </h2>
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">
                        ${pokemonName} has been added to your Pok√©dex${demoText}
                    </p>
                    ${pokeballInfo}
                    <button onclick="returnToMainMenu()" 
                            style="background: linear-gradient(145deg, #4CAF50, #45a049); 
                                   color: white; padding: 15px 30px; border: none; 
                                   border-radius: 25px; font-size: 1.1rem; cursor: pointer;
                                   margin-top: 20px;">
                        Return to Main Menu
                    </button>
                </div>
            `;
            
            document.body.appendChild(successOverlay);
            
            // Auto-remove success message after 4 seconds
            setTimeout(() => {
                if (document.body.contains(successOverlay)) {
                    returnToMainMenu();
                }
            }, 4000);
        }

        // Return to main menu and clean up
        function returnToMainMenu() {
            // Remove any success overlays
            const successOverlays = document.querySelectorAll('.modal-overlay:not(#encounterModal):not(#throwModal)');
            successOverlays.forEach(overlay => {
                if (document.body.contains(overlay)) {
                    document.body.removeChild(overlay);
                }
            });
            
            // Redirect to main menu
            window.location.href = '/index.html';
        }

        // Show duplicate Pokemon modal with nice UI
        function showDuplicatePokemonModal(pokemonNumber, message) {
            // Create a nice error overlay
            const errorOverlay = document.createElement('div');
            errorOverlay.className = 'modal-overlay';
            errorOverlay.style.background = 'rgba(0,0,0,0.8)';
            errorOverlay.innerHTML = `
                <div style="text-align: center; color: white; padding: 40px;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üîÑ</div>
                    <h2 style="color: #ff9800; font-size: 2rem; margin-bottom: 15px;">
                        Already Caught!
                    </h2>
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">
                        ${message}
                    </p>
                    <p style="font-size: 1rem; color: #ffcc02; margin-bottom: 30px;">
                        Try scanning a different Pok√©mon QR code to catch a new one!
                    </p>
                    <button onclick="closeDuplicateModal()" 
                            style="background: linear-gradient(145deg, #2196F3, #1976D2); 
                                   color: white; padding: 15px 30px; border: none; 
                                   border-radius: 25px; font-size: 1.1rem; cursor: pointer;
                                   margin-right: 10px;">
                        Continue Scanning
                    </button>
                    <button onclick="returnToMainMenu()" 
                            style="background: linear-gradient(145deg, #6c757d, #5a6268); 
                                   color: white; padding: 15px 30px; border: none; 
                                   border-radius: 25px; font-size: 1.1rem; cursor: pointer;">
                        Main Menu
                    </button>
                </div>
            `;
            
            document.body.appendChild(errorOverlay);
            
            // Auto-close and return to scanner after 6 seconds if no action taken
            setTimeout(() => {
                if (document.body.contains(errorOverlay)) {
                    closeDuplicateModal();
                }
            }, 6000);
        }

        // Close duplicate modal and return to scanner
        function closeDuplicateModal() {
            // Remove the duplicate error overlay
            const errorOverlays = document.querySelectorAll('.modal-overlay:not(#encounterModal):not(#throwModal)');
            errorOverlays.forEach(overlay => {
                if (document.body.contains(overlay)) {
                    document.body.removeChild(overlay);
                }
            });
            
            // Return to scanner
            showUIState(UI_STATES.SCANNER);
        }

        // Return to scanner and clean up (for other cases like errors)
        function returnToScanner() {
            // Remove any success overlays
            const successOverlays = document.querySelectorAll('.modal-overlay:not(#encounterModal):not(#throwModal)');
            successOverlays.forEach(overlay => {
                if (document.body.contains(overlay)) {
                    document.body.removeChild(overlay);
                }
            });
            
            // Reset and go back to scanner
            currentPokemonData = null;
            showUIState(UI_STATES.SCANNER);
        }

        // Minigame functionality
        let minigameInterval = null;
        let minigameTargetPosition = 0;
        let minigameDirection = 1;
        let minigameActive = false;

        // Start the minigame
        function startMinigame() {
            console.log('üéÆ Starting pokeball minigame');
            
            // Hide other actions and show minigame
            document.getElementById('noPokeballActions').classList.add('hidden');
            document.getElementById('minigameContainer').classList.remove('hidden');
            
            // Reset minigame state
            minigameTargetPosition = 0;
            minigameDirection = 1;
            minigameActive = true;
            
            const target = document.getElementById('minigameTarget');
            const result = document.getElementById('minigameResult');
            result.classList.add('hidden');
            
            // Start the moving target
            minigameInterval = setInterval(() => {
                if (!minigameActive) return;
                
                minigameTargetPosition += minigameDirection * 3;
                
                // Bounce at edges
                if (minigameTargetPosition >= 180) {
                    minigameDirection = -1;
                    minigameTargetPosition = 180;
                } else if (minigameTargetPosition <= 0) {
                    minigameDirection = 1;
                    minigameTargetPosition = 0;
                }
                
                target.style.left = minigameTargetPosition + 'px';
            }, 50);
        }

        // Handle minigame click
        function minigameClick() {
            if (!minigameActive) return;
            
            // Stop the game
            minigameActive = false;
            clearInterval(minigameInterval);
            
            // Check if target is in green zone (70px to 130px)
            const isInGreenZone = minigameTargetPosition >= 70 && minigameTargetPosition <= 130;
            
            const result = document.getElementById('minigameResult');
            result.classList.remove('hidden', 'success', 'failure');
            
            if (isInGreenZone) {
                // Success! Give user a pokeball
                result.classList.add('success');
                result.textContent = 'üéâ Perfect! You earned a Pok√©ball!';
                
                // Add pokeball to user's inventory
                addPokeballReward();
                
            } else {
                // Failed - allow retry
                result.classList.add('failure');
                result.textContent = '‚ùå Missed! Try again?';
                
                setTimeout(() => {
                    document.getElementById('minigameContainer').classList.add('hidden');
                    document.getElementById('noPokeballActions').classList.remove('hidden');
                }, 2000);
            }
        }

        // Minigame completed - actually catch the Pokemon (no pokeball consumption)
        async function addPokeballReward() {
            try {
                const currentUser = AuthService.getCurrentUser();
                if (!currentUser || !currentUser.email) {
                    console.log('User not authenticated for minigame completion');
                    return;
                }

                console.log('üéÆ Minigame completed successfully - catching Pokemon without consuming pokeballs');
                
                // Hide ALL UI elements immediately to prevent "No Pokeballs" screen from showing
                document.getElementById('minigameContainer').classList.add('hidden');
                document.getElementById('noPokeballActions').classList.add('hidden');
                document.getElementById('encounterModal').classList.add('hidden');
                document.getElementById('throwModal').classList.add('hidden');
                
                // Show a loading message with rotating SVG pokeball while catching
                const loadingOverlay = document.createElement('div');
                loadingOverlay.id = 'minigameLoadingOverlay';
                loadingOverlay.className = 'modal-overlay';
                loadingOverlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0,0,0,0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                `;
                loadingOverlay.innerHTML = `
                    <style>
                        @keyframes rotatePokeball {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                        .rotating-pokeball-svg {
                            width: 80px;
                            height: 80px;
                            animation: rotatePokeball 1.5s linear infinite;
                            margin-bottom: 20px;
                            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
                        }
                    </style>
                    <div style="text-align: center; color: white; padding: 40px;">
                        <svg class="rotating-pokeball-svg" width="80" height="80" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="60" cy="60" r="55" stroke="#222" stroke-width="5" fill="#fff"/>
                            <path d="M5 60a55 55 0 0 1 110 0" fill="#e53935" stroke="#222" stroke-width="5"/>
                            <circle cx="60" cy="60" r="20" stroke="#222" stroke-width="5" fill="#fff"/>
                            <circle cx="60" cy="60" r="10" fill="#eee" stroke="#222" stroke-width="3"/>
                        </svg>
                        <h2 style="color: #4CAF50; font-size: 1.5rem; margin: 0;">
                            Catching Pokemon...
                        </h2>
                    </div>
                `;
                document.body.appendChild(loadingOverlay);
                
                // Actually catch the Pokemon using the special minigame catch method
                let result;
                if (window.currentUserData) {
                    // Use optimized version with pre-fetched user data
                    result = await CatchPokemonService.catchPokemonMinigameOptimized(
                        window.currentPokemonNumber, 
                        window.currentUserData
                    );
                } else {
                    // Fallback to non-optimized version
                    result = await CatchPokemonService.catchPokemonMinigame(window.currentPokemonNumber);
                }
                
                // Remove loading overlay
                const loadingEl = document.getElementById('minigameLoadingOverlay');
                if (loadingEl) {
                    document.body.removeChild(loadingEl);
                }
                
                if (result.success) {
                    console.log('üéÆ Pokemon caught successfully via minigame:', result.pokemon.name);
                    console.time('üéÆ Success message display time');
                    // Show the same success message as normal catch but with "Back to Menu" button
                    showMinigameSuccessMessage(result.pokemon.name);
                    console.timeEnd('üéÆ Success message display time');
                } else {
                    console.error('üéÆ Minigame catch failed:', result.error);
                    alert(`Failed to catch Pokemon: ${result.error}`);
                    // Return to scanner on failure
                    window.currentPokemonNumber = null;
                    currentPokemonData = null;
                    setUIState(UI_STATES.SCANNER);
                }
                
            } catch (error) {
                console.error('Error completing minigame:', error);
                alert('Error completing minigame. Please try again.');
                // Remove loading overlay if it exists
                const loadingEl = document.getElementById('minigameLoadingOverlay');
                if (loadingEl) {
                    document.body.removeChild(loadingEl);
                }
                // Return to scanner on error
                window.currentPokemonNumber = null;
                currentPokemonData = null;
                setUIState(UI_STATES.SCANNER);
            }
        }

        // Show minigame completion success message (same as catch success but different button)
        function showMinigameSuccessMessage(pokemonName) {
            console.log('üéÆ Starting to create success overlay...');
            
            // Create a nice success overlay (same style as normal catch)
            const successOverlay = document.createElement('div');
            successOverlay.className = 'modal-overlay';
            successOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0,0,0,0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            `;
            
            successOverlay.innerHTML = `
                <div style="text-align: center; color: white; padding: 40px; background: rgba(0,0,0,0.9); border-radius: 20px; max-width: 90vw;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üéâ</div>
                    <h2 style="color: #4CAF50; font-size: 2rem; margin-bottom: 15px;">
                        ${pokemonName} Caught!
                    </h2>
                    <p style="font-size: 1.2rem; margin-bottom: 20px;">
                        ${pokemonName} has been added to your Pok√©dex
                    </p>
                    <button onclick="backToMenu()" 
                            style="background: linear-gradient(145deg, #4CAF50, #45a049); 
                                   color: white; padding: 15px 30px; border: none; 
                                   border-radius: 25px; font-size: 1.1rem; cursor: pointer;
                                   margin-top: 20px;">
                        Back to Menu
                    </button>
                </div>
            `;
            
            console.log('üéÆ About to append success overlay to DOM...');
            document.body.appendChild(successOverlay);
            console.log('üéÆ Success overlay added to DOM!');
        }

        // Back to menu function for minigame completion
        function backToMenu() {
            // Remove any success overlays
            const successOverlays = document.querySelectorAll('.modal-overlay:not(#encounterModal):not(#throwModal)');
            successOverlays.forEach(overlay => {
                if (document.body.contains(overlay)) {
                    document.body.removeChild(overlay);
                }
            });
            
            // Clear stored Pokemon data and go back to main menu
            window.currentPokemonNumber = null;
            currentPokemonData = null;
            
            // Navigate to main menu
            window.location.href = '/index.html';
        }

        // Load Pokemon data
        async function loadPokemonData(pokemonNumber) {
            try {
                document.getElementById('videoDebugInfo').textContent = 'Loading Pokemon data...';
                
                // Try to load from local JSON file first
                const response = await fetch('/legacy-react/src/data/pokemon.json');
                
                if (response.ok) {
                    const pokemonData = await response.json();
                    const pokemon = pokemonData.find(p => p.id === pokemonNumber);
                    
                    if (pokemon) {
                        document.getElementById('videoDebugInfo').textContent = '';
                        return {
                            id: pokemon.id,
                            name: pokemon.name.charAt(0).toUpperCase() + pokemon.name.slice(1),
                            types: pokemon.types,
                            sprites: pokemon.sprites,
                            stats: pokemon.stats
                        };
                    }
                }
                
                // Fallback to PokeAPI
                const fallbackResponse = await fetch(`https://pokeapi.co/api/v2/pokemon/${pokemonNumber}`);
                if (fallbackResponse.ok) {
                    const pokemon = await fallbackResponse.json();
                    document.getElementById('videoDebugInfo').textContent = '';
                    return {
                        id: pokemon.id,
                        name: pokemon.name.charAt(0).toUpperCase() + pokemon.name.slice(1),
                        types: pokemon.types,
                        sprites: pokemon.sprites,
                        stats: pokemon.stats
                    };
                }
                
                throw new Error('Pokemon not found');
                
            } catch (error) {
                console.error('Error loading Pokemon data:', error);
                document.getElementById('videoDebugInfo').textContent = 'Failed to load Pokemon data';
                return null;
            }
        }

        // QR Scanner Class
        class QRScanner {
            constructor() {
                this.video = document.getElementById('qrVideo');
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.scanning = false;
                this.stream = null;
                
                console.log('[QRScanner] Initializing...');
                this.initializeScanner();
            }
            
            async initializeScanner() {
                try {
                    // Check authentication if AuthService exists
                    if (typeof AuthService !== 'undefined') {
                        await AuthService.restoreAuthFromSession();
                        
                        if (!AuthService.isAuthenticated()) {
                            document.getElementById('videoDebugInfo').innerHTML = 
                                '<span style="color: #ff6b6b;">‚ö†Ô∏è Authentication required. Please log in.</span>';
                            return;
                        }
                    }
                    
                    console.log('‚úÖ Starting camera setup...');
                    await this.setupCamera();
                    
                } catch (error) {
                    console.error('Scanner initialization error:', error);
                    document.getElementById('videoDebugInfo').innerHTML = 
                        '<span style="color: #ff6b6b;">‚ùå Failed to initialize scanner</span>';
                }
            }
            
            async setupCamera() {
                try {
                    // Get camera permissions
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment' // Prefer back camera on mobile
                        } 
                    });
                    
                    this.video.srcObject = stream;
                    this.stream = stream;
                    
                    // Wait for video to be ready
                    this.video.addEventListener('loadedmetadata', () => {
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                        this.startScanning();
                    });
                    
                    document.getElementById('videoDebugInfo').innerHTML = 
                        '<span style="color: #4ecdc4;">üì∑ Camera ready - Point at a Pok√©mon QR code</span>';
                        
                } catch (error) {
                    console.error('Camera setup error:', error);
                    document.getElementById('videoDebugInfo').innerHTML = 
                        '<span style="color: #ff6b6b;">‚ùå Camera access denied or not available</span>';
                }
            }
            
            startScanning() {
                if (this.scanning) return;
                
                this.scanning = true;
                console.log('üéØ Starting QR scan loop...');
                document.getElementById('videoDebugInfo').innerHTML = 
                    '<span style="color: #4ecdc4;">üîç Scanning for QR codes...</span>';
                    
                this.scanLoop();
            }
            
            stopScanning() {
                this.scanning = false;
                console.log('‚èπÔ∏è Stopping QR scanner');
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                }
            }
            
            scanLoop() {
                if (!this.scanning || !this.video) return;
                
                if (this.video.readyState === this.video.HAVE_ENOUGH_DATA) {
                    this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                    const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Scan for QR code using jsQR
                    if (typeof jsQR !== 'undefined') {
                        const code = jsQR(imageData.data, imageData.width, imageData.height);
                        
                        if (code) {
                            console.log('üéØ QR Code detected:', code.data);
                            this.handleQRCode(code.data);
                            return; // Stop scanning after successful detection
                        }
                    }
                }
                
                if (this.scanning) {
                    requestAnimationFrame(() => this.scanLoop());
                }
            }
            
            handleQRCode(data) {
                // Extract Pokemon number from QR data
                const pokemonNumber = this.extractPokemonNumber(data);
                
                if (pokemonNumber && pokemonNumber > 0 && pokemonNumber <= 1010) { // Valid Pokemon range
                    onQRCodeDetected(pokemonNumber, data);
                } else {
                    document.getElementById('videoDebugInfo').innerHTML = 
                        '<span style="color: #ff6b6b;">‚ùå Invalid Pok√©mon QR code</span>';
                    
                    // Resume scanning after 2 seconds
                    setTimeout(() => {
                        if (currentState === UI_STATES.SCANNER) {
                            document.getElementById('videoDebugInfo').innerHTML = 
                                '<span style="color: #4ecdc4;">üîç Scanning for QR codes...</span>';
                        }
                    }, 2000);
                }
            }
            
            extractPokemonNumber(data) {
                // Handle various QR code formats
                console.log('Parsing QR data:', data);
                
                // Direct number
                if (/^\d+$/.test(data)) {
                    return parseInt(data);
                }
                
                // Pokemon:123 format
                if (data.toLowerCase().includes('pokemon')) {
                    const match = data.match(/pokemon[:\s]*(\d+)/i);
                    if (match) return parseInt(match[1]);
                }
                
                // Extract any number from the string
                const numberMatch = data.match(/(\d+)/);
                if (numberMatch) {
                    return parseInt(numberMatch[1]);
                }
                
                return null;
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üéÆ Pokemon Scanner - Starting...');
            
            // Show scanner UI initially
            showUIState(UI_STATES.SCANNER);
            
            // Initialize QR scanner
            qrScanner = new QRScanner();
        });
    </script>
</body>
</html>
