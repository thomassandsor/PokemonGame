<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catch Pokemon - QR Scanner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
    <style>
        .scanner-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 20px 0;
        }
        
        .scanner-card {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .scanner-header {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .scanner-content {
            padding: 30px;
        }
        
        #video {
            width: 100%;
            max-width: 400px;
            height: 300px;
            border: 3px solid #007bff;
            border-radius: 10px;
            background: #000;
        }
        
        .scan-result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .scan-result.error {
            border-left-color: #dc3545;
            background: #f8d7da;
        }
        
        .pokemon-preview {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            text-align: center;
        }
        
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        
        .btn-scanner {
            margin: 5px;
            min-width: 120px;
        }
        
        .camera-select {
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="scanner-container">
        <div class="scanner-card">
            <div class="scanner-header">
                <h1><i class="fas fa-qrcode"></i> Catch Pokemon</h1>
                <p class="mb-0">Scan Pokemon QR codes to add them to your collection!</p>
            </div>
            
            <div class="scanner-content">
                <!-- Camera Selection -->
                <div class="camera-select">
                    <label for="cameraSelect" class="form-label">Select Camera:</label>
                    <select id="cameraSelect" class="form-select">
                        <option value="">Loading cameras...</option>
                    </select>
                </div>
                
                <!-- Controls -->
                <div class="controls">
                    <button id="startBtn" class="btn btn-success btn-scanner">
                        <i class="fas fa-play"></i> Start Scanner
                    </button>
                    <button id="stopBtn" class="btn btn-danger btn-scanner" disabled>
                        <i class="fas fa-stop"></i> Stop Scanner
                    </button>
                </div>
                
                <!-- Video Element for Camera -->
                <div class="text-center">
                    <video id="video" autoplay muted playsinline></video>
                </div>
                
                <!-- Scan Results -->
                <div id="scanResult" class="scan-result" style="display: none;">
                    <h5><i class="fas fa-check-circle"></i> QR Code Detected!</h5>
                    <p><strong>Pokemon Number:</strong> <span id="pokemonNumber"></span></p>
                    <p><strong>Raw Data:</strong> <span id="rawData"></span></p>
                </div>
                
                <!-- Error Display -->
                <div id="errorResult" class="scan-result error" style="display: none;">
                    <h5><i class="fas fa-exclamation-triangle"></i> Error</h5>
                    <p id="errorMessage"></p>
                </div>
                
                <!-- Pokemon Preview (for future use) -->
                <div id="pokemonPreview" class="pokemon-preview" style="display: none;">
                    <h4>ðŸŽ‰ Pokemon Found!</h4>
                    <p>Pokemon #<span id="previewNumber"></span></p>
                    <button class="btn btn-light btn-lg">Catch This Pokemon!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Include jsQR library for QR code scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <!-- Include Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Include Auth Service -->
    <script src="auth.js"></script>
    
    <script>
        class QRScanner {
            constructor() {
                this.video = document.getElementById('video');
                this.canvas = document.createElement('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.scanning = false;
                this.stream = null;
                this.cameras = [];
                this.currentCamera = null;
                
                this.initializeScanner();
            }
            
            async initializeScanner() {
                console.log('ðŸŽ® Initializing QR Scanner...');
                
                // Wait a moment for AuthService to restore session
                console.log('AUTH: Waiting for session restoration...');
                await AuthService.restoreAuthFromSession();
                
                // Check authentication
                console.log('AUTH: Checking authentication status...');
                console.log('AUTH: isAuthenticated():', AuthService.isAuthenticated());
                console.log('AUTH: getCurrentUser():', AuthService.getCurrentUser());
                
                if (!AuthService.isAuthenticated()) {
                    console.log('User not authenticated, redirecting to login');
                    window.location.href = '/index.html';
                    return;
                }
                
                console.log('âœ… User authenticated, proceeding with scanner setup...');
                
                // Set up event listeners
                document.getElementById('startBtn').addEventListener('click', () => this.startScanning());
                document.getElementById('stopBtn').addEventListener('click', () => this.stopScanning());
                document.getElementById('cameraSelect').addEventListener('change', (e) => this.switchCamera(e.target.value));
                
                // Get available cameras
                await this.loadCameras();
            }
            
            async loadCameras() {
                try {
                    console.log('ðŸ“· Loading available cameras...');
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    this.cameras = devices.filter(device => device.kind === 'videoinput');
                    
                    const cameraSelect = document.getElementById('cameraSelect');
                    cameraSelect.innerHTML = '';
                    
                    if (this.cameras.length === 0) {
                        cameraSelect.innerHTML = '<option value="">No cameras found</option>';
                        this.showError('No cameras found on this device');
                        return;
                    }
                    
                    this.cameras.forEach((camera, index) => {
                        const option = document.createElement('option');
                        option.value = camera.deviceId;
                        option.textContent = camera.label || `Camera ${index + 1}`;
                        cameraSelect.appendChild(option);
                    });
                    
                    // Select the back camera if available (usually better for QR scanning)
                    const backCamera = this.cameras.find(camera => 
                        camera.label.toLowerCase().includes('back') || 
                        camera.label.toLowerCase().includes('rear')
                    );
                    
                    if (backCamera) {
                        cameraSelect.value = backCamera.deviceId;
                        this.currentCamera = backCamera.deviceId;
                    } else {
                        this.currentCamera = this.cameras[0].deviceId;
                    }
                    
                    console.log(`ðŸ“· Found ${this.cameras.length} cameras`);
                } catch (error) {
                    console.error('Error loading cameras:', error);
                    this.showError('Failed to access cameras. Please allow camera permissions.');
                }
            }
            
            async startScanning() {
                try {
                    console.log('ðŸ“± Starting QR scanner...');
                    
                    const constraints = {
                        video: {
                            deviceId: this.currentCamera ? { exact: this.currentCamera } : undefined,
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: this.currentCamera ? undefined : { ideal: 'environment' }
                        }
                    };
                    
                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.video.srcObject = this.stream;
                    
                    this.scanning = true;
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    
                    // Start the scanning loop
                    this.video.addEventListener('loadedmetadata', () => {
                        this.canvas.width = this.video.videoWidth;
                        this.canvas.height = this.video.videoHeight;
                        this.scanLoop();
                    });
                    
                    this.hideError();
                    this.hideResult();
                    
                } catch (error) {
                    console.error('Error starting scanner:', error);
                    this.showError('Failed to start camera. Please check permissions and try again.');
                }
            }
            
            stopScanning() {
                console.log('â¹ï¸ Stopping QR scanner...');
                
                this.scanning = false;
                
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                this.video.srcObject = null;
                
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
            }
            
            switchCamera(deviceId) {
                console.log('ðŸ”„ Switching camera:', deviceId);
                this.currentCamera = deviceId;
                
                if (this.scanning) {
                    this.stopScanning();
                    setTimeout(() => this.startScanning(), 500);
                }
            }
            
            scanLoop() {
                if (!this.scanning) return;
                
                if (this.video.readyState === this.video.HAVE_ENOUGH_DATA) {
                    this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                    const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                    
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        console.log('ðŸ“± QR Code detected:', code.data);
                        this.handleQRCode(code.data);
                    }
                }
                
                if (this.scanning) {
                    requestAnimationFrame(() => this.scanLoop());
                }
            }
            
            handleQRCode(data) {
                console.log('ðŸŽ¯ Processing QR code:', data);
                
                // Extract pokemon number from QR data
                const pokemonNumber = this.extractPokemonNumber(data);
                
                if (pokemonNumber) {
                    this.showResult(pokemonNumber, data);
                    // Stop scanning after successful scan
                    this.stopScanning();
                } else {
                    this.showError('Invalid Pokemon QR code format');
                }
            }
            
            extractPokemonNumber(data) {
                // Try to extract number from QR data
                // Assume QR contains just a number, or in format like "pokemon:123"
                
                // If it's just a number
                if (/^\d+$/.test(data)) {
                    return parseInt(data);
                }
                
                // If it's in format "pokemon:123" or "123" or similar
                const match = data.match(/(\d+)/);
                if (match) {
                    return parseInt(match[1]);
                }
                
                return null;
            }
            
            showResult(pokemonNumber, rawData) {
                document.getElementById('pokemonNumber').textContent = pokemonNumber;
                document.getElementById('rawData').textContent = rawData;
                document.getElementById('scanResult').style.display = 'block';
                document.getElementById('errorResult').style.display = 'none';
                
                // Show pokemon preview for future use
                document.getElementById('previewNumber').textContent = pokemonNumber;
                document.getElementById('pokemonPreview').style.display = 'block';
                
                console.log(`âœ… Pokemon #${pokemonNumber} detected!`);
            }
            
            showError(message) {
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('errorResult').style.display = 'block';
                document.getElementById('scanResult').style.display = 'none';
            }
            
            hideError() {
                document.getElementById('errorResult').style.display = 'none';
            }
            
            hideResult() {
                document.getElementById('scanResult').style.display = 'none';
                document.getElementById('pokemonPreview').style.display = 'none';
            }
        }
        
        // Initialize the scanner when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new QRScanner();
        });
    </script>
</body>
</html>
