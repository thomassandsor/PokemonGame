<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Winner Lookup Test - FINAL</title>
</head>
<body>
    <h1>Simple Winner Lookup Field Test - FINAL</h1>
    <p>Testing direct update of winner pokemon lookup field using correct schema name</p>
    
    <div>
        <label>Auth Token:</label><br>
        <input type="text" id="authToken" placeholder="Paste auth token here" style="width: 500px;">
        <p><small>Get token from browser console: <code>AuthService.getCurrentUser().token</code></small></p>
    </div>
    
    <button onclick="testWinnerUpdate()">Test Winner Pokemon Update (FINAL)</button>
    <div id="results"></div>

    <script>
        async function testWinnerUpdate() {
            const results = document.getElementById('results');
            results.innerHTML = '<h2>Testing Winner Pokemon Lookup Update...</h2>';
            
            try {
                // Get token from input
                const token = document.getElementById('authToken').value.trim();
                
                if (!token) {
                    results.innerHTML += '<p>‚ùå Please enter auth token</p>';
                    return;
                }
                
                results.innerHTML += '<p>‚úÖ Using provided token (length: ' + token.length + ')</p>';
                
                // Use the known battle ID
                const battleId = '34db8361-4a72-f011-b4cb-7c1e5250e283';
                
                // Use Player 1's Pokemon ID as the winner (hardcoded from the battle data we saw)
                const winnerPokemonId = 'f5ef02ae-9568-f011-bec1-7c1e5250e283';
                
                results.innerHTML += `<p>üéØ Battle ID: ${battleId}</p>`;
                results.innerHTML += `<p>üèÜ Setting winner to Pokemon ID: ${winnerPokemonId}</p>`;
                
                const baseUrl = 'https://pokemongame-functions-2025.azurewebsites.net/api/dataverse';
                const url = `${baseUrl}/pokemon_battles(${battleId})`;
                
                results.innerHTML += '<p>üåê URL: ' + url + '</p>';
                
                // Use the CORRECT schema name from Dataverse: pokemon_WinnerPokemon
                const updateData = {
                    'pokemon_WinnerPokemon@odata.bind': `/pokemon_pokedexes(${winnerPokemonId})`
                };
                
                results.innerHTML += '<p>üì§ Update data: ' + JSON.stringify(updateData) + '</p>';
                
                const response = await fetch(url, {
                    method: 'PATCH',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'X-User-Email': 'sandsor@outlook.com'
                    },
                    body: JSON.stringify(updateData)
                });
                
                results.innerHTML += '<p>üì° Response status: ' + response.status + '</p>';
                
                if (response.ok) {
                    results.innerHTML += '<p>‚úÖ SUCCESS! Winner pokemon lookup updated with correct schema name!</p>';
                    
                    // Now verify by reading the battle back
                    const verifyResponse = await fetch(url, {
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'X-User-Email': 'sandsor@outlook.com'
                        }
                    });
                    
                    if (verifyResponse.ok) {
                        const battle = await verifyResponse.json();
                        results.innerHTML += '<p>üîç Verification - Winner pokemon value: ' + battle._pokemon_winnerpokemon_value + '</p>';
                        results.innerHTML += '<p>üéâ FIELD UPDATE SUCCESSFUL!</p>';
                    }
                    
                } else {
                    const errorText = await response.text();
                    results.innerHTML += '<p>‚ùå FAILED: ' + response.status + '</p>';
                    results.innerHTML += '<pre>' + errorText + '</pre>';
                }
                
            } catch (error) {
                results.innerHTML += '<p>‚ùå ERROR: ' + error.message + '</p>';
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
