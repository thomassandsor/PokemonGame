<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle System Final Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Battle System Final Test</h1>
    <p>Testing the complete battle system with verified database field names</p>
    
    <div class="test-section">
        <h3>Test 1: Winner Lookup Field Update</h3>
        <div>
            <label>Auth Token:</label><br>
            <input type="text" id="authToken" placeholder="Paste auth token here" style="width: 500px;">
            <p><small>Get token from browser console: <code>AuthService.getCurrentUser().token</code></small></p>
        </div>
        <button onclick="testWinnerField()">Test Winner Field Update</button>
        <div id="winnerResults"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 2: Battle Completion Flow</h3>
        <p>This test simulates the complete battle completion process including winner/loser updates</p>
        <button onclick="testBattleCompletion()">Test Full Battle Completion</button>
        <div id="battleResults"></div>
    </div>

    <script>
        async function testWinnerField() {
            const results = document.getElementById('winnerResults');
            results.innerHTML = '<h4>Testing Winner Field Update...</h4>';
            
            try {
                const token = document.getElementById('authToken').value.trim();
                if (!token) {
                    results.innerHTML += '<p class="error">‚ùå Please enter auth token</p>';
                    return;
                }
                
                const battleId = '34db8361-4a72-f011-b4cb-7c1e5250e283';
                const winnerPokemonId = 'f5ef02ae-9568-f011-bec1-7c1e5250e283';
                
                results.innerHTML += `<p class="info">üéØ Battle ID: ${battleId}</p>`;
                results.innerHTML += `<p class="info">üèÜ Winner Pokemon ID: ${winnerPokemonId}</p>`;
                
                const baseUrl = 'https://pokemongame-functions-2025.azurewebsites.net/api/dataverse';
                const url = `${baseUrl}/pokemon_battles(${battleId})`;
                
                const updateData = {
                    'pokemon_WinnerPokemon@odata.bind': `/pokemon_pokedexes(${winnerPokemonId})`,
                    'pokemon_LooserPokemon@odata.bind': `/pokemon_pokedexes(f5ef02ae-9568-f011-bec1-7c1e5250e283)`
                };
                
                results.innerHTML += '<p class="info">üì§ Update data: ' + JSON.stringify(updateData, null, 2) + '</p>';
                
                const response = await fetch(url, {
                    method: 'PATCH',
                    mode: 'cors',
                    credentials: 'omit',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                        'X-User-Email': 'sandsor@outlook.com'
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    results.innerHTML += '<p class="success">‚úÖ SUCCESS! Winner/Loser pokemon fields updated!</p>';
                    
                    // Verify by reading back
                    const verifyResponse = await fetch(url, {
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'X-User-Email': 'sandsor@outlook.com'
                        }
                    });
                    
                    if (verifyResponse.ok) {
                        const battle = await verifyResponse.json();
                        results.innerHTML += '<pre>' + JSON.stringify({
                            winner_pokemon_value: battle._pokemon_winnerpokemon_value,
                            looser_pokemon_value: battle._pokemon_looserpokemon_value
                        }, null, 2) + '</pre>';
                    }
                } else {
                    const errorText = await response.text();
                    results.innerHTML += '<p class="error">‚ùå FAILED: ' + response.status + '</p>';
                    results.innerHTML += '<pre>' + errorText + '</pre>';
                }
                
            } catch (error) {
                results.innerHTML += '<p class="error">‚ùå ERROR: ' + error.message + '</p>';
            }
        }
        
        async function testBattleCompletion() {
            const results = document.getElementById('battleResults');
            results.innerHTML = '<h4>Testing Battle Completion Flow...</h4>';
            
            try {
                const token = document.getElementById('authToken').value.trim();
                if (!token) {
                    results.innerHTML += '<p class="error">‚ùå Please enter auth token first</p>';
                    return;
                }
                
                results.innerHTML += '<p class="info">üîê Using provided token...</p>';
                
                // Mock battle result data
                const mockBattleResult = {
                    metadata: { battle_id: '34db8361-4a72-f011-b4cb-7c1e5250e283' },
                    final_result: {
                        winner: "Player 1",
                        winner_pokemon_id: "f5ef02ae-9568-f011-bec1-7c1e5250e283",
                        loser_pokemon_id: "f5ef02ae-9568-f011-bec1-7c1e5250e283",
                        player1_final_hp: 25,
                        player1_max_hp: 50,
                        player2_final_hp: 0,
                        player2_max_hp: 45
                    },
                    pokemon_teams: {
                        player1_team: [{ name: "Test Pokemon 1", max_hp: 50 }],
                        player2_team: [{ name: "Test Pokemon 2", max_hp: 45 }]
                    }
                };
                
                results.innerHTML += '<p class="info">üìä Created mock battle result data</p>';
                
                // Test if BattleChallengeService is available
                if (typeof BattleChallengeService === 'undefined') {
                    results.innerHTML += '<p class="error">‚ùå BattleChallengeService not loaded. Load battle-challenge-service.js first.</p>';
                    return;
                }
                
                results.innerHTML += '<p class="info">üîÑ Calling BattleChallengeService.completeBattle()...</p>';
                
                // Call the actual battle completion service
                const result = await BattleChallengeService.completeBattle(
                    '34db8361-4a72-f011-b4cb-7c1e5250e283',
                    mockBattleResult
                );
                
                if (result.success) {
                    results.innerHTML += '<p class="success">‚úÖ SUCCESS! Battle completion with winner/loser updates completed!</p>';
                    results.innerHTML += '<p class="info">üéâ The battle system is now fully functional with correct database field names!</p>';
                } else {
                    results.innerHTML += '<p class="error">‚ùå Battle completion returned unsuccessful result</p>';
                }
                
            } catch (error) {
                results.innerHTML += '<p class="error">‚ùå ERROR in battle completion: ' + error.message + '</p>';
                console.error('Battle completion error:', error);
            }
        }
    </script>
</body>
</html>
