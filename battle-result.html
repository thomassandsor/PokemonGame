<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Battle Result - Pokemon Game</title>
    <link rel="stylesheet" href="styles/pokemon-design-system.css">
    <style>
        /* Battle Result Specific Styles - Mobile First */
        
        .battle-result-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 10px;
        }

        @media (min-width: 768px) {
            .battle-result-container {
                padding: 20px;
            }
        }

        /* Winner announcement - Mobile optimized */
        .winner-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin: 10px auto;
            padding: 20px;
            text-align: center;
            max-width: 100%;
            animation: slideInUp 0.6s ease-out;
        }

        @media (min-width: 768px) {
            .winner-card {
                margin: 20px auto;
                padding: 30px;
                max-width: 1200px;
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .winner-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .winner-icon {
            font-size: 3rem;
        }

        .winner-content h2 {
            margin: 0;
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 700;
            animation: bounce 0.8s ease-out 0.3s both;
        }

        @media (min-width: 768px) {
            .winner-content h2 {
                font-size: 2rem;
            }
        }

        .winner-content p {
            margin: 0;
            color: #6b7280;
            font-size: 1rem;
        }

        @media (min-width: 768px) {
            .winner-content p {
                font-size: 1.1rem;
            }
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translateY(0);
            }
            40%, 43% {
                transform: translateY(-10px);
            }
            70% {
                transform: translateY(-5px);
            }
        }

        /* Pokemon comparison layout - Mobile responsive */
        .pokemon-comparison {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 15px 0;
        }

        @media (min-width: 768px) {
            .pokemon-comparison {
                display: grid;
                grid-template-columns: 1fr auto 1fr;
                gap: 20px;
                align-items: center;
                margin: 20px 0;
            }
        }

        .vs-divider {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
            order: -1; /* Show VS first on mobile */
        }

        @media (min-width: 768px) {
            .vs-divider {
                min-height: 100px;
                order: 0; /* Normal order on desktop */
            }
        }

        .vs-text {
            font-size: 1.5rem;
            font-weight: 900;
            color: #ef4444;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            animation: pulse 2s infinite;
        }

        @media (min-width: 768px) {
            .vs-text {
                font-size: 2rem;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        /* Section cards - Mobile first */
        .section-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin: 15px 0;
            padding: 16px;
            animation: fadeInUp 0.6s ease-out;
        }

        @media (min-width: 768px) {
            .section-card {
                margin: 20px 0;
                padding: 24px;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .section-card h3 {
            margin: 0 0 15px 0;
            color: #1f2937;
            font-size: 1.25rem;
            font-weight: 600;
        }

        @media (min-width: 768px) {
            .section-card h3 {
                margin: 0 0 20px 0;
                font-size: 1.5rem;
            }
        }

        /* Enhanced replay display */
        .replay-display {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 15px;
            min-height: 200px;
            border: 2px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .replay-display {
                padding: 20px;
                min-height: 300px;
            }
        }

        .replay-step {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            animation: slideInLeft 0.5s ease-out;
        }

        @media (min-width: 768px) {
            .replay-step {
                padding: 20px;
                margin-bottom: 15px;
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .turn-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
            flex-wrap: nowrap;
            gap: 8px;
        }

        .turn-header .pokemon-btn {
            padding: 4px 8px;
            font-size: 0.8rem;
            min-width: 60px;
            flex-shrink: 0;
        }

        .pokemon-btn.btn-primary {
            background: #16a34a;
            color: white;
            border-color: #16a34a;
        }

        .pokemon-btn.btn-primary:hover {
            background: #15803d;
            border-color: #15803d;
        }

        .turn-number {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
            background: transparent;
            padding: 4px 12px;
            border-radius: 20px;
            min-width: fit-content;
        }

        @media (min-width: 768px) {
            .turn-number {
                font-size: 1.2rem;
                padding: 6px 16px;
            }
        }

        .hp-status {
            display: flex;
            gap: 10px;
            font-size: 0.9rem;
            color: #6b7280;
            flex-wrap: wrap;
        }

        @media (min-width: 768px) {
            .hp-status {
                font-size: 1rem;
                gap: 15px;
            }
        }

        /* Pokemon action cards in replay */
        .action-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
        }

        @media (min-width: 768px) {
            .action-cards {
                flex-direction: row;
                gap: 20px;
            }
        }

        @media (min-width: 1200px) {
            .action-cards {
                gap: 24px;
            }
        }

        .action-card {
            border-radius: 12px;
            padding: 16px;
            border: 1px solid #e2e8f0;
            flex: 1;
            min-height: 120px;
            position: relative;
            backdrop-filter: blur(10px);
        }

        @media (min-width: 768px) {
            .action-card {
                padding: 20px;
                min-height: 140px;
            }
        }

        @media (min-width: 1200px) {
            .action-card {
                padding: 24px;
                min-height: 160px;
            }
        }

        .action-card.player1 {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(16, 185, 129, 0.04) 100%);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .action-card.player2 {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(245, 158, 11, 0.04) 100%);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .action-header {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
            font-size: 1rem;
            padding: 8px 12px;
            border-radius: 8px;
            display: inline-block;
        }

        .action-card.player1 .action-header {
            background: rgba(16, 185, 129, 0.15);
            color: #065f46;
        }

        .action-card.player2 .action-header {
            background: rgba(245, 158, 11, 0.15);
            color: #92400e;
        }

        @media (min-width: 768px) {
            .action-header {
                font-size: 1.1rem;
                margin-bottom: 10px;
            }
        }

        .action-details {
            font-size: 0.9rem;
            color: #374151;
            line-height: 1.5;
            margin-top: 8px;
        }

        .action-details strong {
            color: #1f2937;
            font-weight: 600;
        }

        @media (min-width: 768px) {
            .action-details {
                font-size: 0.95rem;
            }
        }

        .damage-indicator {
            background: #fef2f2;
            color: #dc2626;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-block;
            margin: 4px 0;
            border: 1px solid #fecaca;
        }

        .critical-hit {
            background: #fef3c7;
            color: #d97706;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
            display: inline-block;
            margin: 2px 0;
        }

        .type-effective {
            background: #ecfdf5;
            color: #059669;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
            display: inline-block;
            margin: 2px 0;
        }

        .type-ineffective {
            background: #f3f4f6;
            color: #6b7280;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
            display: inline-block;
            margin: 2px 0;
        }

        /* Pokemon HP bars */
        .pokemon-hp-display {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid #e2e8f0;
        }

        .pokemon-hp-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            gap: 10px;
            flex-wrap: wrap;
        }

        @media (min-width: 768px) {
            .pokemon-hp-row {
                flex-wrap: nowrap;
                gap: 15px;
            }
        }

        .pokemon-hp-row:last-child {
            margin-bottom: 0;
        }

        .pokemon-hp-info {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }

        @media (min-width: 768px) {
            .pokemon-hp-info {
                min-width: 150px;
            }
        }

        .pokemon-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.9rem;
        }

        @media (min-width: 768px) {
            .pokemon-name {
                font-size: 1rem;
            }
        }

        .pokemon-trainer {
            font-size: 0.8rem;
            color: #6b7280;
        }

        @media (min-width: 768px) {
            .pokemon-trainer {
                font-size: 0.9rem;
            }
        }

        .hp-bar-container {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        @media (min-width: 768px) {
            .hp-bar-container {
                gap: 10px;
            }
        }

        .hp-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            flex: 1;
            min-width: 80px;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            .hp-bar {
                height: 10px;
                min-width: 120px;
            }
        }

        .hp-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease, background-color 0.3s ease;
        }

        .hp-high {
            background: linear-gradient(90deg, #10b981, #34d399);
        }

        .hp-medium {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .hp-low {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .hp-text {
            font-size: 0.8rem;
            font-weight: 600;
            color: #374151;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .hp-text {
                font-size: 0.9rem;
            }
        }

        .turn-summary-footer {
            background: #f1f5f9;
            padding: 10px;
            border-radius: 6px;
            margin-top: 12px;
            font-size: 0.9rem;
            color: #1f2937;
            text-align: center;
        }

        .battle-start-info, .battle-end-info {
            text-align: center;
            padding: 10px 0;
        }

        .battle-start-info h4, .battle-end-info h4 {
            margin: 0 0 10px 0;
            color: #1f2937;
            font-size: 1.1rem;
        }

        @media (min-width: 768px) {
            .battle-start-info h4, .battle-end-info h4 {
                font-size: 1.2rem;
            }
        }

        .pokemon-intro, .victory-details {
            background: #f8fafc;
            padding: 8px;
            border-radius: 6px;
            margin-top: 10px;
        }

        .pokemon-intro div, .victory-details div {
            padding: 2px 0;
            font-size: 0.9rem;
        }

        /* Mobile-specific Pokemon card overrides */
        @media (max-width: 767px) {
            .pokemon-card {
                margin: 10px 0;
                padding: 15px !important;
            }
            
            .pokemon-sprite-container {
                height: 80px !important;
            }
            
            .pokemon-sprite {
                width: 80px !important;
                height: 80px !important;
            }
            
            .trainer-name {
                font-size: 0.9rem !important;
            }
            
            .pokemon-name {
                font-size: 1.1rem !important;
            }
            
            .pokemon-stats {
                font-size: 0.85rem !important;
            }
        }

        /* Loading and error states - Mobile optimized */
        .loading-card, .error-card {
            margin: 15px;
            padding: 20px;
        }

        @media (min-width: 768px) {
            .loading-card, .error-card {
                margin: 30px auto;
                padding: 40px;
            }
        }

        /* Compact Pokemon Display for Battle Replay */
        .battle-pokemon-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            gap: 10px;
        }

        .compact-pokemon-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            flex: 1;
            max-width: 45%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 2px solid #e5e7eb;
            text-align: center;
        }

        .compact-pokemon-card.player1 {
            border-color: #10b981;
        }

        .compact-pokemon-card.player2 {
            border-color: #f59e0b;
        }

        .compact-pokemon-sprite {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin: 0 auto 8px;
            display: block;
        }

        .compact-pokemon-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .compact-trainer-name {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .compact-hp-bar {
            background: #e5e7eb;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .compact-hp-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease, background-color 0.3s ease;
        }

        .compact-hp-text {
            font-size: 0.75rem;
            font-weight: 600;
            color: #374151;
        }

        .vs-divider-compact {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
        }

        .vs-text-small {
            font-size: 1.2rem;
            font-weight: 900;
            color: #ef4444;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            animation: pulse 2s infinite;
        }

        /* Mobile optimizations */
        @media (max-width: 480px) {
            .battle-pokemon-display {
                padding: 10px;
                gap: 8px;
            }
            
            .compact-pokemon-card {
                padding: 8px;
                max-width: 42%;
            }
            
            .compact-pokemon-sprite {
                width: 50px;
                height: 50px;
            }
            
            .compact-pokemon-name {
                font-size: 0.8rem;
            }
            
            .compact-trainer-name {
                font-size: 0.7rem;
            }
            
            .vs-text-small {
                font-size: 1rem;
            }
        }

        /* Auto-replay notification */
        .auto-replay-notification {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            font-size: 0.9rem;
            animation: slideInDown 0.5s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Battle log */
        /* Battle log - Mobile optimized */
        .battle-log {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            max-height: 250px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            line-height: 1.4;
            border: 1px solid #e5e7eb;
        }

        @media (min-width: 768px) {
            .battle-log {
                padding: 15px;
                max-height: 300px;
                font-size: 0.9rem;
                line-height: 1.5;
            }
        }

        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid #e5e7eb;
            word-wrap: break-word;
        }

        @media (min-width: 768px) {
            .log-entry {
                padding: 4px 0;
            }
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        /* Action buttons - Mobile optimized */
        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        @media (min-width: 768px) {
            .action-buttons {
                gap: 12px;
                margin: 20px 0;
            }
        }

        /* Replay controls - Touch friendly */
        .replay-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            gap: 8px;
            flex-wrap: wrap;
        }

        @media (min-width: 768px) {
            .replay-controls {
                padding: 15px;
                margin-bottom: 20px;
                gap: 12px;
                flex-wrap: nowrap;
            }
        }

        .replay-controls button {
            min-height: 44px; /* Touch-friendly size */
            font-size: 0.9rem;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .replay-controls button {
                font-size: 1rem;
                padding: 10px 16px;
            }
        }

        .replay-controls button:hover {
            background: #f3f4f6;
            transform: translateY(-1px);
        }

        .replay-controls button:active {
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .replay-controls button.btn-primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .replay-controls button.btn-primary:hover {
            background: #2563eb;
        }

        .turn-indicator {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.9rem;
            text-align: center;
            min-width: 80px;
        }

        @media (min-width: 768px) {
            .turn-indicator {
                font-size: 1rem;
                min-width: 100px;
            }
        }
        .replay-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .turn-indicator {
            background: #6b7280;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .replay-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        /* Loading and error states */
        .loading-state {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 60px 20px;
        }

        .pokemon-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .pokemon-spinner img {
            display: block;
            margin: 0 auto;
        }

        .pokeball-bounce {
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 30% 30%, #ffffff, #ff4444 50%, #333333 50%, #ffffff);
            border-radius: 50%;
            margin: 0 auto 15px;
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            60% { transform: translateY(-10px); }
        }

        .error-card {
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .error-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .error-icon {
            font-size: 2rem;
            color: #ef4444;
        }

        .error-content p {
            margin: 0;
            color: #dc2626;
        }

        .winner-badge {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* Home button in header */
        .pokemon-home-btn {
            position: absolute;
            top: 50%;
            left: 15px;
            transform: translateY(-50%);
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(59, 130, 246, 0.4);
            text-decoration: none;
            z-index: 10;
        }

        .pokemon-home-btn:hover {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.6);
        }

        .pokemon-home-btn:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* Make sure header has relative positioning for absolute positioning of home button */
        .pokemon-header {
            position: relative;
        }

        @media (max-width: 768px) {
            .pokemon-home-btn {
                width: 40px;
                height: 40px;
                font-size: 1rem;
                left: 10px;
            }
        }

        /* Pokemon card specific styles */
        .pokemon-sprite {
            width: 96px;
            height: 96px;
            object-fit: contain;
            margin: 0 auto;
        }

        .pokemon-sprite-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 96px;
            margin: 10px 0;
        }

        .trainer-name {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            text-align: center;
        }

        .pokemon-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
            text-align: center;
            margin: 8px 0;
        }

        .pokemon-level {
            font-size: 0.9rem;
            color: #6b7280;
            text-align: center;
            margin: 4px 0;
        }

        .pokemon-hp {
            margin: 12px 0;
        }

        .hp-label {
            font-size: 0.9rem;
            color: #374151;
            text-align: center;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .hp-bar {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin: 0 auto;
            max-width: 200px;
        }

        .hp-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .hp-high { background: #10b981; }
        .hp-medium { background: #f59e0b; }
        .hp-low { background: #ef4444; }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .pokemon-comparison {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .vs-divider {
                transform: rotate(90deg);
                min-height: auto;
            }
            
            .vs-text {
                font-size: 1.5rem;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .replay-controls {
                flex-direction: column;
                gap: 8px;
            }
        }

        /* Advanced Replay Styles */
        .replay-turn-display {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }

        .turn-summary {
            text-align: center;
            margin-bottom: 20px;
        }

        .turn-summary h5 {
            margin: 0 0 10px 0;
            color: #1f2937;
            font-size: 1.3rem;
        }

        .turn-actions {
            background: white;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
        }

        .action-row {
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.95rem;
        }

        .action-row:last-child {
            border-bottom: none;
        }

        .turn-result {
            background: #e0f2fe;
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-size: 0.95rem;
            color: #0f4c75;
        }

        .pokemon-hp-display {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .pokemon-hp-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
            gap: 15px;
        }

        .pokemon-hp-info {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }

        .pokemon-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 1rem;
        }

        .pokemon-trainer {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .hp-bar-container {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .hp-bar {
            flex: 1;
            background: #e5e7eb;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
            max-width: 200px;
        }

        .hp-text {
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
            min-width: 60px;
            text-align: right;
        }

        /* Mobile responsive for replay */
        @media (max-width: 768px) {
            .pokemon-hp-row {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }
            
            .hp-bar-container {
                justify-content: space-between;
            }
            
            .hp-bar {
                max-width: none;
            }
        }
    </style>
</head>
<body class="pokemon-game-body">
    <div class="battle-result-container">
        <!-- Clean Header -->
        <header class="pokemon-header">
            <a href="index.html" class="pokemon-home-btn" title="Home">
                üè†
            </a>
            <div class="pokemon-header-content">
                <div class="arena-logo">üèÜ</div>
                <h1 class="pokemon-title">Battle Result</h1>
                <div class="trainer-info">
                    <div class="trainer-name" id="trainerName">Battle Complete!</div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="pokemon-content">
            <div class="content-container">
                <!-- Loading State -->
                <div id="loading" class="loading-state">
                    <div class="pokemon-spinner">
                        <img src="assets/pokeball.svg" alt="Loading..." style="width: 48px; height: 48px; animation: spin 1s linear infinite;">
                    </div>
                </div>
                
                <!-- Error State -->
                <div id="error" class="error-card" style="display: none;">
                    <div class="error-content">
                        <div class="error-icon">‚ö†Ô∏è</div>
                        <p id="error-message"></p>
                        <button class="pokemon-btn btn-outline" onclick="window.history.back()">‚Üê Go Back</button>
                    </div>
                </div>
                
                <!-- Battle Result Content -->
                <div id="result-content" style="display: none;">
                    <!-- Battle Replay (Main Focus) -->
                    <div id="battle-replay" class="section-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0;">üìΩÔ∏è Battle Replay</h3>
                            <span class="turn-indicator" id="turn-indicator">Turn 0/0</span>
                        </div>
                        
                        <!-- Pokemon Battle Comparison (Compact for Mobile) -->
                        <div class="battle-pokemon-display">
                            <div class="compact-pokemon-card" id="player1-compact">
                                <!-- Player 1 compact info -->
                            </div>
                            <div class="vs-divider-compact">
                                <div class="vs-text-small">VS</div>
                            </div>
                            <div class="compact-pokemon-card" id="player2-compact">
                                <!-- Player 2 compact info -->
                            </div>
                        </div>
                        
                        <div id="replay-display" class="replay-display">
                            <!-- Replay content will be shown here -->
                        </div>
                    </div>
                    
                    <!-- Winner Announcement (Initially Hidden) -->
                    <div id="winner-announcement" class="winner-card" style="display: none;">
                        <!-- Winner info will be loaded here -->
                    </div>
                    
                    <!-- Battle Actions -->
                    <div class="action-buttons">
                        <a href="index.html" class="pokemon-btn btn-outline">
                            üè† Home
                        </a>
                        <a href="battle-arena.html" class="pokemon-btn btn-success">
                            ‚öîÔ∏è Back to Arena
                        </a>
                        <a href="pokemon-unified.html?view=my" class="pokemon-btn btn-outline">
                            üë• My Pokemon
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="auth.js"></script>
    <script src="portal-settings-service.js"></script>
    <script src="battle-challenge-service.js"></script>
    <script src="battle-simulation-service.js"></script>
    <script>
        class BattleResult {
            constructor() {
                this.battleId = this.getBattleIdFromUrl();
                this.battleData = null;
                this.replayData = null;
                this.currentStep = 0;
                this.autoReplayInterval = null;
                this.isReplayVisible = false;
                
                this.init();
            }
            
            getBattleIdFromUrl() {
                const urlParams = new URLSearchParams(window.location.search);
                // Support both 'id' and 'battleId' parameters for flexibility
                return urlParams.get('id') || urlParams.get('battleId');
            }
            
            // Convert Pokemon name to sprite ID for PokeAPI
            getPokemonSpriteId(pokemonName) {
                if (!pokemonName) return '1'; // Default to Bulbasaur
                
                // Basic Pokemon name to ID mapping for common Pokemon
                const pokemonMap = {
                    'bulbasaur': '1', 'ivysaur': '2', 'venusaur': '3',
                    'charmander': '4', 'charmeleon': '5', 'charizard': '6',
                    'squirtle': '7', 'wartortle': '8', 'blastoise': '9',
                    'caterpie': '10', 'metapod': '11', 'butterfree': '12',
                    'weedle': '13', 'kakuna': '14', 'beedrill': '15',
                    'pidgey': '16', 'pidgeotto': '17', 'pidgeot': '18',
                    'rattata': '19', 'raticate': '20', 'spearow': '21',
                    'fearow': '22', 'ekans': '23', 'arbok': '24',
                    'pikachu': '25', 'raichu': '26', 'sandshrew': '27',
                    'sandslash': '28', 'nidoran-f': '29', 'nidorina': '30',
                    'nidoqueen': '31', 'nidoran-m': '32', 'nidorino': '33',
                    'nidoking': '34', 'clefairy': '35', 'clefable': '36',
                    'vulpix': '37', 'ninetales': '38', 'jigglypuff': '39',
                    'wigglytuff': '40', 'zubat': '41', 'golbat': '42',
                    'oddish': '43', 'gloom': '44', 'vileplume': '45',
                    'paras': '46', 'parasect': '47', 'venonat': '48',
                    'venomoth': '49', 'diglett': '50', 'dugtrio': '51',
                    'meowth': '52', 'persian': '53', 'psyduck': '54',
                    'golduck': '55', 'mankey': '56', 'primeape': '57',
                    'growlithe': '58', 'arcanine': '59', 'poliwag': '60',
                    'poliwhirl': '61', 'poliwrath': '62', 'abra': '63',
                    'kadabra': '64', 'alakazam': '65', 'machop': '66',
                    'machoke': '67', 'machamp': '68', 'bellsprout': '69',
                    'weepinbell': '70', 'victreebel': '71', 'tentacool': '72',
                    'tentacruel': '73', 'geodude': '74', 'graveler': '75',
                    'golem': '76', 'ponyta': '77', 'rapidash': '78',
                    'slowpoke': '79', 'slowbro': '80', 'magnemite': '81',
                    'magneton': '82', 'farfetchd': '83', 'doduo': '84',
                    'dodrio': '85', 'seel': '86', 'dewgong': '87',
                    'grimer': '88', 'muk': '89', 'shellder': '90',
                    'cloyster': '91', 'gastly': '92', 'haunter': '93',
                    'gengar': '94', 'onix': '95', 'drowzee': '96',
                    'hypno': '97', 'krabby': '98', 'kingler': '99',
                    'voltorb': '100', 'electrode': '101', 'exeggcute': '102',
                    'exeggutor': '103', 'cubone': '104', 'marowak': '105',
                    'hitmonlee': '106', 'hitmonchan': '107', 'lickitung': '108',
                    'koffing': '109', 'weezing': '110', 'rhyhorn': '111',
                    'rhydon': '112', 'chansey': '113', 'tangela': '114',
                    'kangaskhan': '115', 'horsea': '116', 'seadra': '117',
                    'goldeen': '118', 'seaking': '119', 'staryu': '120',
                    'starmie': '121', 'mr-mime': '122', 'scyther': '123',
                    'jynx': '124', 'electabuzz': '125', 'magmar': '126',
                    'pinsir': '127', 'tauros': '128', 'magikarp': '129',
                    'gyarados': '130', 'lapras': '131', 'ditto': '132',
                    'eevee': '133', 'vaporeon': '134', 'jolteon': '135',
                    'flareon': '136', 'porygon': '137', 'omanyte': '138',
                    'omastar': '139', 'kabuto': '140', 'kabutops': '141',
                    'aerodactyl': '142', 'snorlax': '143', 'articuno': '144',
                    'zapdos': '145', 'moltres': '146', 'dratini': '147',
                    'dragonair': '148', 'dragonite': '149', 'mewtwo': '150',
                    'mew': '151'
                };
                
                const normalizedName = pokemonName.toLowerCase().replace(/[^a-z0-9]/g, '');
                return pokemonMap[normalizedName] || '1'; // Default to Bulbasaur if not found
            }
            
            async init() {
                console.log('üéÆ Initializing Battle Result...', this.battleId);
                
                if (!this.battleId) {
                    this.showError('No battle ID provided');
                    return;
                }
                
                await this.loadBattleResult();
            }
            
            async loadBattleResult() {
                try {
                    console.log('üîÑ Loading battle result...', this.battleId);
                    
                    // Check authentication first
                    const isAuthenticated = await AuthService.checkAuth();
                    if (!isAuthenticated) {
                        this.showError('Please log in to view battle results');
                        return;
                    }
                    
                    // Debug authentication data
                    const authUser = AuthService.getCurrentUser();
                    console.log('üîê BATTLE-RESULT: Auth debug:', {
                        isAuthenticated: isAuthenticated,
                        hasAuthUser: !!authUser,
                        authUserKeys: authUser ? Object.keys(authUser) : [],
                        hasToken: !!(authUser?.token || authUser?.accessToken),
                        tokenStart: (authUser?.token || authUser?.accessToken)?.substring(0, 20),
                        email: authUser?.email,
                        sessionData: sessionStorage.getItem('pokemonGame_user')
                    });
                    
                    // Load battle data
                    this.battleData = await BattleChallengeService.getBattleById(this.battleId);
                    console.log('üìä Battle data loaded:', this.battleData);
                    
                    // Load replay data if available
                    if (this.battleData.pokemon_battleresultjson) {
                        try {
                            this.replayData = JSON.parse(this.battleData.pokemon_battleresultjson);
                            console.log('üé¨ Replay data loaded:', this.replayData);
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Could not parse replay data:', e);
                        }
                    }
                    
                    this.renderBattleResult();
                    
                } catch (error) {
                    console.error('‚ùå Error loading battle result:', error);
                    this.showError(`Failed to load battle result: ${error.message}`);
                }
            }
            
            renderBattleResult() {
                console.log('üé® Rendering battle result...');
                console.log('üîç Battle data:', this.battleData);
                console.log('üîç Replay data:', this.replayData);
                
                // Hide loading, show content
                document.getElementById('loading').style.display = 'none';
                document.getElementById('result-content').style.display = 'block';
                
                // Render compact Pokemon cards for the replay
                this.renderCompactPokemonCards();
                
                // Check replay data availability with detailed logging
                console.log('üé¨ Checking replay data...');
                console.log('üé¨ Has replayData:', !!this.replayData);
                console.log('üé¨ Has battle_turns:', !!this.replayData?.battle_turns);
                console.log('üé¨ Battle turns length:', this.replayData?.battle_turns?.length);
                
                // Auto-start replay if available
                if (this.replayData && this.replayData.battle_turns && this.replayData.battle_turns.length > 0) {
                    console.log('üé¨ Auto-starting battle replay...');
                    this.showReplay(); // Use showReplay() to properly initialize
                } else {
                    console.log('üìù No replay data available');
                    console.log('üìù Checking for battleresultjson field...');
                    if (this.battleData.pokemon_battleresultjson) {
                        console.log('üìù Found battleresultjson, but parsing may have failed');
                        console.log('üìù Raw JSON length:', this.battleData.pokemon_battleresultjson.length);
                    } else {
                        console.log('üìù No pokemon_battleresultjson field found');
                    }
                    
                    // Show basic message
                    document.getElementById('replay-display').innerHTML = `
                        <div class="replay-step">
                            <div class="battle-start-info">
                                <h4>üé¨ No detailed replay available</h4>
                                <p>This battle was completed but detailed turn data is not available.</p>
                            </div>
                        </div>
                    `;
                }
                
                // Prepare winner announcement but keep it hidden initially
                this.renderWinnerAnnouncement();
            }
            
            renderCompactPokemonCards() {
                console.log('üéÆ Rendering compact Pokemon cards for replay...');
                
                // Check if replay data exists
                if (!this.replayData || !this.replayData.pokemon_teams) {
                    console.error('‚ùå No replay data or pokemon_teams available');
                    return;
                }
                
                // Get actual Pokemon data from replay (with correct HP values)
                const player1Data = this.replayData.pokemon_teams.player1_team?.[0];
                const player2Data = this.replayData.pokemon_teams.player2_team?.[0];
                const player1Name = this.battleData.pokemon_Player1?.firstname || 'Player 1';
                const player2Name = this.battleData.pokemon_Player2?.firstname || 'Player 2';
                
                console.log('üéÆ Player 1 Pokemon data:', player1Data);
                console.log('üéÆ Player 2 Pokemon data:', player2Data);
                console.log('üîç Player 1 HP details:', { hp: player1Data?.hp, max_hp: player1Data?.max_hp, final_hp: player1Data?.final_hp });
                console.log('üîç Player 2 HP details:', { hp: player2Data?.hp, max_hp: player2Data?.max_hp, final_hp: player2Data?.final_hp });
                console.log('üîç Full player1Data keys:', player1Data ? Object.keys(player1Data) : 'none');
                console.log('üîç Full player2Data keys:', player2Data ? Object.keys(player2Data) : 'none');
                
                // Check if Pokemon data exists
                if (!player1Data || !player2Data) {
                    console.error('‚ùå Missing Pokemon data in teams');
                    console.log('üîç Full replay data structure:', this.replayData);
                    return;
                }
                
                // Log all available HP-related fields to understand the data structure
                console.log('üîç Available HP fields in player1Data:', Object.keys(player1Data).filter(key => key.toLowerCase().includes('hp')));
                console.log('üîç Available HP fields in player2Data:', Object.keys(player2Data).filter(key => key.toLowerCase().includes('hp')));
                
                // Log the exact HP values that should be used (no fallbacks)
                console.log('üè• Player 1 HP field analysis:', {
                    hp: player1Data.hp,
                    max_hp: player1Data.max_hp,
                    final_hp: player1Data.final_hp
                });
                console.log('üè• Player 2 HP field analysis:', {
                    hp: player2Data.hp,
                    max_hp: player2Data.max_hp,
                    final_hp: player2Data.final_hp
                });
                
                // Also check if there's HP data in final_result section
                if (this.replayData.final_result) {
                    console.log('üîç Final result HP data:', {
                        player1_starting_hp: this.replayData.final_result.player1_starting_hp,
                        player2_starting_hp: this.replayData.final_result.player2_starting_hp,
                        player1_max_hp: this.replayData.final_result.player1_max_hp,
                        player2_max_hp: this.replayData.final_result.player2_max_hp,
                        player1_final_hp: this.replayData.final_result.player1_final_hp,
                        player2_final_hp: this.replayData.final_result.player2_final_hp
                    });
                }
                
                // Get HP values - use the starting HP values stored in final_result (most accurate)
                let player1HP, player2HP, player1MaxHP, player2MaxHP;
                
                // Use starting HP from final_result (these are the HP values when battle started)
                if (this.replayData.final_result?.player1_starting_hp !== undefined && 
                    this.replayData.final_result?.player1_max_hp !== undefined) {
                    player1HP = this.replayData.final_result.player1_starting_hp;
                    player1MaxHP = this.replayData.final_result.player1_max_hp;
                    console.log('‚úÖ Using final_result starting HP for Player 1:', `${player1HP}/${player1MaxHP}`);
                } else {
                    console.error('‚ùå No starting HP data found in final_result for Player 1');
                    return;
                }
                
                if (this.replayData.final_result?.player2_starting_hp !== undefined && 
                    this.replayData.final_result?.player2_max_hp !== undefined) {
                    player2HP = this.replayData.final_result.player2_starting_hp;
                    player2MaxHP = this.replayData.final_result.player2_max_hp;
                    console.log('‚úÖ Using final_result starting HP for Player 2:', `${player2HP}/${player2MaxHP}`);
                } else {
                    console.error('‚ùå No starting HP data found in final_result for Player 2');
                    return;
                }
                
                console.log('üè• Final HP values:', { 
                    p1: `${player1HP}/${player1MaxHP}`, 
                    p2: `${player2HP}/${player2MaxHP}` 
                });
                
                // Calculate HP percentages
                const p1HPPercent = Math.max(0, (player1HP / player1MaxHP) * 100);
                const p2HPPercent = Math.max(0, (player2HP / player2MaxHP) * 100);
                
                // Render Player 1 compact card
                document.getElementById('player1-compact').innerHTML = `
                    <div class="compact-pokemon-sprite-container">
                        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${this.getPokemonSpriteId(player1Data?.name)}.png" 
                             alt="${player1Data?.name}" 
                             class="compact-pokemon-sprite" 
                             onerror="this.src='assets/pokeball.svg'">
                    </div>
                    <div class="compact-pokemon-name">${player1Data?.name || 'Unknown'}</div>
                    <div class="compact-trainer-name">üîµ ${player1Name}</div>
                    <div class="compact-hp-bar">
                        <div class="compact-hp-fill ${p1HPPercent > 60 ? 'hp-high' : p1HPPercent > 30 ? 'hp-medium' : 'hp-low'}" 
                             style="width: ${p1HPPercent}%" id="player1-hp-bar"></div>
                    </div>
                    <div class="compact-hp-text" id="player1-hp-text">${player1HP}/${player1MaxHP}</div>
                `;
                
                // Add player1 class
                document.getElementById('player1-compact').classList.add('player1');
                
                // Render Player 2 compact card
                document.getElementById('player2-compact').innerHTML = `
                    <div class="compact-pokemon-sprite-container">
                        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${this.getPokemonSpriteId(player2Data?.name)}.png" 
                             alt="${player2Data?.name}" 
                             class="compact-pokemon-sprite" 
                             onerror="this.src='assets/pokeball.svg'">
                    </div>
                    <div class="compact-pokemon-name">${player2Data?.name || 'Unknown'}</div>
                    <div class="compact-trainer-name">üî¥ ${player2Name}</div>
                    <div class="compact-hp-bar">
                        <div class="compact-hp-fill ${p2HPPercent > 60 ? 'hp-high' : p2HPPercent > 30 ? 'hp-medium' : 'hp-low'}" 
                             style="width: ${p2HPPercent}%" id="player2-hp-bar"></div>
                    </div>
                    <div class="compact-hp-text" id="player2-hp-text">${player2HP}/${player2MaxHP}</div>
                `;
                
                // Add player2 class
                document.getElementById('player2-compact').classList.add('player2');
            }
            
            updateCompactPokemonHP(player1HP, player1MaxHP, player2HP, player2MaxHP) {
                // Update Player 1 HP
                const p1HPPercent = Math.max(0, (player1HP / player1MaxHP) * 100);
                const p1Bar = document.getElementById('player1-hp-bar');
                const p1Text = document.getElementById('player1-hp-text');
                
                if (p1Bar && p1Text) {
                    p1Bar.style.width = `${p1HPPercent}%`;
                    p1Bar.className = `compact-hp-fill ${p1HPPercent > 60 ? 'hp-high' : p1HPPercent > 30 ? 'hp-medium' : 'hp-low'}`;
                    p1Text.textContent = `${player1HP}/${player1MaxHP}`;
                }
                
                // Update Player 2 HP
                const p2HPPercent = Math.max(0, (player2HP / player2MaxHP) * 100);
                const p2Bar = document.getElementById('player2-hp-bar');
                const p2Text = document.getElementById('player2-hp-text');
                
                if (p2Bar && p2Text) {
                    p2Bar.style.width = `${p2HPPercent}%`;
                    p2Bar.className = `compact-hp-fill ${p2HPPercent > 60 ? 'hp-high' : p2HPPercent > 30 ? 'hp-medium' : 'hp-low'}`;
                    p2Text.textContent = `${player2HP}/${player2MaxHP}`;
                }
            }
            
            renderWinnerAnnouncement() {
                const container = document.getElementById('winner-announcement');
                
                if (this.battleData.statuscode !== 895550001) { // Not completed
                    container.innerHTML = `
                        <div class="winner-content">
                            <div class="winner-icon"><img src="assets/pokeball.svg" alt="In Progress..." style="width: 48px; height: 48px; animation: spin 1s linear infinite;"></div>
                            <h2>Battle In Progress</h2>
                            <p>This battle has not been completed yet.</p>
                        </div>
                    `;
                    return;
                }
                
                // Determine winner
                let winnerName = 'Unknown';
                let winnerPokemon = 'Unknown Pokemon';
                
                if (this.replayData?.completeBattleData?.final_result) {
                    winnerName = this.replayData.completeBattleData.final_result.winner_name;
                } else if (this.replayData?.winner) {
                    winnerName = this.replayData.winner;
                } else {
                    // Fallback - try to determine from player data
                    winnerName = this.battleData.pokemon_Player1?.firstname || 'Player 1';
                }
                
                container.innerHTML = `
                    <div class="winner-content">
                        <div class="winner-icon">üèÜ</div>
                        <h2>${winnerName} Wins!</h2>
                        <p>Victory achieved in an epic Pokemon battle!</p>
                    </div>
                `;
            }
            
            renderPlayerCards() {
                const player1Card = document.getElementById('player1-card');
                const player2Card = document.getElementById('player2-card');
                
                // Get current Pokemon data from expanded Dataverse results
                const player1Name = this.battleData.pokemon_Player1?.firstname || 'Player 1';
                const player1Pokemon = this.battleData.pokemon_Player1Pokemon;
                
                const player2Name = this.battleData.pokemon_Player2?.firstname || 'AI Opponent';
                const player2Pokemon = this.battleData.pokemon_Player2Pokemon;
                
                console.log('üéÆ Player 1 Pokemon data:', player1Pokemon);
                console.log('üéÆ Player 2 Pokemon data:', player2Pokemon);
                
                // Use live Pokemon data for HP, levels, and names
                const player1HP = player1Pokemon?.pokemon_hp || 0;
                const player1MaxHP = player1Pokemon?.pokemon_hpmax || 100;
                const player1Level = player1Pokemon?.pokemon_level || 1;
                const player1PokemonName = player1Pokemon?.pokemon_Pokemon?.pokemon_name || player1Pokemon?.pokemon_name || 'Unknown Pokemon';
                const player1SpriteUrl = player1Pokemon?.pokemon_Pokemon?.pokemon_sprite_url;
                const player1PokemonId = player1Pokemon?.pokemon_Pokemon?.pokemon_id || 1;
                
                const player2HP = player2Pokemon?.pokemon_hp || 0;
                const player2MaxHP = player2Pokemon?.pokemon_hpmax || 100;
                const player2Level = player2Pokemon?.pokemon_level || 1;
                const player2PokemonName = player2Pokemon?.pokemon_Pokemon?.pokemon_name || player2Pokemon?.pokemon_name || 'Unknown Pokemon';
                const player2SpriteUrl = player2Pokemon?.pokemon_Pokemon?.pokemon_sprite_url;
                const player2PokemonId = player2Pokemon?.pokemon_Pokemon?.pokemon_id || 1;
                
                // Determine winner from replay data
                const winner = this.replayData?.final_result?.winner;
                const player1Won = winner === 'player1';
                const player2Won = winner === 'player2';
                
                player1Card.innerHTML = this.renderPlayerCard(
                    player1Name, player1PokemonName, player1Level,
                    player1HP, player1MaxHP, player1Won, player1SpriteUrl, player1PokemonId
                );
                
                player2Card.innerHTML = this.renderPlayerCard(
                    player2Name, player2PokemonName, player2Level,
                    player2HP, player2MaxHP, player2Won, player2SpriteUrl, player2PokemonId
                );
            }
            
            renderPlayerCard(playerName, pokemonName, level, currentHP, maxHP, isWinner, spriteUrl, pokemonId) {
                const hpPercentage = maxHP > 0 ? (currentHP / maxHP) * 100 : 0;
                const hpClass = hpPercentage > 60 ? 'hp-high' : hpPercentage > 30 ? 'hp-medium' : 'hp-low';
                
                // Use custom sprite URL if available, otherwise fallback to PokeAPI
                const pokemonSpriteUrl = spriteUrl || `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${pokemonId}.png`;
                
                return `
                    <div class="pokemon-info">
                        <div class="trainer-name">${playerName} ${isWinner ? 'üëë' : ''}</div>
                        <div class="pokemon-sprite-container">
                            <img src="${pokemonSpriteUrl}" alt="${pokemonName}" class="pokemon-sprite" loading="lazy">
                        </div>
                        <div class="pokemon-name">${pokemonName}</div>
                        <div class="pokemon-level">Level: ${level}</div>
                        <div class="pokemon-hp">
                            <div class="hp-label">HP: ${currentHP}/${maxHP}</div>
                            <div class="hp-bar">
                                <div class="hp-fill ${hpClass}" style="width: ${hpPercentage}%"></div>
                            </div>
                        </div>
                        ${isWinner ? '<div class="winner-badge">üèÜ Winner</div>' : ''}
                    </div>
                `;
            }
            
            renderBattleLog() {
                const container = document.getElementById('battle-log');
                
                if (!this.replayData || !this.replayData.battleLog) {
                    container.innerHTML = '<div class="log-entry">No battle log available</div>';
                    return;
                }
                
                const logEntries = this.replayData.battleLog.map(entry => 
                    `<div class="log-entry">${entry}</div>`
                ).join('');
                
                container.innerHTML = logEntries;
            }
            
            showError(message) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error-message').textContent = message;
            }
            
            showReplay() {
                if (!this.replayData) {
                    alert('No replay data available for this battle');
                    return;
                }
                
                this.isReplayVisible = true;
                this.currentStep = 0;
                document.getElementById('battle-replay').style.display = 'block';
                this.renderReplay();
                
                // Scroll to replay
                document.getElementById('battle-replay').scrollIntoView({ behavior: 'smooth' });
            }
            
            renderReplay() {
                if (!this.replayData || !this.isReplayVisible) return;
                
                const container = document.getElementById('replay-display');
                
                // Check if we have the new complex battle data structure
                if (this.replayData.battle_turns && this.replayData.battle_turns.length > 0) {
                    this.renderComplexReplay(container);
                } else {
                    // Fallback for simple battle data
                    container.innerHTML = `
                        <div>
                            <h5>Battle Result</h5>
                            <p>Winner: ${this.replayData.winner || 'Unknown'}</p>
                            ${this.replayData.battleLog ? 
                                `<div class="battle-log">
                                    ${this.replayData.battleLog.map(log => `<div class="log-entry">${log}</div>`).join('')}
                                </div>` : 
                                '<p>No detailed battle log available</p>'
                            }
                        </div>
                    `;
                    
                    // Hide controls for simple format
                    document.querySelector('.replay-controls').style.display = 'none';
                }
            }
            
            renderComplexReplay(container) {
                const battleTurns = this.replayData.battle_turns;
                const totalTurns = battleTurns.length;
                const currentTurn = this.currentStep;
                const currentTurnData = currentTurn > 0 && currentTurn <= totalTurns ? battleTurns[currentTurn - 1] : null;
                
                // Update controls
                const turnIndicatorText = currentTurn > totalTurns ? 'Final' : `Turn ${currentTurn}/${totalTurns}`;
                document.getElementById('turn-indicator').textContent = turnIndicatorText;
                
                // Only update button states if they exist (they're not present on battle start/end screens)
                const prevBtn = document.getElementById('prev-btn');
                const nextBtn = document.getElementById('next-btn');
                if (prevBtn) prevBtn.disabled = currentTurn <= 0;
                if (nextBtn) nextBtn.disabled = currentTurn >= totalTurns;
                
                // Get Pokemon data
                const player1Pokemon = this.replayData.pokemon_teams.player1_team[0];
                const player2Pokemon = this.replayData.pokemon_teams.player2_team[0];
                
                // Get current HP based on turn - use final_result for accurate starting HP values
                const getStartingHP = (pokemon) => {
                    // Get starting HP from final_result (stored when battle started)
                    if (pokemon === player1Pokemon) {
                        return this.replayData.final_result.player1_starting_hp;
                    }
                    if (pokemon === player2Pokemon) {
                        return this.replayData.final_result.player2_starting_hp;
                    }
                    // Should not happen, but return undefined to catch errors
                    return undefined;
                };
                
                const player1HP = currentTurn === 0 ? getStartingHP(player1Pokemon) : 
                                 currentTurn > totalTurns ? this.replayData.final_result.player1_final_hp :
                                 currentTurnData ? currentTurnData.turn_result.player1_pokemon_hp : getStartingHP(player1Pokemon);
                const player2HP = currentTurn === 0 ? getStartingHP(player2Pokemon) : 
                                 currentTurn > totalTurns ? this.replayData.final_result.player2_final_hp :
                                 currentTurnData ? currentTurnData.turn_result.player2_pokemon_hp : getStartingHP(player2Pokemon);
                
                // Update the compact Pokemon HP bars at the top
                this.updateCompactPokemonHP(player1HP, player1Pokemon.max_hp, player2HP, player2Pokemon.max_hp);
                
                let content = '';
                
                // Show current step content
                if (currentTurn === 0) {
                    // Battle start
                    content = `
                        <div class="replay-step">
                            <div class="turn-header">
                                <button class="pokemon-btn btn-outline" onclick="previousStep()" id="prev-btn">‚Üê Back</button>
                                <div class="turn-number">‚öîÔ∏è Battle Start</div>
                                <button class="pokemon-btn btn-outline" onclick="nextStep()" id="next-btn">Next ‚Üí</button>
                            </div>
                            <div class="battle-start-info">
                                <h4>ü•ä ${this.replayData.metadata.player1_name} vs ${this.replayData.metadata.player2_name}</h4>
                                <p>Both trainers send out their Pokemon and prepare for battle!</p>
                                <div class="pokemon-intro">
                                    <div>üîµ ${player1Pokemon.name} (Level ${player1Pokemon.level || 5}) - ${player1HP}/${player1Pokemon.max_hp} HP</div>
                                    <div>üî¥ ${player2Pokemon.name} (Level ${player2Pokemon.level || 5}) - ${player2HP}/${player2Pokemon.max_hp} HP</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (currentTurn > totalTurns) {
                    // Battle end
                    content = `
                        <div class="replay-step">
                            <div class="turn-header">
                                <button class="pokemon-btn btn-outline" onclick="previousStep()" id="prev-btn">‚Üê Back</button>
                                <div class="turn-number">üèÜ Victory!</div>
                                <!-- No next button on victory screen -->
                            </div>
                            <div class="battle-end-info">
                                <h4>${this.replayData.final_result.winner_name} Wins!</h4>
                                <p>${this.replayData.final_result.battle_summary}</p>
                                <div class="victory-reason" style="margin-top: 8px; margin-bottom: 12px; padding: 8px; background: rgba(34,197,94,0.15); border-radius: 8px; font-weight: bold; color: #22c55e; text-align: center;">
                                    ${(() => {
                                        const isPlayer1Winner = this.replayData.final_result.winner === 'player1';
                                        const p1HP = this.replayData.final_result.player1_final_hp || 0;
                                        const p2HP = this.replayData.final_result.player2_final_hp || 0;
                                        const p1Damage = this.replayData.final_result.final_scores?.player1_total_damage_dealt || 0;
                                        const p2Damage = this.replayData.final_result.final_scores?.player2_total_damage_dealt || 0;
                                        
                                        if (this.replayData.final_result.victory_condition === 'timeout') {
                                            if (p1HP !== p2HP) {
                                                return `üèÜ Won by having more HP remaining (${isPlayer1Winner ? p1HP : p2HP} vs ${isPlayer1Winner ? p2HP : p1HP})`;
                                            } else if (p1Damage !== p2Damage) {
                                                return `üèÜ Won by dealing more total damage (${isPlayer1Winner ? p1Damage : p2Damage} vs ${isPlayer1Winner ? p2Damage : p1Damage})`;
                                            } else {
                                                return `üèÜ Won by higher level Pokemon (tiebreaker)`;
                                            }
                                        } else {
                                            return `üèÜ Won by defeating opponent's Pokemon`;
                                        }
                                    })()}
                                </div>
                                <div class="victory-details">
                                    <div>üéØ ${this.replayData.final_result.victory_condition === 'timeout' ? `Turn limit (${totalTurns} turns) was reached` : this.replayData.final_result.victory_condition === 'all_pokemon_fainted' ? 'Pokemon fainted' : this.replayData.final_result.victory_condition}</div>
                                    <div>üí• ${player1Pokemon.name}: ${this.replayData.final_result.final_scores?.player1_total_damage_dealt || 0} damage dealt</div>
                                    <div>üí• ${player2Pokemon.name}: ${this.replayData.final_result.final_scores?.player2_total_damage_dealt || 0} damage dealt</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Show current turn
                    const turn = currentTurnData;
                    const isLastTurn = currentTurn === totalTurns;
                    content = `
                        <div class="replay-step">
                            <div class="turn-header">
                                <button class="pokemon-btn btn-outline" onclick="previousStep()" id="prev-btn">‚Üê Back</button>
                                <div class="turn-number">Turn ${currentTurn}</div>
                                ${isLastTurn ? 
                                    '<button class="pokemon-btn btn-primary" onclick="battleResult.viewWinner()">ÔøΩ Show Winner</button>' :
                                    '<button class="pokemon-btn btn-outline" onclick="nextStep()" id="next-btn">Next ‚Üí</button>'
                                }
                            </div>
                            
                            <div class="action-cards">
                                <div class="action-card player1">
                                    <div class="action-header">üîµ ${this.replayData.metadata.player1_name}</div>
                                    <div class="action-details">
                                        <div><strong>${turn.player1_action.move_used || 'Attack'}</strong></div>
                                        <div>${turn.player1_action.action_description}</div>
                                        ${turn.player1_action.damage_dealt ? `<div class="damage-indicator">-${turn.player1_action.damage_dealt} HP</div>` : ''}
                                        ${turn.player1_action.critical_hit ? '<div class="critical-hit">Critical Hit!</div>' : ''}
                                        ${turn.player1_action.type_effectiveness !== 1.0 ? 
                                            `<div class="${turn.player1_action.type_effectiveness > 1.0 ? 'type-effective' : 'type-ineffective'}">
                                                ${turn.player1_action.type_effectiveness > 1.0 ? 'Super Effective!' : 
                                                  turn.player1_action.type_effectiveness < 1.0 ? 'Not Very Effective...' : ''}
                                            </div>` : ''}
                                    </div>
                                </div>
                                
                                <div class="action-card player2">
                                    <div class="action-header">üî¥ ${this.replayData.metadata.player2_name}</div>
                                    <div class="action-details">
                                        <div><strong>${turn.player2_action.move_used || 'Attack'}</strong></div>
                                        <div>${turn.player2_action.action_description}</div>
                                        ${turn.player2_action.damage_dealt ? `<div class="damage-indicator">-${turn.player2_action.damage_dealt} HP</div>` : ''}
                                        ${turn.player2_action.critical_hit ? '<div class="critical-hit">Critical Hit!</div>' : ''}
                                        ${turn.player2_action.type_effectiveness !== 1.0 ? 
                                            `<div class="${turn.player2_action.type_effectiveness > 1.0 ? 'type-effective' : 'type-ineffective'}">
                                                ${turn.player2_action.type_effectiveness > 1.0 ? 'Super Effective!' : 
                                                  turn.player2_action.type_effectiveness < 1.0 ? 'Not Very Effective...' : ''}
                                            </div>` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = content;
            }
            
            nextStep() {
                if (!this.replayData || !this.replayData.battle_turns) return;
                
                const maxSteps = this.replayData.battle_turns.length;
                if (this.currentStep < maxSteps) {
                    this.currentStep++;
                    this.renderReplay();
                }
            }
            
            previousStep() {
                if (this.currentStep > 0) {
                    this.currentStep--;
                    this.renderReplay();
                }
            }
            
            viewWinner() {
                // Move to the victory screen (one step beyond the last turn)
                const maxSteps = this.replayData.battle_turns.length;
                this.currentStep = maxSteps + 1;
                this.renderReplay();
            }
            
            toggleAutoReplay() {
                if (this.autoReplayInterval) {
                    // Stop auto replay
                    clearInterval(this.autoReplayInterval);
                    this.autoReplayInterval = null;
                } else {
                    // Start auto replay
                    this.autoReplayInterval = setInterval(() => {
                        if (!this.replayData || !this.replayData.battle_turns) {
                            this.toggleAutoReplay(); // Stop if no data
                            return;
                        }
                        
                        const maxSteps = this.replayData.battle_turns.length;
                        if (this.currentStep >= maxSteps) {
                            this.toggleAutoReplay(); // Stop at end
                            return;
                        }
                        
                        this.nextStep();
                    }, 2000); // 2 seconds per turn
                }
            }
            
            startAutoReplay() {
                console.log('üé¨ Starting auto-replay...');
                
                // Show notification
                const replayDisplay = document.getElementById('replay-display');
                const notification = document.createElement('div');
                notification.className = 'auto-replay-notification';
                notification.innerHTML = 'üé¨ Auto-replay starting... Enjoy the battle!';
                replayDisplay.insertBefore(notification, replayDisplay.firstChild);
                
                // Remove notification after 3 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 3000);
                
                // Start auto-replay
                if (!this.autoReplayInterval) {
                    this.toggleAutoReplay();
                }
            }
        }
        
        // Global functions for button clicks
        function showReplay() {
            battleResult.showReplay();
        }
        
        function nextStep() {
            battleResult.nextStep();
        }
        
        function previousStep() {
            battleResult.previousStep();
        }
        
        function viewWinner() {
            battleResult.viewWinner();
        }
        
        function toggleAutoReplay() {
            battleResult.toggleAutoReplay();
        }
        
        // Initialize when page loads
        let battleResult;
        document.addEventListener('DOMContentLoaded', function() {
            battleResult = new BattleResult();
        });
    </script>
</body>
</html>
