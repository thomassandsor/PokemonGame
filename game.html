<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Game - Universal HTML Version</title>
    <meta name="description" content="Pokemon Game - Optimized for all devices">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pokemon Game">
    <link rel="apple-touch-icon" href="/favicon.ico">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        h1 {
            text-align: center;
            font-size: 2em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .game-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        .game-section h3 {
            margin-top: 0;
            color: #ffd700;
        }
        .button {
            display: block;
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }
        .button:hover, .button:active {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }
        .button.secondary {
            background: #6c757d;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }
        .button.secondary:hover, .button.secondary:active {
            background: #545b62;
        }
        .button.success {
            background: #28a745;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        .button.success:hover, .button.success:active {
            background: #1e7e34;
        }
        .pokemon-display {
            display: flex;
            align-items: center;
            padding: 10px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        .pokemon-sprite {
            width: 60px;
            height: 60px;
            margin-right: 15px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
        }
        .pokemon-info {
            flex: 1;
        }
        .pokemon-name {
            font-weight: bold;
            font-size: 18px;
        }
        .pokemon-level {
            color: #ffd700;
            font-size: 14px;
        }
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 15px;
        }
        .user-info {
            font-size: 14px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
        }
        .error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #dc3545;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            color: #28a745;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            overflow: hidden;
        }
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            background: transparent;
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab.active {
            background: rgba(255, 255, 255, 0.2);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .pokemon-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .pokemon-card:hover {
            transform: translateY(-5px);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .pokemon-card.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
        }
        .battle-screen {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }
        .battle-arena {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
        }
        .pokemon-battle-info {
            text-align: center;
            flex: 1;
        }
        .vs-text {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .hp-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 5px 0;
        }
        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4757 0%, #ffa502 50%, #2ed573 100%);
            transition: width 0.5s ease;
        }
        .moves-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .move-button {
            padding: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .move-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        .qr-scanner {
            text-align: center;
            padding: 20px;
        }
        .qr-placeholder {
            width: 200px;
            height: 200px;
            background: rgba(0, 0, 0, 0.2);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            margin: 15px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        @media (max-width: 480px) {
            .container {
                margin: 0;
                padding: 15px;
                border-radius: 0;
            }
            .pokemon-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .battle-arena {
                flex-direction: column;
                gap: 20px;
            }
            .vs-text {
                transform: rotate(90deg);
                margin: 10px 0;
            }
        }
            color: #ffd700;
            font-size: 14px;
        }
        .status-bar {
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }
        .status-info {
            background: rgba(23, 162, 184, 0.2);
            border: 2px solid #17a2b8;
        }
        .status-success {
            background: rgba(40, 167, 69, 0.2);
            border: 2px solid #28a745;
        }
        .debug-section {
            margin-top: 30px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎮 Pokemon Game</h1>
        <div id="authStatus" class="status-bar status-success">
            ✅ Loading user information...
        </div>
        
        <div id="userSection" class="game-section" style="display: none;">
            <h3>👤 Welcome Back!</h3>
            <div id="userInfo">
                <div class="pokemon-display">
                    <div class="pokemon-sprite" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 24px;">👤</div>
                    <div class="pokemon-info">
                        <div class="pokemon-name" id="userName">Loading...</div>
                        <div class="pokemon-level" id="userEmail">Verifying email...</div>
                    </div>
                </div>
                <div class="pokemon-display">
                    <div class="pokemon-sprite" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); display: flex; align-items: center; justify-content: center; font-size: 24px;">📊</div>
                    <div class="pokemon-info">
                        <div class="pokemon-name">Game Progress</div>
                        <div class="pokemon-level" id="userStats">Level 0 • 0 Pokemon</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="game-section">
            <h3>🏠 Your Pokemon Collection</h3>
            <div id="pokemonList">
                <div class="pokemon-display">
                    <img class="pokemon-sprite" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png" alt="Pikachu">
                    <div class="pokemon-info">
                        <div class="pokemon-name">Pikachu</div>
                        <div class="pokemon-level">Level 15 • Electric</div>
                    </div>
                </div>
                <div class="pokemon-display">
                    <img class="pokemon-sprite" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1.png" alt="Bulbasaur">
                    <div class="pokemon-info">
                        <div class="pokemon-name">Bulbasaur</div>
                        <div class="pokemon-level">Level 12 • Grass/Poison</div>
                    </div>
                </div>
                <div class="pokemon-display">
                    <img class="pokemon-sprite" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png" alt="Charmander">
                    <div class="pokemon-info">
                        <div class="pokemon-name">Charmander</div>
                        <div class="pokemon-level">Level 10 • Fire</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="game-section">
            <h3>⚡ Game Actions</h3>
            <button class="button success" onclick="startBattle()">🥊 Start Battle</button>
            <button class="button" onclick="scanPokemon()">📱 Scan Pokemon QR</button>
            <button class="button" onclick="browsePokemon()">🔍 Browse Pokemon</button>
            <button class="button" onclick="evolutionLab()">🧬 Evolution Lab</button>
        </div>

        <div class="game-section">
            <h3>🛠️ Game Management</h3>
            <button class="button secondary" onclick="viewProfile()">👤 View Profile</button>
            <button class="button secondary" onclick="adminPanel()">⚙️ Admin Panel</button>
            <button class="button secondary" onclick="gameSettings()">🎛️ Settings</button>
        </div>

        <div class="game-section">
            <h3>🆘 Authentication & Troubleshooting</h3>
            <button class="button secondary" onclick="debugTools()">🔍 Debug Tools</button>
            <button class="button secondary" onclick="showLoginPage()">� Login Page</button>
            <button class="button secondary" onclick="logout()">🚪 Logout</button>
            <button class="button secondary" onclick="clearAllData()">🧹 Reset Everything</button>
        </div>

        <div class="debug-section">
            <h4>📊 System Status</h4>
            <div id="systemStatus">Loading...</div>
        </div>
    </div>

    <script>
        // Global user state
        let currentUser = null;
        let isAuthenticated = false;

        // Track page load
        console.log('Pokemon Game HTML Version loaded', window.location.href);

        function trackAction(action, details = {}) {
            console.log('[ACTION]', action, {
                ...details,
                timestamp: new Date().toISOString(),
                authenticated: isAuthenticated,
                userEmail: currentUser?.email || 'guest'
            });
        }

        // Check authentication status on page load
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/WhoAmI', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.authenticated) {
                        currentUser = data;
                        isAuthenticated = true;
                        updateUserInterface(data);
                        trackAction('User_Authenticated', { email: data.email });
                    } else {
                        showGuestMode();
                    }
                } else {
                    showGuestMode();
                }
            } catch (error) {
                console.log('Auth check failed:', error);
                showGuestMode();
            }
        }

        function updateUserInterface(userData) {
            // Update user section
            document.getElementById('userName').textContent = userData.name;
            document.getElementById('userEmail').textContent = userData.email;
            document.getElementById('userStats').textContent = `Level ${userData.level} • ${userData.pokemonCount} Pokemon`;
            document.getElementById('userSection').style.display = 'block';
            
            // Update auth status
            document.getElementById('authStatus').innerHTML = '✅ Authenticated via Social Login';
            document.getElementById('authStatus').className = 'status-bar status-success';
        }

        function showGuestMode() {
            // Check if we have OAuth parameters in URL
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const email = urlParams.get('email');
            const name = urlParams.get('name');
            const error = urlParams.get('error');

            if (error) {
                document.getElementById('authStatus').innerHTML = `❌ Login Error: ${error}`;
                document.getElementById('authStatus').className = 'status-bar error';
                trackAction('Authentication_Error', { error: error });
            } else if (token && email) {
                // OAuth redirect successful - clean URL and check auth again
                window.history.replaceState({}, document.title, window.location.pathname);
                checkAuthStatus();
                return;
            } else {
                // Guest mode
                document.getElementById('authStatus').innerHTML = '👤 Playing as Guest - <a href="/login.html" style="color: #ffd700;">Login for full features</a>';
                document.getElementById('authStatus').className = 'status-bar status-info';
                trackAction('Guest_Mode_Active');
            }
        }

        // Game Functions
        function startBattle() {
            trackAction('Start_Battle');
            if (isAuthenticated) {
                console.log('🥊 Redirecting to Battle Arena...');
                window.location.href = 'battle-arena.html';
            } else {
                // For guests, show info and redirect to login
                if (confirm('🥊 Battle System requires login for full features.\n\nWould you like to login now to access:\n• Your Pokemon team\n• Ranked battles\n• Experience tracking\n• Saved progress\n\nClick OK to login, Cancel to continue as guest.')) {
                    window.location.href = 'auth.html';
                } else {
                    // Allow guest access with limited features
                    window.location.href = 'battle-arena.html';
                }
            }
        }

        function scanPokemon() {
            trackAction('Scan_Pokemon');
            if (isAuthenticated) {
                console.log('📱 Redirecting to Pokemon Scanner...');
                window.location.href = 'catch-pokemon.html';
            } else {
                if (confirm('📱 QR Scanner works in guest mode, but Pokemon won\'t be saved.\n\nWould you like to login to save your catches?\n\nClick OK to login, Cancel to continue as guest.')) {
                    window.location.href = 'auth.html';
                } else {
                    window.location.href = 'catch-pokemon.html';
                }
            }
        }

        function browsePokemon() {
            trackAction('Browse_Pokemon');
            console.log('🔍 Redirecting to Pokemon Browser...');
            window.location.href = 'pokemon-browser.html';
        }

        function evolutionLab() {
            trackAction('Evolution_Lab');
            if (isAuthenticated) {
                console.log('🧬 Redirecting to My Pokemon...');
                window.location.href = 'my-pokemon.html';
            } else {
                if (confirm('🧬 Evolution Lab requires login to manage your Pokemon.\n\nWould you like to login now?\n\nClick OK to login, Cancel to browse Pokemon instead.')) {
                    window.location.href = 'auth.html';
                } else {
                    window.location.href = 'pokemon-browser.html';
                }
            }
        }

        function viewProfile() {
            trackAction('View_Profile');
            if (isAuthenticated) {
                alert(`👤 ${currentUser.name}'s Profile...\n\nYour game stats:\n• Email: ${currentUser.email}\n• Level: ${currentUser.level}\n• Pokemon Count: ${currentUser.pokemonCount}\n• Last Played: ${new Date(currentUser.lastPlayed).toLocaleDateString()}`);
            } else {
                alert('👤 Guest Profile...\n\nLogin to access:\n• Permanent profile\n• Game statistics\n• Achievement tracking\n• Friend connections');
            }
        }

        function adminPanel() {
            trackAction('Admin_Panel');
            if (isAuthenticated) {
                alert(`⚙️ Admin Panel - ${currentUser.email}...\n\nSeminar Management:\n• Verified attendee access\n• Real email confirmation\n• Progress tracking\n• Analytics dashboard`);
            } else {
                alert('⚙️ Admin Panel...\n\nLogin required for admin access\nSeminar leaders need verified identity');
            }
        }

        function gameSettings() {
            trackAction('Game_Settings');
            alert('🎛️ Game Settings...\n\nCustomize your experience:\n• Sound/music settings\n• Notification preferences\n• Display options\n• Privacy settings');
        }

        function debugTools() {
            trackAction('Debug_Tools');
            window.location.href = '/debug.html';
        }

        function showLoginPage() {
            trackAction('Show_Login_Page');
            window.location.href = '/login.html';
        }

        function logout() {
            trackAction('Logout');
            if (confirm('🚪 Logout and return to login page?')) {
                // Clear session
                document.cookie = 'pokemon_session=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                localStorage.removeItem('pokemon_user');
                sessionStorage.clear();
                
                // Redirect to login
                window.location.href = '/login.html';
            }
        }

        function clearAllData() {
            trackAction('Clear_All_Data');
            if (confirm('🚨 This will clear all your game data and logout.\n\nAre you sure?')) {
                // Clear everything
                document.cookie = 'pokemon_session=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                localStorage.clear();
                sessionStorage.clear();
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                alert('✅ All data cleared!');
                window.location.href = '/login.html';
            }
        }

        // System Status
        function updateSystemStatus() {
            const ua = navigator.userAgent;
            const isMobile = /iPhone|iPad|iPod|Android/i.test(ua);
            const isIOS = /iPhone|iPad|iPod/i.test(ua);
            const isSafari = /Safari/i.test(ua) && !/Chrome/i.test(ua);
            const isChrome = /Chrome/i.test(ua);

            document.getElementById('systemStatus').innerHTML = `
                <div>📱 Device: ${isMobile ? 'Mobile' : 'Desktop'} | ${isIOS ? 'iOS' : 'Other'}</div>
                <div>🌐 Browser: ${isChrome ? 'Chrome' : isSafari ? 'Safari' : 'Other'}</div>
                <div>🕒 Last Updated: ${new Date().toLocaleTimeString()}</div>
                <div>✅ HTML Version: Fully Functional</div>
                <div>🔐 Auth: ${isAuthenticated ? 'Social Login ✅' : 'Guest Mode 👤'}</div>
                ${isAuthenticated ? `<div>👤 User: ${currentUser?.email}</div>` : ''}
            `;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            updateSystemStatus();
            setInterval(updateSystemStatus, 30000); // Update every 30 seconds
        });
    </script>
</body>
</html>
